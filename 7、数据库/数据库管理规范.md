# 数据库管理规范

> 📅 最后更新：2026-01-11
> 📋 基于项目源码逆向分析生成

---

## 🗄️ 数据库架构

### 数据库选型

| 数据库 | 版本 | 用途 |
|--------|------|------|
| **MongoDB** | 4.4+ | 主数据库，存储业务数据 |
| **MySQL** | 5.7+ | 辅助数据库，存储关系型数据 |
| **Redis** | 6.0+ | 缓存、会话、队列 |

---

## 📡 连接信息

### 生产环境

```yaml
# MySQL (卡若私域)
host: 10.88.182.62
port: 3306
user: root
password: Vtka(agu)-1
database: cunkebao

# MySQL (腾讯云)
host: 56b4c23f6853c.gz.cdb.myqcloud.com
port: 14413
user: cdb_outerroot
password: Zhiqun1984
database: cunkebao

# MongoDB
host: localhost
port: 27017
database: cunkebao

# Redis
host: localhost
port: 6379
password: (无)
```

---

## 📊 MySQL 核心表结构

### 用户表 (users)

```sql
CREATE TABLE `users` (
  `id` int(11) UNSIGNED NOT NULL AUTO_INCREMENT,
  `username` varchar(50) NOT NULL COMMENT '用户名',
  `password` varchar(255) NOT NULL COMMENT '密码',
  `nickname` varchar(50) DEFAULT NULL COMMENT '昵称',
  `avatar` varchar(255) DEFAULT NULL COMMENT '头像',
  `phone` varchar(20) DEFAULT NULL COMMENT '手机号',
  `email` varchar(100) DEFAULT NULL COMMENT '邮箱',
  `status` tinyint(1) DEFAULT 1 COMMENT '状态:0禁用,1正常',
  `role_id` int(11) DEFAULT NULL COMMENT '角色ID',
  `created_at` datetime DEFAULT CURRENT_TIMESTAMP,
  `updated_at` datetime DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
  PRIMARY KEY (`id`),
  UNIQUE KEY `uk_username` (`username`),
  KEY `idx_phone` (`phone`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='用户表';
```

### 设备表 (devices)

```sql
CREATE TABLE `devices` (
  `id` int(11) UNSIGNED NOT NULL AUTO_INCREMENT,
  `name` varchar(100) NOT NULL COMMENT '设备名称',
  `device_id` varchar(100) NOT NULL COMMENT '设备唯一ID',
  `user_id` int(11) NOT NULL COMMENT '所属用户',
  `group_id` int(11) DEFAULT NULL COMMENT '设备分组',
  `status` tinyint(1) DEFAULT 1 COMMENT '状态:0禁用,1正常',
  `online_status` tinyint(1) DEFAULT 0 COMMENT '在线状态:0离线,1在线',
  `last_online_at` datetime DEFAULT NULL COMMENT '最后在线时间',
  `created_at` datetime DEFAULT CURRENT_TIMESTAMP,
  `updated_at` datetime DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
  PRIMARY KEY (`id`),
  UNIQUE KEY `uk_device_id` (`device_id`),
  KEY `idx_user_id` (`user_id`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='设备表';
```

### 微信账号表 (wechats)

```sql
CREATE TABLE `wechats` (
  `id` int(11) UNSIGNED NOT NULL AUTO_INCREMENT,
  `device_id` int(11) NOT NULL COMMENT '设备ID',
  `wxid` varchar(100) NOT NULL COMMENT '微信ID',
  `nickname` varchar(100) DEFAULT NULL COMMENT '昵称',
  `avatar` varchar(500) DEFAULT NULL COMMENT '头像',
  `phone` varchar(20) DEFAULT NULL COMMENT '手机号',
  `gender` tinyint(1) DEFAULT 0 COMMENT '性别:0未知,1男,2女',
  `country` varchar(50) DEFAULT NULL COMMENT '国家',
  `province` varchar(50) DEFAULT NULL COMMENT '省份',
  `city` varchar(50) DEFAULT NULL COMMENT '城市',
  `status` tinyint(1) DEFAULT 1 COMMENT '状态',
  `login_status` tinyint(1) DEFAULT 0 COMMENT '登录状态',
  `health_score` int(11) DEFAULT 100 COMMENT '健康分',
  `created_at` datetime DEFAULT CURRENT_TIMESTAMP,
  `updated_at` datetime DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
  PRIMARY KEY (`id`),
  UNIQUE KEY `uk_wxid` (`wxid`),
  KEY `idx_device_id` (`device_id`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='微信账号表';
```

### 流量池表 (traffic_pools)

```sql
CREATE TABLE `traffic_pools` (
  `id` int(11) UNSIGNED NOT NULL AUTO_INCREMENT,
  `name` varchar(100) NOT NULL COMMENT '流量池名称',
  `description` text COMMENT '描述',
  `user_id` int(11) NOT NULL COMMENT '创建用户',
  `type` tinyint(1) DEFAULT 1 COMMENT '类型',
  `status` tinyint(1) DEFAULT 1 COMMENT '状态',
  `created_at` datetime DEFAULT CURRENT_TIMESTAMP,
  `updated_at` datetime DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
  PRIMARY KEY (`id`),
  KEY `idx_user_id` (`user_id`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='流量池表';
```

### 流量标签表 (traffic_tags)

```sql
CREATE TABLE `traffic_tags` (
  `id` int(11) UNSIGNED NOT NULL AUTO_INCREMENT,
  `name` varchar(50) NOT NULL COMMENT '标签名称',
  `color` varchar(20) DEFAULT '#1890ff' COMMENT '标签颜色',
  `user_id` int(11) NOT NULL COMMENT '创建用户',
  `sort` int(11) DEFAULT 0 COMMENT '排序',
  `created_at` datetime DEFAULT CURRENT_TIMESTAMP,
  `updated_at` datetime DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
  PRIMARY KEY (`id`),
  KEY `idx_user_id` (`user_id`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='流量标签表';
```

---

## 📦 MongoDB 集合结构

### 微信好友集合 (wechat_friends)

```javascript
{
  _id: ObjectId,
  wechat_id: Number,           // 所属微信ID
  wxid: String,                // 好友微信ID
  nickname: String,            // 昵称
  remark: String,              // 备注
  avatar: String,              // 头像
  gender: Number,              // 性别
  country: String,             // 国家
  province: String,            // 省份
  city: String,                // 城市
  tags: [Number],              // 标签ID数组
  extend_fields: Object,       // 扩展字段
  source: String,              // 来源
  add_time: Date,              // 添加时间
  last_chat_time: Date,        // 最后聊天时间
  created_at: Date,
  updated_at: Date
}

// 索引
db.wechat_friends.createIndex({ wechat_id: 1 })
db.wechat_friends.createIndex({ wxid: 1 })
db.wechat_friends.createIndex({ wechat_id: 1, wxid: 1 }, { unique: true })
```

### 聊天消息集合 (wechat_messages)

```javascript
{
  _id: ObjectId,
  wechat_id: Number,           // 微信ID
  msg_id: String,              // 消息ID
  from_wxid: String,           // 发送者
  to_wxid: String,             // 接收者
  msg_type: Number,            // 消息类型
  content: String,             // 消息内容
  media_url: String,           // 媒体URL
  is_group: Boolean,           // 是否群消息
  chatroom_id: String,         // 群ID
  status: Number,              // 状态
  send_time: Date,             // 发送时间
  created_at: Date
}

// 索引
db.wechat_messages.createIndex({ wechat_id: 1, send_time: -1 })
db.wechat_messages.createIndex({ msg_id: 1 }, { unique: true })
db.wechat_messages.createIndex({ from_wxid: 1, to_wxid: 1 })
```

### 朋友圈集合 (wechat_moments)

```javascript
{
  _id: ObjectId,
  wechat_id: Number,           // 微信ID
  moment_id: String,           // 朋友圈ID
  wxid: String,                // 发布者
  content: String,             // 内容
  images: [String],            // 图片列表
  video: String,               // 视频URL
  location: Object,            // 位置信息
  like_count: Number,          // 点赞数
  comment_count: Number,       // 评论数
  publish_time: Date,          // 发布时间
  created_at: Date
}

// 索引
db.wechat_moments.createIndex({ wechat_id: 1, publish_time: -1 })
db.wechat_moments.createIndex({ moment_id: 1 }, { unique: true })
```

### 内容库集合 (content_library)

```javascript
{
  _id: ObjectId,
  user_id: Number,             // 用户ID
  title: String,               // 标题
  content: String,             // 内容
  type: Number,                // 类型:1文字,2图文,3视频
  category_id: Number,         // 分类ID
  images: [String],            // 图片列表
  video: String,               // 视频URL
  tags: [Number],              // 标签
  status: Number,              // 状态
  use_count: Number,           // 使用次数
  created_at: Date,
  updated_at: Date
}

// 索引
db.content_library.createIndex({ user_id: 1, category_id: 1 })
db.content_library.createIndex({ created_at: -1 })
```

---

## 📝 命名规范

### 表/集合命名

- 使用小写字母和下划线
- 使用复数形式
- 示例：`users`, `wechat_friends`, `traffic_pools`

### 字段命名

- 使用小写字母和下划线
- 主键统一使用 `id`
- 外键格式：`{表名单数}_id`
- 时间字段：`created_at`, `updated_at`, `deleted_at`

### 索引命名

- 主键索引：`pk_{表名}`
- 唯一索引：`uk_{字段名}`
- 普通索引：`idx_{字段名}`
- 组合索引：`idx_{字段1}_{字段2}`

---

## 🔄 数据迁移

### MongoDB 导入导出

```bash
# 导出
mongodump --db cunkebao --out /backup/mongo/

# 导入（完全覆盖）
mongorestore --db cunkebao --drop /backup/mongo/cunkebao/

# 导入（断点续传）
mongorestore --db cunkebao --resumeFrom=1695000000000 /backup/mongo/cunkebao/
```

### MySQL 导入导出

```bash
# 导出
mysqldump -h host -u user -p cunkebao > backup.sql

# 导入
mysql -h host -u user -p cunkebao < backup.sql
```

---

## 🛡️ 备份策略

### 自动备份

| 数据库 | 频率 | 保留时间 |
|--------|------|----------|
| MongoDB | 每日 | 30天 |
| MySQL | 每日 | 30天 |
| Redis | 每小时 | 7天 |

### 备份脚本

```bash
#!/bin/bash
# backup.sh

DATE=$(date +%Y%m%d)
BACKUP_DIR="/backup/$DATE"

mkdir -p $BACKUP_DIR

# MongoDB 备份
mongodump --db cunkebao --out $BACKUP_DIR/mongo/

# MySQL 备份
mysqldump -h 10.88.182.62 -u root -p'Vtka(agu)-1' cunkebao > $BACKUP_DIR/mysql.sql

# 删除30天前的备份
find /backup -type d -mtime +30 -exec rm -rf {} \;
```

---

## ⚠️ 注意事项

1. **连接池**：配置合适的连接池大小，避免连接泄露
2. **索引优化**：定期分析慢查询，优化索引
3. **数据安全**：敏感数据加密存储
4. **备份验证**：定期验证备份数据的完整性
5. **MongoDB**：大集合建议分片处理
6. **MySQL**：大表建议分区或归档历史数据
