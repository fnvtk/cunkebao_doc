# 外部系统API对接获客模块后端开发指南

## 1. 引言与目标

### 1.1. 模块定位
本模块旨在为外部系统（如合作伙伴、第三方平台、营销自动化工具等）提供一套标准、安全、高效的API接口，用于将潜在客户数据（线索）推送到存客宝系统中。通过此模块，可以实现自动化、程序化的外部数据源接入，丰富和扩展获客渠道。

### 外部系统API对接获客流程图

```mermaid
graph TD
    A[外部系统/合作伙伴] --> B{API调用 (HTTP POST)};
    B -- 请求头(Access Key/签名) --> C{存客宝API网关/接入层};
    C -- 认证/验签/限流 --> D{原始数据日志记录};
    D --> E[初步数据校验];
    E -- 校验成功 --> F[发送至消息队列 (异步处理)];
    E -- 校验失败 --> G[返回400 Bad Request/错误信息];
    F --> H{数据处理与转换服务 (消费MQ消息)};
    H -- 业务逻辑校验/去重/映射 --> I[存入内部线索/客户库];
    I --> J[通知相关业务模块/前端更新];
    H -- 处理失败 --> K[记录错误/告警];
```

### 1.2. 设计目标
- **标准化**：提供定义清晰、一致的API接口规范，降低对接难度。
- **安全性**：确保数据传输和接口访问的安全性，防止未授权访问和数据泄露。
- **可靠性**：保证数据接收的稳定性和准确性，具备一定的容错和重试机制。
- **可扩展性**：设计上应考虑未来可能的字段增加、数据格式调整等需求。
- **可监控性**：能够对API调用情况、数据接收情况进行记录和监控。

## 2. 核心概念

- **API密钥 (API Key)**: 用于认证外部系统身份的凭证，通常包含一个`Access Key ID`和`Secret Key`。
- **数据接入点 (Data Ingestion Endpoint)**: 外部系统推送数据的目标API接口。
- **原始数据日志 (Raw Data Log)**: 记录接收到的原始外部数据的日志，用于追溯和问题排查。
- **数据校验 (Data Validation)**: 对接收到的数据进行格式、类型、完整性等方面的校验。
- **数据转换/映射 (Data Transformation/Mapping)**: 将外部系统的数据结构转换为内部系统可识别的客户或线索模型。
- **异步处理 (Asynchronous Processing)**: 对于数据量较大或处理耗时较长的场景，采用异步方式处理，例如通过消息队列。
- **请求签名 (Request Signing)**: 为防止数据篡改和重放攻击，外部系统在调用API时需对请求进行签名。

## 3. 核心数据实体/模型 (Conceptual)

- **`ApiAccessConfiguration` (API访问配置)**
    - `partnerId` (合作伙伴/系统ID)
    - `accessKeyId` (访问密钥ID)
    - `secretKeyHash` (加密存储的密钥)
    - `allowedIpAddresses` (允许的IP白名单，可选)
    - `status` (启用/禁用)
    - `description` (描述)
    - `rateLimit` (频率限制配置，可选)

- **`ExternalRawDataLog` (外部原始数据日志)**
    - `logId` (日志ID)
    - `partnerId` (合作伙伴/系统ID)
    - `receivedTimestamp` (接收时间戳)
    - `requestHeaders` (请求头信息)
    - `requestBody` (原始请求体)
    - `validationStatus` (校验状态：成功/失败)
    - `processingStatus` (处理状态：待处理/处理中/成功/失败)
    - `errorMessage` (错误信息，如果处理失败)

- **（内部）`Lead` / `CustomerProspect` (线索/潜在客户)**
    - (根据实际业务定义的线索字段，如姓名、电话、邮箱、来源、意向产品等)

## 4. 功能模块划分

### 4.1. API密钥管理模块
- **功能**：
    - 创建、查看、更新、禁用API密钥。
    - 安全存储密钥信息。
    - 管理密钥的权限和范围（如果需要）。
- **主要接口 (Conceptual Admin API)**:
    - `POST /admin/api-keys` (创建密钥)
    - `GET /admin/api-keys/{keyId}` (查询密钥详情)
    - `PUT /admin/api-keys/{keyId}` (更新密钥状态或描述)

### 4.2. 数据接收与预处理模块
- **功能**：
    - 提供数据接收的API端点。
    - 验证请求签名和API密钥的有效性。
    - 记录原始请求数据。
    - 对接收的数据进行初步校验（如格式、必填项）。
- **主要接口 (Conceptual Public API)**:
    - `POST /public/v1/leads/ingest` (外部系统推送线索数据接口)

### 4.3. 数据处理与转换模块
- **功能**：
    - 对通过初步校验的数据进行详细业务校验。
    - 将外部数据模型映射到内部线索/客户模型。
    - 执行数据清洗、去重等操作。
    - 将处理后的数据存入业务数据库。
- **内部机制**：
    - 可通过消息队列与数据接收模块解耦，实现异步处理。

### 4.4. 日志与监控模块
- **功能**：
    - 记录API调用日志、数据处理日志、错误日志。
    - 提供监控指标，如API调用频率、成功率、失败率、数据处理延迟等。

## 5. API接口设计指导原则 (Conceptual)

### 5.1. 认证与授权
- **认证方式**：推荐使用基于HMAC（Hash-based Message Authentication Code）的请求签名机制。外部系统使用分配的`Secret Key`对请求的关键部分（如HTTP方法、URI、时间戳、请求体）进行签名，并将签名结果通过请求头传递。
    - 例如，自定义请求头 `X-Signature`。
    - 服务端用同样的`Secret Key`重新计算签名并比对。
- **API Key传递**：`Access Key ID`可通过请求头（如 `X-Access-Key-Id`）或请求参数传递。

### 5.2. 请求与响应
- **数据格式**：推荐使用JSON作为数据交换格式。
- **HTTP方法**：遵循RESTful原则，使用合适的HTTP动词（如`POST`用于创建资源）。
- **版本控制**：在API路径中包含版本号（如 `/v1/`）。
- **响应状态码**：
    - `200 OK` 或 `202 Accepted` (对于异步处理): 请求成功。
    - `400 Bad Request`: 请求参数错误、格式错误、校验失败。
    - `401 Unauthorized`: 认证失败（签名无效、API Key无效）。
    - `403 Forbidden`: 授权失败（API Key无权限）。
    - `429 Too Many Requests`: 超出频率限制。
    - `500 Internal Server Error`: 服务器内部错误。
- **响应体**：
    - 成功时，可返回处理结果或任务ID（对于异步处理）。
    - 失败时，应返回结构化的错误信息，包含错误码、错误描述。
      ```json
      {
        "errorCode": "INVALID_PARAMETER",
        "message": "Field \'email\' is not a valid email address."
      }
      ```

### 5.3. 数据模型 (线索数据示例)
```json
// POST /public/v1/leads/ingest 请求体示例
{
  "externalLeadId": "XYZ-12345", // 外部系统线索ID，用于幂等性或追踪
  "sourceSystem": "PartnerPlatformA",
  "timestamp": "2023-10-27T10:30:00Z",
  "leadData": {
    "name": "张三",
    "phone": "13800138000",
    "email": "zhangsan@example.com",
    "company": "某某公司",
    "city": "厦门",
    "productInterest": ["ProductA", "ServiceB"],
    "notes": "通过市场活动A获取的线索",
    "customFields": {
      "utm_source": "campaign_xyz"
    }
  }
}
```

## 6. 主要业务流程示例

### 6.1. 外部系统推送线索
1. **外部系统**：准备待推送的线索数据。
2. **外部系统**：根据约定的签名算法，使用`Secret Key`对请求内容（或其摘要）进行签名。
3. **外部系统**：构造HTTP POST请求，目标为数据接入点 (e.g., `/public/v1/leads/ingest`)。
    - 请求头中包含 `Access Key ID` 和计算出的签名。
    - 请求体为JSON格式的线索数据。
4. **本模块 (API网关/接入层)**：接收请求。
5. **本模块**：
    - 提取 `Access Key ID`。
    - 根据 `Access Key ID` 查询对应的 `Secret Key`。
    - 验证请求时间戳的有效性（防止重放攻击）。
    - 使用同样的算法重新计算签名，与请求中的签名进行比对。
    - **若签名无效或API Key无效**：返回 `401 Unauthorized`。
6. **本模块 (数据接收与预处理)**：
    - 记录原始请求到 `ExternalRawDataLog`。
    - 对请求体JSON进行基本格式校验和必填项校验。
    - **若校验失败**：更新日志状态，返回 `400 Bad Request` 及错误详情。
7. **本模块**：
    - **同步处理方式**：直接调用数据处理与转换模块。
    - **异步处理方式**：将原始数据（或其引用）发送到消息队列，返回 `202 Accepted` 给外部系统。
8. **本模块 (数据处理与转换，可能异步)**：
    - 从消息队列消费数据（异步时）。
    - 进行详细业务校验、数据清洗、去重、转换。
    - 将数据保存到核心业务系统的线索库。
    - 更新 `ExternalRawDataLog` 中的处理状态和结果。

## 7. 技术考量与开发注意事项

- **幂等性设计**：对于数据创建类接口，需要考虑幂等性。外部系统可能会因为网络问题重试请求。可以通过要求外部系统传递唯一的请求ID或业务ID (`externalLeadId`) 来实现。
- **安全性**：
    - `Secret Key`绝不能在客户端或不安全信道中暴露。
    - 定期审计和更换API密钥。
    - 对输入数据进行严格的清理和验证，防止注入攻击（如SQL注入、XSS）。
    - 考虑对敏感数据在传输和存储时进行加密。
- **日志与监控**：完善的日志记录对于问题排查和审计至关重要。监控API的性能指标和错误率，以便及时发现和处理问题。
- **错误处理**：提供清晰、具体的错误信息给API调用方。
- **文档**：提供详细、准确的API文档给外部开发者，包括认证方式、请求/响应格式、数据模型、错误码等。
- **可测试性**：模块应易于测试，包括单元测试、集成测试和端到端测试。可以提供一个沙箱环境供外部系统测试对接。

## 8. 数据校验与错误处理

### 8.1. 数据校验层级
- **网关/接入层校验**：认证信息校验、签名校验、请求频率限制。
- **基础格式校验**：JSON格式、必填字段、数据类型、长度限制。
- **业务逻辑校验**：枚举值有效性、关联数据存在性、业务规则符合性。

### 8.2. 错误响应规范
- 使用标准的HTTP状态码。
- 响应体中包含 `errorCode` (内部定义的错误码) 和 `message` (可读的错误描述)。
- 可选地包含 `details` 字段，提供更详细的错误信息（例如，哪个字段校验失败及其原因）。

## 9. 安全性考量

- **传输安全**：所有API接口必须使用HTTPS。
- **认证安全**：
    - 签名机制防止请求被篡改。
    - API Key不应硬编码在客户端代码中，应由后端安全管理。
- **访问控制**：
    - IP白名单机制增强安全性。
    - 考虑API Key的权限范围，遵循最小权限原则。
- **数据安全**：
    - 对用户敏感数据（如手机号、邮箱）进行脱敏处理（如果需要在日志或非核心系统中展示）。
    - 防止数据泄露。
- **防攻击**：
    - 输入验证，防止SQL注入、XSS等。
    - 请求频率限制，防止DoS/DDoS攻击。
    - 时间戳校验，防止重放攻击。
- **审计**：记录所有API调用和关键操作，便于安全审计。

## 10. 演进与扩展

- **版本迭代**：通过API版本号管理接口的演进，确保向后兼容性。
- **数据格式扩展**：设计时考虑未来可能增加的字段，例如使用 `customFields` 结构允许外部系统传递自定义数据。
- **回调机制/Webhook**：对于长时间处理的异步任务，可以考虑引入Webhook机制，当数据处理完成后主动通知外部系统。

## 相关前端UI图片

以下是与外部系统API对接获客模块可能相关的部分前端UI截图，帮助理解API获客功能在前端的体现：

### 场景获客 - API获客入口示例 (示意图)

![场景获客](4、前端/UI/场景获客.png) 