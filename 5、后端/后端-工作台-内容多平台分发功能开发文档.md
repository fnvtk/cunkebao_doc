# 存客宝工作台 - 内容多平台分发功能后端开发文档\n\n## 1. 模块概述\n\n内容多平台分发功能允许用户在存客宝工作台创建或编辑内容（如文章、图片、短视频等），并通过系统集成将内容一键分发到多个外部社交媒体或内容平台（如微信公众号、微博、抖音、小红书等）。后端模块负责内容管理、平台对接、分发任务调度、状态跟踪及回传。\n\n## 2. API接口设计\n\n### 2.1 创建待分发内容\n\n- **接口路径**：`/api/v1/workbench/content`\n- **请求方法**：`POST`\n- **接口说明**：创建一篇待分发的内容草稿。内容可以包含标题、正文、图片、视频等多种形式。\n- **权限:** `workbench:content:create`\n- **请求参数 (Request Body):**\n\n| 参数名   | 类型    | 是否必需 | 描述           | 示例值 |
|----------|--------|----------|----------------|--------|\
| title    | string | 是       | 内容标题       | \"我的营销干货分享\" |\
| contentType| string | 是       | 内容类型 (ARTICLE, IMAGE, VIDEO) | \"ARTICLE\" |\
| content  | object | 是       | 内容详情，具体结构根据contentType不同 | `{ \"body\": \"文章正文...\", \"images\": [\"url1\", \"url2\"] }` |\
| tags     | array<string> | 否 | 内容标签       | `[\"营销\", \"私域\"]` |\
| category | string | 否       | 内容分类       | \"行业分析\" |\
\n- **响应数据 (统一格式 `data` 字段):** 返回新创建的内容草稿信息。\n\n```json\n{\n  \"contentId\": 4001,\n  \"title\": \"我的营销干货分享\",\n  \"status\": \"DRAFT\", // DRAFT, READY, DISTRIBUTING, DISTRIBUTED, FAILED\n  \"createTime\": \"2023-10-26T15:00:00Z\"\n}\n```\n- **可能返回状态码:** 201 (创建成功), 400 (参数错误), 401, 403, 422, 500\n\n### 2.2 获取内容列表\n\n- **接口路径**：`/api/v1/workbench/content`\n- **请求方法**：`GET`\n- **接口说明**：获取用户创建的内容列表。支持分页、筛选和排序。\n- **权限:** `workbench:content:view`\n- **请求参数 (Query Parameters):**\n\n| 参数名   | 类型    | 是否必需 | 描述           | 示例值 |
|----------|--------|----------|----------------|--------|\
| status   | string | 否       | 按状态过滤     | \"DRAFT\" |\
| keyword  | string | 否       | 按标题或标签关键字搜索 | \"干货\" |\
| startTime| string | 否       | 创建时间开始 (ISO 8601) |        |\
| endTime  | string | 否       | 创建时间结束 (ISO 8601) |        |\
| page     | integer| 否       | 页码           | 1      |\
| size     | integer| 否       | 每页条数       | 10     |\n\n- **响应数据 (统一格式 `data` 字段):** 返回内容列表（支持分页）。\n\n```json\n{\n  \"records\": [\n    {\n      \"contentId\": 4001,\n      \"title\": \"我的营销干货分享\",\n      \"contentType\": \"ARTICLE\",\n      \"status\": \"DRAFT\",\n      \"createTime\": \"2023-10-26T15:00:00Z\",\n      \"updateTime\": \"2023-10-26T15:05:00Z\"\n    }\n    // ... 更多内容\n  ],\n  \"total\": 20,\n  \"size\": 10,\n  \"current\": 1,\n  \"pages\": 2\n}\n```\n- **可能返回状态码:** 200, 400, 401, 403, 500\n\n### 2.3 获取内容详情\n\n- **接口路径**：`/api/v1/workbench/content/{contentId}`\n- **请求方法**：`GET`\n- **接口说明**：获取指定内容草稿的详细信息。\n- **权限:** `workbench:content:view`\n- **请求参数 (Path Parameters):**\n\n| 参数名    | 类型    | 是否必需 | 说明       | 示例值 |
|-----------|--------|----------|------------|--------|\
| contentId | integer | 是       | 内容ID     | 4001   |\n\n- **响应数据 (统一格式 `data` 字段):** 返回内容详情。\n\n```json\n{\n  \"contentId\": 4001,\n  \"title\": \"我的营销干货分享\",\n  \"contentType\": \"ARTICLE\",\n  \"content\": { \"body\": \"文章正文...\", \"images\": [\"url1\", \"url2\"] },\n  \"tags\": [\"营销\", \"私域\"],\n  \"category\": \"行业分析\",\n  \"status\": \"DRAFT\",\n  \"createTime\": \"2023-10-26T15:00:00Z\",\n  \"updateTime\": \"2023-10-26T15:05:00Z\"\n}\n```\n- **可能返回状态码:** 200, 401, 403, 404 (内容不存在), 500\n\n### 2.4 更新内容\n\n- **接口路径**：`/api/v1/workbench/content/{contentId}`\n- **请求方法**：`PUT`\n- **接口说明**：更新指定内容草稿的信息。\n- **权限:** `workbench:content:update`\n- **请求参数 (Path Parameters):**\n\n| 参数名    | 类型    | 是否必需 | 说明       | 示例值 |
|-----------|--------|----------|------------|--------|\
| contentId | integer | 是       | 内容ID     | 4001   |\n\n- **请求体 (Request Body):** 结构与创建内容类似，可以只包含需要更新的字段。\n\n- **响应数据 (统一格式 `data` 字段):** 返回更新后的内容信息。\n\n```json\n{\n  \"contentId\": 4001,\n  \"title\": \"更新后的标题\",\n  \"updateTime\": \"2023-10-26T15:10:00Z\"\n}\n```\n- **可能返回状态码:** 200, 400, 401, 403, 404, 422, 500\n\n### 2.5 删除内容\n\n- **接口路径**：`/api/v1/workbench/content/{contentId}`\n- **请求方法**：`DELETE`\n- **接口说明**：删除指定内容草稿。\n- **权限:** `workbench:content:delete`\n- **请求参数 (Path Parameters):**\n\n| 参数名    | 类型    | 是否必需 | 说明       | 示例值 |
|-----------|--------|----------|------------|--------|\
| contentId | integer | 是       | 内容ID     | 4001   |\n\n- **响应数据 (统一格式 `data` 字段):** 返回成功信息。\n\n```json\n{\n  \"message\": \"内容删除成功\"\n}\n```\n- **可能返回状态码:** 200, 401, 403, 404, 500\n\n### 2.6 获取可分发平台列表\n\n- **接口路径**：`/api/v1/workbench/distribute/platforms`\n- **请求方法**：`GET`\n- **接口说明**：获取当前用户已授权并可用于内容分发的平台列表（如已绑定的微信公众号、抖音号等）。\n- **权限:** `workbench:distribute:platforms:view`\n- **请求参数 (Query Parameters):** 无\n\n- **响应数据 (统一格式 `data` 字段):** 返回可分发平台列表。\n\n```json\n[\n  {\n    \"platformId\": \"WECHAT_MP_1\",\n    \"platformName\": \"微信公众号 - 存客宝服务号\",\n    \"platformType\": \"WECHAT_MP\",\n    \"accountId\": \"mp_account_id_1\" // 关联的平台账号ID\n  },\n   {\n    \"platformId\": \"DOUYIN_USER_A\",\n    \"platformName\": \"抖音账号 - 卡若说\",\n    \"platformType\": \"DOUYIN\",\n    \"accountId\": \"douyin_user_id_A\"\n  }\n  // ... 更多平台\n]\n```\n- **可能返回状态码:** 200, 401, 403, 500\n\n### 2.7 发起内容分发任务\n\n- **接口路径**：`/api/v1/workbench/distribute`\n- **请求方法**：`POST`\n- **接口说明**：将指定内容分发到选定的多个平台。此接口通常只负责创建分发任务并返回任务ID，实际分发是异步进行的。\n- **权限:** `workbench:distribute:create`\n- **请求参数 (Request Body):**\n\n| 参数名      | 类型           | 是否必需 | 描述         | 示例值 |
|-------------|----------------|----------|--------------|--------|\
| contentId   | integer        | 是       | 待分发内容ID | 4001   |\
| platformIds | array<string>  | 是       | 目标平台ID列表 | `[\"WECHAT_MP_1\", \"DOUYIN_USER_A\"]` |\
| scheduledTime| string       | 否       | 定时发布时间 (ISO 8601)，立即发布则不传 | \"2023-10-26T16:00:00Z\" |\
\n- **响应数据 (统一格式 `data` 字段):** 返回分发任务信息。\n\n```json\n{\n  \"distributeTaskId\": 5001,\n  \"contentId\": 4001,\n  \"status\": \"PENDING\", // PENDING, PROCESSING, COMPLETED, PARTIAL_SUCCESS, FAILED\n  \"createTime\": \"2023-10-26T15:30:00Z\"\n}\n```\n- **可能返回状态码:** 202 (已接受处理), 400, 401, 403, 404 (内容或平台不存在), 422, 500\n\n### 2.8 查询分发任务状态及结果\n\n- **接口路径**：`/api/v1/workbench/distribute/tasks/{taskId}`\n- **请求方法**：`GET`\n- **接口说明**：查询指定分发任务的详细状态和每个平台的具体分发结果。\n- **权限:** `workbench:distribute:task:view`\n- **请求参数 (Path Parameters):**\n\n| 参数名   | 类型    | 是否必需 | 说明         | 示例值 |
|----------|--------|----------|--------------|--------|\
| taskId   | integer | 是       | 分发任务ID   | 5001   |\n\n- **响应数据 (统一格式 `data` 字段):** 返回分发任务详情。\n\n```json
{
  \"distributeTaskId\": 5001,\n  \"contentId\": 4001,\n  \"status\": \"PARTIAL_SUCCESS\",\n  \"createTime\": \"2023-10-26T15:30:00Z\",\n  \"updateTime\": \"2023-10-26T15:35:00Z\",\n  \"results\": [\n    {\n      \"platformId\": \"WECHAT_MP_1\",\n      \"status\": \"SUCCESS\", // SUCCESS, FAILED, PENDING, PROCESSING\n      \"platformContentId\": \"wx_article_id_abc\", // 平台返回的内容ID\n      \"platformContentUrl\": \"https://mp.weixin.qq.com/s/xxx\", // 平台内容链接\n      \"errorMessage\": null\n    },\n    {\n      \"platformId\": \"DOUYIN_USER_A\",\n      \"status\": \"FAILED\",\n      \"platformContentId\": null,\n      \"platformContentUrl\": null,\n      \"errorMessage\": \"抖音接口调用失败：敏感词过滤未通过\"\n    }\n  ]\n}\n```
- **可能返回状态码:** 200, 401, 403, 404, 500

## 3. 数据模型设计\n\n### 3.1 内容草稿表 `t_workbench_content`\n\n存储用户在工作台创建和编辑的内容草稿。\n\n| 字段名        | 类型         | 是否必需 | 说明             | 索引        |\n|--------------|--------------|----------|------------------|------------|\
| id           | BIGINT (PK)  | 是       | 主键             |            |\
| user_id      | BIGINT (FK)  | 是       | 创建用户ID       | Index      |\
| title        | VARCHAR(255) | 是       | 内容标题         | Index      |\
| content_type | VARCHAR(20)  | 是       | 内容类型 (ARTICLE, IMAGE, VIDEO) | Index |\
| content_data | JSON / TEXT  | 是       | 内容详情数据，根据类型不同 |            |\
| tags         | JSON / TEXT  | 否       | 内容标签列表 (JSON 数组) |            |\
| category     | VARCHAR(50)  | 否       | 内容分类         | Index      |\
| status       | VARCHAR(20)  | 是       | 状态 (DRAFT, READY, DISTRIBUTING, DISTRIBUTED, FAILED) | Index |\
| create_time  | DATETIME     | 是       | 创建时间         |            |\
| update_time  | DATETIME     | 是       | 更新时间         |            |\
\n### 3.2 内容分发任务表 `t_distribute_task`\n\n记录内容分发任务的基本信息。\n\n| 字段名        | 类型         | 是否必需 | 说明             | 索引        |\n|--------------|--------------|----------|------------------|------------|\
| id           | BIGINT (PK)  | 是       | 主键             |            |\
| user_id      | BIGINT (FK)  | 是       | 发起任务用户ID   | Index      |\
| content_id   | BIGINT (FK)  | 是       | 关联的内容草稿ID | Index      |\
| status       | VARCHAR(20)  | 是       | 任务状态 (PENDING, PROCESSING, COMPLETED, PARTIAL_SUCCESS, FAILED) | Index |\
| scheduled_time| DATETIME     | 否       | 定时发布时间     | Index      |\
| create_time  | DATETIME     | 是       | 创建时间         |            |\
| update_time  | DATETIME     | 是       | 更新时间         |            |\
\n### 3.3 分发结果详情表 `t_distribute_result`\n\n记录每个分发任务在每个平台的具体分发结果。\n\n| 字段名        | 类型         | 是否必需 | 说明               | 索引        |\n|--------------|--------------|----------|--------------------|------------|\
| id           | BIGINT (PK)  | 是       | 主键               |            |\
| task_id      | BIGINT (FK)  | 是       | 关联的分发任务ID   | Index      |\
| platform_id  | VARCHAR(50)  | 是       | 目标平台唯一标识   | Index      |\
| platform_name| VARCHAR(100) | 否       | 平台名称           |            |\
| platform_type| VARCHAR(50)  | 是       | 平台类型         | Index      |\
| account_id   | VARCHAR(100) | 是       | 关联的平台账号ID   | Index      |\
| status       | VARCHAR(20)  | 是       | 平台分发状态 (PENDING, PROCESSING, SUCCESS, FAILED) | Index |\
| platform_content_id| VARCHAR(255) | 否 | 平台返回的内容ID   |            |\
| platform_content_url| VARCHAR(500)| 否 | 平台内容链接       |            |\
| error_message| TEXT         | 否       | 分发失败错误信息   |            |\
| create_time  | DATETIME     | 是       | 创建时间           |            |\
| update_time  | DATETIME     | 是       | 更新时间           |            |\
\n## 4. 异常处理\n\n- `ContentNotFoundException`: 内容草稿不存在异常\n- `PlatformNotAuthorizedException`: 平台未授权或配置错误异常\n- `DistributeTaskCreationException`: 分发任务创建失败异常\n- `PlatformApiException`: 调用外部平台 API 异常\n- `DistributeFailedException`: 内容分发失败异常\n\n## 5. 开发注意事项和实现要点\n\n1.  **平台对接:**\n    - 需要针对每个目标平台（微信公众号、微博、抖音、小红书等）实现独立的适配器或服务，封装各自的 API 调用逻辑。\n    - 处理不同平台的内容格式要求、API 调用频率限制、内容审核规则等差异。\n    - 统一管理各个平台的授权信息（access_token, refresh_token等）。\n2.  **内容格式转换:**\n    - 设计灵活的内容格式转换机制，将存客宝内部的内容格式转换为各平台所需的格式。\n3.  **异步处理和任务调度:**\n    - 内容分发是异步过程。接收到分发请求后，将任务放入消息队列，由消费者异步执行实际的分发逻辑。\n    - 使用任务调度框架 (如 Quartz, XXL-Job) 处理定时分发任务。\n    - 跟踪每个分发任务在各平台的状态，并及时更新分发结果。\n4.  **统一内容管理:**\n    - `t_workbench_content` 表用于管理所有待分发的内容草稿。支持多种内容类型。\n5.  **错误处理和回传:**\n    - 捕获分发过程中可能出现的各种错误（如平台 API 调用失败、内容审核不通过），并记录到 `t_distribute_result` 表中。\n    - 将错误信息回传给前端，便于用户查看分发失败原因并进行处理。\n6.  **权限控制:**\n    - 对内容创建、查看、更新、删除、平台列表查询、发起分发任务、查询任务状态等接口进行权限控制。\n7.  **定时发布:**\n    - 支持设置定时发布时间。调度器负责在指定时间触发分发任务。\n8.  **可扩展性:**\n    - 设计易于扩展的架构，方便后续集成新的分发平台。\n\n--- 