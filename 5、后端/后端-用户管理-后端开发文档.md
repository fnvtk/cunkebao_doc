### 用户管理模块后端开发文档

#### 模块概述

负责平台用户（管理员、运营、普通用户等）相关的管理功能，包括用户信息的增删改查、角色分配与管理等。本模块是认证授权模块的基础数据支撑之一。

#### 后端技术栈

- 主要技术：Spring Boot, MyBatis-Plus
- 数据库：MySQL
- 缓存：Redis (用于缓存用户常用信息、权限等)
- 安全：Spring Security, JWT (与认证授权模块协作)

#### 核心实体与数据表

本模块主要操作认证授权模块中定义的用户、角色、权限及关联表。

- 用户表 (`kr_user`)
- 角色表 (`kr_role`)
- 权限表 (`kr_permission`)
- 用户角色关联表 (`kr_user_role`)
- 角色权限关联表 (`kr_role_permission`)

详细字段定义请参考 **`../../2、架构/数据库设计.md`** 和 **`./认证授权模块开发文档.md`** 中的数据库设计部分。

#### 主要API接口 (`/api/v1/users`)

所有接口遵循 **`./前后端接口约定.md`** 定义的 RESTful 规范、请求响应格式、错误处理和认证授权机制。

##### 1. 获取用户列表

- **URL:** `/api/v1/users`
- **HTTP方法:** `GET`
- **说明:** 分页查询用户列表，支持按条件过滤和排序。
- **权限:** `user:list` 或 `user:view` (根据具体权限粒度定义)
- **请求参数 (Query Parameters):**

| 参数名      | 类型     | 是否必需 | 说明                     | 示例            |
|-------------|----------|----------|--------------------------|-----------------|
| page        | integer  | 否       | 页码，从1开始 (默认: 1)    | 1               |
| size        | integer  | 否       | 每页条数 (默认: 10)      | 10              |
| username    | string   | 否       | 用户名模糊搜索           | admin           |
| realName    | string   | 否       | 真实姓名模糊搜索         | 张三            |
| phone       | string   | 否       | 手机号精确搜索           | 13800138000     |
| status      | integer  | 否       | 用户状态 (0:禁用, 1:启用) | 1               |
| sort        | string   | 否       | 排序字段 (如: createTime)| createTime      |
| order       | string   | 否       | 排序方向 (asc/desc)      | desc            |

- **响应数据 (统一格式 `data` 字段):**

```json
{
  "records": [
    {
      "id": 1,
      "username": "admin",
      "realName": "系统管理员",
      "phone": "13811112222",
      "email": "admin@example.com",
      "avatar": "...",
      "status": 1,
      "createTime": "2023-01-01T10:00:00Z",
      "updateTime": "2023-01-01T10:00:00Z"
      // 可能包含角色列表等信息，具体根据需求定义
    }
    // ... 更多用户记录
  ],
  "total": 100,
  "size": 10,
  "current": 1,
  "pages": 10
}
```
- **可能返回状态码:** 200, 400, 401, 403, 422, 500

##### 2. 获取用户详情

- **URL:** `/api/v1/users/{id}`
- **HTTP方法:** `GET`
- **说明:** 根据用户ID获取用户详细信息，包括关联的角色和权限。
- **权限:** `user:view`
- **请求参数 (Path Parameters):**

| 参数名 | 类型   | 是否必需 | 说明     | 示例 |
|--------|--------|----------|----------|------|
| id     | integer | 是       | 用户ID   | 1     |

- **响应数据 (统一格式 `data` 字段):**

```json
{
  "id": 1,
  "username": "admin",
  "realName": "系统管理员",
  "phone": "13811112222",
  "email": "admin@example.com",
  "avatar": "...",
  "status": 1,
  "createTime": "2023-01-01T10:00:00Z",
  "updateTime": "2023-01-01T10:00:00Z",
  "roles": [
    {"id": 1, "roleName": "管理员", "roleKey": "ADMIN"},
    {"id": 2, "roleName": "运营", "roleKey": "OPERATOR"}
  ],
  "permissions": [
      "user:list", "user:view", "user:create", "user:edit", "user:delete", "role:assign" // 示例权限列表
  ]
}
```
- **可能返回状态码:** 200, 401, 403, 404, 500

##### 3. 创建新用户

- **URL:** `/api/v1/users`
- **HTTP方法:** `POST`
- **说明:** 创建新的平台用户。
- **权限:** `user:create`
- **请求体 (Request Body):**

```json
{
  "username": "newuser",
  "password": "initialPassword123", // 后端接收后进行加密存储
  "realName": "新用户",
  "phone": "13900001111",
  "email": "newuser@example.com",
  "status": 1 // 默认启用
  // 可以在创建时指定角色ID列表
  // "roleIds": [2, 3]
}
```
- **响应数据 (统一格式 `data` 字段):**

```json
{
  "id": 2, // 返回新创建用户的ID
  "username": "newuser"
  // 可能返回其他少量信息
}
```
- **可能返回状态码:** 201, 400, 401, 403, 422, 409 (用户名/手机号/邮箱重复), 500

##### 4. 更新用户信息

- **URL:** `/api/v1/users/{id}`
- **HTTP方法:** `PUT` (全量更新) 或 `PATCH` (部分更新，建议使用 PATCH 更灵活)
- **说明:** 更新指定ID的用户信息。
- **权限:** `user:edit`
- **请求参数 (Path Parameters):**

| 参数名 | 类型   | 是否必需 | 说明     | 示例 |
|--------|--------|----------|----------|------|
| id     | integer | 是       | 用户ID   | 1     |

- **请求体 (Request Body):** 包含需要更新的用户字段，与创建用户请求体类似，但不包含ID和敏感字段如密码（应通过单独的修改密码接口）。

```json
{
  "realName": "张三修改",
  "phone": "13899990000",
  "email": "zhangsan_updated@example.com",
  "status": 0 // 更新为禁用状态
}
```
- **响应数据 (统一格式 `data` 字段):** 通常返回更新成功状态，或者更新后的部分关键信息。

```json
{
  "updated": true // 表示更新成功
}
```
- **可能返回状态码:** 200, 400, 401, 403, 404, 422, 409 (用户名/手机号/邮箱重复), 500

##### 5. 删除用户

- **URL:** `/api/v1/users/{id}`
- **HTTP方法:** `DELETE`
- **说明:** 删除指定ID的用户。考虑逻辑删除而非物理删除。
- **权限:** `user:delete`
- **请求参数 (Path Parameters):**

| 参数名 | 类型   | 是否必需 | 说明     | 示例 |
|--------|--------|----------|----------|------|
| id     | integer | 是       | 用户ID   | 1     |

- **响应数据 (统一格式 `data` 字段):**

```json
{
  "deleted": true // 表示删除成功
}
```
- **可能返回状态码:** 204, 401, 403, 404, 500, 400 (如果用户有关联数据无法删除)

##### 6. 分配用户角色

- **URL:** `/api/v1/users/{id}/roles`
- **HTTP方法:** `POST` (或 PUT/PATCH 根据业务语义)
- **说明:** 为指定用户分配或更新角色。
- **权限:** `role:assign` 或 `user:assignRole` (根据具体权限粒度定义)
- **请求参数 (Path Parameters):**

| 参数名 | 类型   | 是否必需 | 说明     | 示例 |
|--------|--------|----------|----------|------|
| id     | integer | 是       | 用户ID   | 1     |

- **请求体 (Request Body):** 包含要分配的角色ID列表。

```json
{
  "roleIds": [1, 2, 3] // 分配的角色ID列表，通常是覆盖用户现有角色
}
```
- **响应数据 (统一格式 `data` 字段):**

```json
{
  "assigned": true // 表示分配成功
}
```
- **可能返回状态码:** 200, 400, 401, 403, 404 (用户或角色不存在), 500

---

#### 开发注意事项和实现要点

1.  **用户密码处理:**
    - 用户密码在接收到后必须使用强加密算法（如 BCrypt）进行散列存储，绝不能明文存储。
    - 在用户更新或创建接口中，不应直接通过普通字段修改密码，应提供单独的"修改密码"接口，且修改密码时需要验证旧密码或通过重置流程。
2.  **权限校验:**
    - 在所有用户相关的敏感操作接口（创建、更新、删除、分配角色等）上，必须使用 `@PreAuthorize` 注解或通过配置 Spring Security 的 intercept-url 来进行权限控制。
    - 权限标识符 (Permission Key) 需与 `./认证授权模块开发文档.md` 中定义的权限体系一致（如 `user:create`, `user:edit`, `user:delete`, `user:view`, `role:assign` 等）。
3.  **数据验证:**
    - 对所有接收到的用户数据进行严格验证，包括但不限于：
        - 用户名、手机号、邮箱格式和唯一性校验。
        - 密码复杂度校验（如果创建或修改密码）。
        - 必填字段校验。
    - 使用 Spring Validation 框架结合注解进行声明式验证。验证失败时，按照 `./前后端接口约定.md` 中的约定返回 422 状态码和详细的错误信息列表。
4.  **日志记录:**
    - 记录所有关键的用户管理操作日志，包括：
        - 用户登录、登出 (在认证模块实现)。
        - 用户创建、更新、删除。
        - 用户角色分配。
        - 记录操作人（用户ID）、操作时间、操作类型、操作对象（用户ID/用户名）以及操作结果。
    - 遵循统一的日志格式规范，使用 ELK 等工具进行日志收集、存储和分析。
5.  **逻辑删除:**
    - 删除用户操作应采用逻辑删除（更新 `deleted` 字段状态），而不是物理删除，以保留数据用于审计和恢复。在查询时，需要过滤掉已逻辑删除的数据。
6.  **与认证授权模块的协作:**
    - 用户创建/更新时，需要确保用户信息与认证授权服务中的用户数据一致性（如果用户服务和认证服务是单独的微服务）。
    - 获取用户详情时，需要能够查询到用户关联的角色和权限信息，这可能需要调用认证授权服务的接口或通过关联表查询。
7.  **事务管理:**
    - 对于创建用户并分配角色等需要操作多个表（`kr_user`, `kr_user_role`）的功能，需要使用 `@Transactional` 注解确保操作的原子性，防止部分操作成功而另一部分失败导致数据不一致。
8.  **接口版本控制:**
    - 当前接口版本为 `/api/v1`。未来若接口发生不兼容变更，需升级版本号并维护旧版本一段过渡期。
9.  **异常处理:**
    - 捕获并处理各种可能发生的异常，如参数校验失败 (`MethodArgumentNotValidException`)、唯一约束冲突 (`DuplicateKeyException`)、资源未找到 (`NotFoundException`)、权限不足 (`AccessDeniedException`) 等。
    - 异常处理程序应返回符合 `./前后端接口约定.md` 中定义的错误响应格式。

---

> 本文档详细说明了存客宝后端用户管理模块的设计与实现要点，开发时请严格遵循上述规范，确保系统功能完善和安全稳定。 