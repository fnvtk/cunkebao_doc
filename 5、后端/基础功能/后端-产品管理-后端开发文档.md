# 产品管理模块后端开发指南

## 一、引言与目标

### 1.1 模块定位
产品管理模块是电商平台、服务预订系统或任何涉及目录管理的核心组件。它负责定义、组织、存储和管理系统中所有可销售或可展示的产品、服务或项目（以下统称"产品"）。此模块为前台展示、库存控制、订单处理、营销活动等其他业务模块提供基础数据支持。

### 产品管理模块核心流程图

```mermaid
graph TD
    A[运营/业务方] --> B{产品信息录入/管理};
    B --> C[后端API接收请求/校验];
    C --> D{数据持久化(SPU/SKU/分类等)};
    D --> E[库存/价格更新];
    E --> F[搜索引擎同步(可选)];
    F --> G[缓存更新];
    G --> H[产品列表/详情展示(前端/API)];
    H --> I[完成];
    C -- 校验失败/异常 --> J[返回错误信息];
    J --> I;
```

### 1.2 设计目标
- **灵活性与全面性**: 支持管理多种类型的产品，包括实体商品、虚拟商品、服务等，并能描述其复杂属性和规格。
- **易用性**: 提供清晰的数据模型和管理接口，方便运营人员录入、编辑和维护产品信息。
- **高性能**: 高效处理大量产品数据的查询和展示，支持快速搜索和筛选。
- **可扩展性**: 易于扩展新的产品类型、属性、规格，并能与其他系统（如ERP、PIM）集成。
- **数据准确性**: 保证产品信息（特别是价格、库存）的准确性和一致性。
- **标准化**: 遵循行业通用的商品模型概念（如SPU/SKU），便于理解和对接。

## 二、模块概述

本模块提供对平台产品（包括实体商品、虚拟服务、订阅等）的全生命周期管理功能。这包括产品的创建、编辑、详情描述、多规格管理 (SKU)、分类组织、价格设定、库存控制、状态管理（如上架、下架、草稿）、以及相关的图片和多媒体资源管理。

## 三、核心概念与架构组件

### 3.1 核心概念
- **SPU (Standard Product Unit, 标准产品单元)**: 产品的标准化描述单元，代表一类具有共同属性的商品集合。例如，"iPhone 15 Pro"是一个SPU，它有通用的描述、品牌、型号等。
- **SKU (Stock Keeping Unit, 库存量单位)**: 产品的最小库存管理单元，是SPU下根据不同销售属性（如颜色、尺寸、容量）组合的具体规格。例如，"iPhone 15 Pro 256GB 蓝色"是一个SKU。每个SKU有独立的价格、库存和图片（可选）。
- **产品分类 (Product Category)**: 用于组织和层级化管理产品，方便用户浏览和筛选。分类可以是多层级的。
- **产品属性 (Product Attribute)**: 描述产品特性的信息。分为：
    - *关键属性/规格属性*: 用于区分不同SKU的属性，如颜色、尺寸、内存大小。
    - *描述属性/普通属性*: 用于丰富产品描述，不影响SKU划分，如材质、产地、保修期。
- **品牌 (Brand)**: 产品的品牌信息。
- **价格 (Price)**: 产品或SKU的销售价格、市场价、成本价等。
- **库存 (Stock/Inventory)**: 特定SKU的可用数量。
- **产品状态 (Product Status)**: 产品的生命周期状态，如草稿、待审核、已上架（在售）、已下架、已删除等。

### 3.2 关键技术考量
- **商品模型设计**: 合理设计SPU与SKU的关系模型，以及属性、规格的存储方式，是模块的核心。
- **数据库选型**: 对于大量的商品数据和复杂的查询需求，需要选择合适的数据库并优化表结构和索引。
- **搜索引擎集成 (可选)**: 对于复杂的商品搜索和筛选需求（如全文搜索、多维度聚合筛选），通常会集成专门的搜索引擎（如Elasticsearch, Solr, Algolia）。
- **图片与多媒体存储**: 大量产品图片、视频等需要高效的存储和CDN分发方案。
- **缓存策略**: 缓存热点商品信息、分类信息、价格信息等，以提高读取性能。
- **库存管理机制**: 需要考虑高并发下的库存扣减准确性（如使用乐观锁、悲观锁或分布式锁，或基于消息队列的最终一致性方案）。

## 四、核心数据实体/模型

1.  **SPU (StandardProductUnit)**
    *   `spu_id` (主键): SPU唯一标识符。
    *   `name` (字符串, 必填): SPU名称 (如 "iPhone 15 Pro")。
    *   `title` (字符串, 可选): 产品营销标题/副标题。
    *   `description` (文本, 可选): 详细描述 (可支持富文本)。
    *   `category_id` (外键, 必填): 所属产品分类ID。
    *   `brand_id` (外键, 可选): 所属品牌ID。
    *   `status` (枚举: draft, active, inactive, archived): SPU状态。
    *   `default_image_url` (字符串, 可选): SPU默认主图。
    *   `attributes` (JSON/结构化数据, 可选): SPU的通用描述属性。
    *   `created_at`, `updated_at` (时间戳)。

2.  **SKU (StockKeepingUnit)**
    *   `sku_id` (主键): SKU唯一标识符。
    *   `spu_id` (外键, 必填): 关联的SPU ID。
    *   `sku_code` (字符串, 可选, 唯一): SKU编码/商家编码。
    *   `name_extension` (字符串, 可选): SKU规格名称的补充 (如 "256GB 蓝色")。
    *   `specifications` (JSON/结构化数据, 必填): 定义此SKU的规格组合 (如 `[{ "name": "颜色", "value": "蓝色" }, { "name": "容量", "value": "256GB" }]`)。
    *   `price` (十进制, 必填): 销售价格。
    *   `market_price` (十进制, 可选): 市场价/划线价。
    *   `cost_price` (十进制, 可选): 成本价。
    *   `stock_quantity` (整数, 默认: 0): 当前库存量。
    *   `low_stock_threshold` (整数, 可选): 低库存预警阈值。
    *   `status` (枚举: enabled, disabled): SKU状态。
    *   `images` (JSON数组, 可选): SKU特定的图片列表 (URL)。
    *   `weight`, `dimensions` (可选): 重量和尺寸信息。
    *   `created_at`, `updated_at` (时间戳)。

3.  **产品分类 (ProductCategory)**
    *   `category_id` (主键): 分类唯一标识符。
    *   `name` (字符串, 必填): 分类名称。
    *   `parent_category_id` (外键, 可选): 父分类ID，支持层级。
    *   `level` (整数, 可选): 分类层级。
    *   `sort_order` (整数, 可选): 排序。
    *   `icon_url` (字符串, 可选): 分类图标。
    *   `is_active` (布尔, 默认: true): 是否激活。

4.  **产品属性名 (AttributeName) / 产品属性值 (AttributeValue)** (可选的规范化设计)
    *   或直接在SPU/SKU中使用JSON存储属性。

5.  **品牌 (Brand)**
    *   `brand_id` (主键)。
    *   `name` (字符串, 必填)。
    *   `logo_url` (字符串, 可选)。

## 五、功能模块划分

1.  **SPU管理模块**
    *   SPU的创建、编辑、查看、删除。
    *   SPU基本信息、描述、通用属性维护。
    *   SPU状态管理（草稿、上架、下架等）。
2.  **SKU管理模块**
    *   基于SPU创建和管理SKU。
    *   SKU的规格组合定义。
    *   SKU独立的价格、库存、图片维护。
    *   SKU启用/禁用状态管理。
3.  **库存管理模块**
    *   SKU库存的查询、增加、扣减（需考虑并发安全）。
    *   低库存预警。
    *   (可选) 多仓库库存管理。
4.  **价格管理模块**
    *   SKU销售价、市场价、成本价的设定与调整。
    *   (可选) 定价策略、会员价、活动价管理。
5.  **分类与品牌管理模块**
    *   产品分类的层级管理（增删改查）。
    *   产品品牌的管理。
6.  **属性与规格管理模块**
    *   定义可用于SPU和SKU的属性和规格（如颜色、尺寸）。
    *   管理属性值选项。
7.  **图片与多媒体管理模块**
    *   上传、管理SPU和SKU的图片、视频等资源。
8.  **产品搜索与查询模块**
    *   提供面向运营后台的产品列表查询、筛选功能。
    *   (若需对外) 提供面向用户的前台产品搜索接口。

## 六、API接口设计指导原则

- **资源**: `products` (可理解为SPU), `products/{spu_id}/skus` (特定SPU下的SKU), `categories`, `brands`, `attributes`。
- **SPU管理API**: (示例)
    - `POST /products`: 创建新SPU (可同时创建默认SKU)。
    - `GET /products`: 获取SPU列表 (支持筛选、分页、排序)。
    - `GET /products/{spu_id}`: 获取SPU详情 (通常包含其下所有SKU信息)。
    - `PUT /products/{spu_id}`: 更新SPU信息。
    - `DELETE /products/{spu_id}`: 删除SPU (需处理关联SKU)。
    - `POST /products/{spu_id}/publish`: 上架SPU。
    - `POST /products/{spu_id}/unpublish`: 下架SPU。
- **SKU管理API**: (示例)
    - `POST /products/{spu_id}/skus`: 为指定SPU创建新SKU。
    - `GET /skus/{sku_id}`: 获取SKU详情。
    - `PUT /skus/{sku_id}`: 更新SKU信息 (如价格、库存、规格图片)。
    - `PATCH /skus/{sku_id}/stock`: 调整SKU库存 (增/减)。
- **分类API**: `GET /categories`, `POST /categories` 等。
- **通用原则**: RESTful, JSON, 标准状态码, 错误处理, 认证授权, 审计日志。

## 七、主要业务流程示例

### 1. 创建一个包含多个SKU的新产品 (SPU)
    1.  运营人员通过后台界面或API提交创建SPU的请求，包含SPU名称、描述、分类、品牌等基础信息。
    2.  API校验数据，创建SPU记录，初始状态可为"草稿"。
    3.  运营人员继续为该SPU添加SKU：
        a.  选择或定义规格属性（如颜色：红、蓝；尺寸：M、L）。
        b.  为每个规格组合（如红+M, 蓝+L）创建SKU，并分别设置价格、初始库存、SKU特定图片等。
        c.  API校验并保存每个SKU信息，关联到对应的SPU。
    4.  运营人员确认无误后，将SPU状态修改为"待上架"或直接"上架"。

### 2. 用户下单扣减SKU库存
    1.  用户在前端选择特定SKU并提交订单。
    2.  订单服务接收请求，校验订单信息。
    3.  订单服务调用产品/库存模块的接口，请求扣减指定SKU的库存。
        *   请求参数：`sku_id`, `quantity_to_deduct`。
    4.  库存模块：
        a.  查询当前SKU库存。
        b.  检查库存是否充足。
        c.  若充足，则执行库存扣减操作（注意并发安全，如使用`UPDATE product_sku SET stock = stock - ? WHERE sku_id = ? AND stock >= ?`）。
        d.  返回扣减成功或失败（如库存不足）的结果给订单服务。
    5.  若库存扣减失败，订单服务标记订单创建失败或进入待处理状态。

## 八、技术考量与开发注意事项

1.  **SPU/SKU模型设计**: 清晰区分SPU和SKU的职责和数据存储，灵活支持多规格。
2.  **库存同步与准确性**: 高并发场景下，库存扣减需保证原子性和准确性。考虑分布式锁、乐观锁或基于消息队列的最终一致性方案。
3.  **价格体系复杂性**: 若涉及多种价格类型（会员价、促销价、阶梯价），需设计灵活的价格管理和计算逻辑。
4.  **属性动态扩展**: 考虑未来新增产品属性和规格的需求，设计可扩展的属性存储方案（如EAV模型或JSON存储，需权衡查询性能）。
5.  **搜索优化**: 对于大量产品，后台管理界面的搜索筛选性能，以及前台（如果需要）的商品搜索体验至关重要。可能需要引入搜索引擎。
6.  **数据一致性**: 产品信息变更（如价格调整、SPU下架）时，需考虑对关联数据（如购物车、订单、营销活动）的影响和同步。
7.  **图片处理与CDN**: 产品图片可能很多，需要高效的上传、处理（缩放、裁剪、水印）和CDN分发方案。
8.  **与外部系统集成**: 可能需要与ERP（库存、订单）、PIM（产品信息管理）、WMS（仓储管理）等系统进行数据同步。
9.  **批量操作**: 支持批量上/下架、调价、修改库存等，提高运营效率。
10. **国际化/多语言**: 若产品面向多区域市场，需支持产品名称、描述、属性的多语言展示。

## 九、数据校验与错误处理

1.  **必填项校验**: 如SPU名称、分类、SKU价格、库存等。
2.  **格式校验**: 如价格、库存数量必须为数字，图片URL格式。
3.  **业务规则校验**: 如SKU价格不能低于成本价（如果配置了），库存不能为负数（除非业务允许预售）。
4.  **唯一性校验**: 如SKU编码的唯一性。
5.  **错误反馈**: 清晰告知用户操作失败的原因。

## 十、安全性考量

1.  **权限控制**: 严格控制对产品数据的增删改查权限，区分不同运营角色。
2.  **价格篡改防护**: 防止恶意用户通过非法手段修改商品价格。
3.  **库存超卖防护**: 严格的库存检查和扣减机制，防止超卖。
4.  **数据操作审计**: 对关键产品信息（如价格、库存）的修改操作记录审计日志。
5.  **敏感信息保护**: (如果产品信息中包含敏感内容) 进行适当处理。 

## 相关前端UI图片

以下是与产品管理功能相关的部分前端UI截图，帮助理解后端功能在前端界面的展现：

### 工作台 - 产品管理入口 (示意图)

![工作台](4、前端/UI/工作台.png) 