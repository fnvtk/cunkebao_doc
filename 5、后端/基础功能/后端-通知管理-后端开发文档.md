# 通知管理模块后端开发指南

## 一、引言与目标

### 1.1 模块定位
通知管理模块是系统中负责与用户及内部系统进行信息传递的关键组件。它统一管理和调度所有类型的出站消息，包括但不限于站内信、电子邮件、短信 (SMS)、App推送、以及可能的即时通讯消息 (如Webhook回调)。其目的是确保信息能够及时、准确、可靠地送达目标接收者。

### 1.2 设计目标
- **多渠道支持与统一管理**: 支持多种通知渠道，并提供统一的配置、发送和监控接口。
- **模板化与个性化**: 支持通知内容的模板化，允许使用变量进行个性化定制。
- **可靠发送**: 保证通知的高送达率，具备失败重试、状态跟踪和错误处理机制。
- **高效异步处理**: 通知发送不应阻塞核心业务流程，采用异步处理机制。
- **用户友好**: 用户可以管理自己的通知偏好设置，避免不必要的打扰。
- **可观测性**: 提供通知发送状态的监控、日志记录和统计分析。
- **可扩展性**: 易于集成新的通知渠道和第三方服务。
- **安全性**: 保护通知内容和用户数据的安全，防止信息泄露和滥用。

## 二、模块概述

本模块负责平台内所有类型通知消息的生命周期管理，包括模板创建与维护、通知任务的生成与调度、通过不同渠道（如站内信、短信、邮件、App推送等）的实际发送、发送状态的追踪记录以及相关的统计分析功能。

## 三、核心概念与架构组件

### 3.1 核心概念
- **通知模板 (Notification Template)**: 预定义的通知内容结构，包含固定文本和可替换的变量占位符。模板可以针对不同渠道和语言。
- **通知渠道 (Notification Channel)**: 发送通知的具体途径，如 Email, SMS, App Push, Web Push, 站内信 (In-App Message), Webhook等。
- **接收者 (Recipient)**: 通知的目标用户或系统。可以是单个用户ID、用户组、邮箱地址、手机号码、设备Token等。
- **通知消息/任务 (Notification Message/Task)**: 基于模板和具体数据生成的一条待发送或已发送的通知实例。
- **发送策略 (Sending Strategy)**: 控制通知发送的规则，如优先级、发送时间窗口、频率限制、渠道选择逻辑等。
- **发送日志/回执 (Delivery Log/Receipt)**: 记录每条通知的发送尝试、最终状态（成功、失败、已读、已点击等）以及来自渠道服务商的回执信息。

### 3.2 关键架构组件考量
- **模板引擎**: 用于解析通知模板，并将变量替换为实际内容。
    - *选型考量*: 语法简洁性、功能丰富度（条件判断、循环等）、性能、安全性（防止模板注入）、多语言支持。常见的有Thymeleaf, Freemarker, Handlebars, Jinja2等。
- **消息队列 (MQ)**: 用于异步化通知发送任务，解耦业务逻辑与实际发送操作，提高系统吞吐量和可靠性。
    - *选型考量*: (同自动化任务模块中的MQ考量)
- **渠道适配器/网关 (Channel Adapter/Gateway)**: 封装与各种第三方通知服务（如邮件服务商SendGrid/Mailgun, 短信服务商Twilio/Vonage, 推送服务FCM/APNS）的集成逻辑。
    - 每个渠道适配器负责处理该渠道特有的API调用、认证、参数格式化、错误处理和回执解析。
- **持久化存储**: 存储通知模板、发送日志、用户通知偏好设置等。
- **用户偏好管理服务**: 允许用户配置接收哪些类型的通知以及通过哪些渠道接收。

## 四、核心数据实体/模型

1.  **通知模板 (NotificationTemplate)**
    *   `template_id` (主键): 模板唯一标识符。
    *   `name` (字符串, 必填): 模板名称/用途描述。
    *   `channel_type` (枚举, 必填): 适用的通知渠道 (e.g., EMAIL, SMS, IN_APP, PUSH)。
    *   `subject_template` (文本, 可选, 邮件类模板需要): 标题模板。
    *   `content_template` (文本, 必填): 内容模板 (支持变量占位符，如 `${user_name}`或 `{{order_id}}`)。
    *   `template_language` (字符串, 可选, 默认: en-US): 模板语言代码。
    *   `status` (枚举: active, inactive, draft): 模板状态。
    *   `version` (整数, 可选): 模板版本号。
    *   `created_at`, `updated_at` (时间戳)。

2.  **通知发送日志 (NotificationLog)**
    *   `log_id` (主键): 日志唯一标识符。
    *   `template_id` (外键, 可选): 使用的通知模板ID。
    *   `recipient_identifier` (字符串, 必填): 接收者标识 (如用户ID, 邮箱, 手机号)。
    *   `channel_type` (枚举, 必填): 实际发送渠道。
    *   `subject` (文本, 可选): 实际发送的标题。
    *   `content` (文本, 必填): 实际发送的内容。
    *   `status` (枚举: pending, sent, delivered, failed, read, clicked): 发送状态。
    *   `scheduled_send_time` (时间戳, 可选): 计划发送时间。
    *   `actual_send_time` (时间戳, 可选): 实际发送时间。
    *   `provider_message_id` (字符串, 可选): 第三方服务商返回的消息ID。
    *   `error_message` (文本, 可选): 发送失败时的错误信息。
    *   `retry_count` (整数): 已重试次数。

3.  **站内信 (InboxMessage)** (如果支持站内信渠道)
    *   `message_id` (主键): 站内信唯一标识符。
    *   `user_id` (外键, 必填): 接收用户ID。
    *   `sender_info` (字符串/JSON, 可选): 发送者信息 (如系统、其他用户)。
    *   `title` (字符串, 必填): 站内信标题。
    *   `body` (文本, 必填): 站内信内容 (可支持HTML或Markdown)。
    *   `is_read` (布尔, 默认: false): 是否已读。
    *   `read_at` (时间戳, 可选): 阅读时间。
    *   `created_at` (时间戳): 创建时间。
    *   `metadata` (JSON, 可选): 附加信息，如关联的业务对象ID。

4.  **用户通知偏好 (UserNotificationPreference)** (可选)
    *   `user_id` (主键/外键)。
    *   `notification_type` (字符串, 例如: "order_update", "marketing_promo", "system_alert")。
    *   `channel_type` (枚举)。
    *   `is_enabled` (布尔, 默认: true)。

## 五、功能模块划分

1.  **模板管理模块**
    *   通知模板的CRUD操作。
    *   模板版本控制和审批流程 (可选)。
    *   模板变量的定义与预览功能。
    *   多语言模板支持。
2.  **渠道管理模块**
    *   配置和管理不同的通知渠道及其参数（如API密钥、发件人地址等）。
    *   渠道健康状态检查。
3.  **通知发送服务**
    *   接收发送请求（可包含接收者、模板ID、变量数据等）。
    *   根据模板和变量生成最终通知内容。
    *   根据用户偏好和发送策略选择合适的渠道。
    *   将发送任务推送到消息队列进行异步处理。
    *   与各渠道适配器交互，执行实际发送。
4.  **状态跟踪与回执处理模块**
    *   更新发送日志中的状态 (pending -> sent -> delivered/failed)。
    *   处理来自第三方服务商的异步回执 (DLR - Delivery Receipts)。
    *   失败重试逻辑。
5.  **用户接收管理模块 (如站内信)**
    *   用户站内信列表查询、标记已读/未读、删除等。
    *   未读消息计数。
6.  **用户通知偏好设置模块**
    *   允许用户配置接收哪些类型的通知以及通过哪些渠道。
7.  **监控与统计模块**
    *   统计各渠道发送量、成功率、失败率、打开率、点击率等。
    *   提供仪表盘展示关键指标。
    *   发送异常告警。

## 六、API接口设计指导原则

- **资源**: `templates` (通知模板), `notifications` (通知发送任务/日志), `inbox/messages` (用户站内信), `preferences` (用户通知偏好)。
- **模板管理API**: (示例)
    - `POST /templates`: 创建新模板。
    - `GET /templates`: 获取模板列表 (支持按渠道、状态筛选)。
    - `GET /templates/{template_id}`: 获取模板详情。
    - `PUT /templates/{template_id}`: 更新模板。
- **通知发送API**: (示例)
    - `POST /notifications/send`: 触发发送通知（异步）。请求体可包含 `recipient_ids`, `template_id`, `variables`, `channel_preferences` 等。
    - `GET /notifications/logs`: 查询发送日志 (支持按接收者、状态、时间范围等筛选)。
- **站内信API**: (示例, 若支持)
    - `GET /users/{user_id}/inbox/messages`: 获取用户的站内信列表。
    - `PUT /inbox/messages/{message_id}/read`: 标记站内信为已读。
- **通用原则**: 同其他模块API设计原则 (RESTful, JSON, 标准状态码, 错误处理, 认证授权等)。

## 七、主要业务流程示例

### 1. 管理员创建并启用一个邮件通知模板
    1.  管理员通过UI或API提交创建模板请求，包含名称、渠道类型（EMAIL）、主题模板、内容模板等。
    2.  API校验通过后，将模板数据存入数据库，状态为"草稿"或"激活"。

### 2. 系统触发发送"订单已发货"通知
    1.  订单模块在订单状态变更为"已发货"后，调用通知发送服务的API接口。
    2.  请求参数包含：`template_name` (或 `template_id`) = "order_shipped", `recipient_id` = 用户ID, `variables` = { `order_number`: "12345", `tracking_url`: "..." }。
    3.  通知发送服务：
        a.  查找有效的"order_shipped"模板。
        b.  (可选) 查询用户通知偏好，确定是否允许发送此类通知以及首选渠道。
        c.  使用变量渲染模板，生成最终的邮件主题和内容。
        d.  创建一条通知发送日志记录，初始状态为"待处理"。
        e.  将此发送任务（包含接收者邮箱、主题、内容等）推送到邮件发送消息队列。
    4.  邮件发送Worker从队列中消费任务：
        a.  通过邮件渠道适配器调用第三方邮件服务商API发送邮件。
        b.  更新发送日志状态为"已发送"或"失败"（及原因）。
    5.  (异步) 若邮件服务商提供回执，回执处理服务更新发送日志状态为"已送达"或"投递失败"。

## 八、技术考量与开发注意事项

1.  **模板引擎选择与安全**: 确保模板引擎安全，防止注入。支持丰富的模板功能。
2.  **异步处理与削峰填谷**: 必须异步发送，使用消息队列应对突发大量通知请求。
3.  **失败重试与幂等性**: 对可恢复的发送失败（如网络抖动、服务商临时不可用）进行重试。确保重试不会导致重复发送（依赖第三方服务商的消息ID或自行生成幂等键）。
4.  **第三方服务集成与容错**: 封装与各服务商的API交互，处理认证、限流、错误码。考虑服务商故障时的降级或切换备用服务商策略。
5.  **成本控制**: 监控短信、付费邮件等渠道的发送量和费用。提供预警机制。
6.  **送达率优化**: 遵守服务商发送规范，管理发件人信誉，处理退订和无效地址，优化邮件内容避免进入垃圾箱。
7.  **用户体验**: 避免过度通知，尊重用户偏好。提供清晰的退订机制。
8.  **多语言和时区**: 如果目标用户遍布全球，模板和发送时间需考虑多语言和接收者时区。
9.  **内容合规性**: 确保通知内容符合法律法规和平台政策，特别是营销类通知。
10. **可测试性**: 方便测试模板渲染、各渠道发送逻辑。提供沙箱模式或mock服务商接口。

## 九、数据校验与错误处理

1.  **模板校验**: 校验模板语法、变量占位符是否正确。
2.  **接收者校验**: 校验邮箱地址、手机号码格式是否合法。
3.  **参数校验**: 发送请求中的参数完整性和有效性。
4.  **错误分类与反馈**: 清晰区分配置错误、发送失败（可重试/不可重试）、服务商错误。向调用方或运营人员提供明确的错误信息。

## 十、安全性考量

1.  **凭证安全**: 安全存储和使用第三方服务商的API密钥、账户密码。
2.  **内容安全**: 防止通过通知内容（尤其是用户可自定义部分）发送恶意链接或脚本 (XSS)。
3.  **数据隐私**: 保护接收者个人信息（邮箱、手机号）。日志记录中对敏感信息脱敏。
4.  **防滥用**: 限制发送频率、单次发送数量，防止被用作垃圾信息发送工具。对高风险操作进行二次确认或验证码。
5.  **权限控制**: 严格控制模板管理、发送操作的权限。 

---

## 相关前端UI图片

以下是与通知管理模块可能相关的部分前端UI截图，帮助理解用户如何进行通知偏好设置或查看通知：

### 我的 - 通知设置入口示例

![我的页面](4、前端/UI/我的.png) 