# 支付服务模块后端开发指南

## 一、引言与目标

### 1.1 模块定位
支付服务模块是任何涉及在线交易的系统的核心金融组件。它负责处理所有与资金收付相关的操作，包括与各种支付网关（如支付宝、微信支付、银行卡支付、PayPal等）的对接、发起支付请求、安全地处理支付回调、执行退款操作、以及记录详细的交易流水以供对账和审计。本模块的稳定、安全和高效运行对平台的商业成功至关重要。

### 1.2 设计目标
- **安全性**: 最高优先级。确保支付过程中的数据传输安全、存储安全、防欺诈、防篡改、防抵赖。符合相关安全标准（如PCI DSS的适用部分）。
- **可靠性与稳定性**: 保证支付服务的高可用性，支付成功率，以及在各种异常情况下的数据一致性。
- **准确性**: 确保金额、手续费、状态等所有金融数据的精确无误。
- **易扩展性**: 方便快捷地集成新的支付渠道和支付方式。
- **易用性 (对内)**: 为其他业务模块提供清晰、简洁、安全的支付和退款接口。
- **可观测性**: 提供全面的支付交易监控、日志、告警和对账支持。
- **合规性**: 满足当地金融法规和支付行业规范。

### 支付流程图

```mermaid
graph TD
    A[用户发起支付] --> B{业务系统创建订单/支付请求};
    B --> C[支付服务接收请求/生成交易];
    C --> D{调用支付网关API(预支付)};
    D -- 返回预支付信息 --> E[返回前端调起支付控件];
    E --> F[用户在支付网关完成支付];
    F -- 异步回调通知 --> G{支付服务回调处理/验签};
    G --> H[更新支付交易状态];
    H --> I[通知业务系统支付结果];
    I --> J[完成];
    G -- 验签失败/异常 --> K[错误处理/告警];
    K --> J;
    D -- 预支付失败 --> K;
```

## 二、模块概述

本模块封装了与外部支付系统交互的所有复杂逻辑，为上层业务（如订单、充值、订阅等）提供统一的支付能力。主要功能包括：管理多种支付渠道的配置，生成支付参数并发起支付，安全地接收和验证支付网关的异步回调通知，处理支付结果，发起和跟踪退款流程，以及记录每一笔支付和退款的详细流水。

## 三、核心概念与架构组件

### 3.1 核心概念
- **支付订单/交易 (Payment Order/Transaction)**: 由业务系统发起的一笔支付请求，关联到具体的业务订单（如商品订单、服务订单）。
- **支付流水号 (Payment Transaction ID)**: 支付服务为每笔支付生成的唯一内部标识。
- **渠道流水号 (Gateway Transaction ID)**: 支付网关返回的该笔支付在其系统中的唯一标识。
- **支付渠道/网关 (Payment Channel/Gateway)**: 提供支付处理服务的第三方机构，如微信支付、支付宝、Stripe、PayPal等。
- **支付方式 (Payment Method)**: 用户实际选择的支付工具，如信用卡、借记卡、支付宝余额、微信零钱、Apple Pay等。
- **预支付 (Pre-payment / Unified Order)**: 向支付网关下单，获取用于调起客户端支付控件的参数（如二维码URL, App支付参数串）。
- **异步回调/通知 (Asynchronous Callback/Notification)**: 支付网关在支付状态发生变化（通常是支付成功或失败）后，通过HTTP请求主动通知商户服务器。
- **同步跳转 (Synchronous Redirect)**: 用户完成支付后，支付网关页面将其浏览器重定向回商户指定的页面。
- **退款订单/交易 (Refund Order/Transaction)**: 由业务系统或运营发起的退款请求。
- **对账 (Reconciliation)**: 将支付服务内部的交易记录与支付网关提供的对账文件进行核对，确保双方数据一致。

### 3.2 关键架构组件考量
- **支付网关适配层 (Gateway Adapter Layer)**: 核心组件。为每种支付渠道实现一个适配器，封装其API调用、签名/验签逻辑、参数转换、错误处理等。使得上层业务逻辑与具体支付渠道解耦。
- **安全组件**: 包括加解密工具、签名生成与验证工具、证书管理等。
- **消息队列 (MQ)**: 广泛用于处理异步回调通知、退款结果通知、触发对账任务等，提高系统的响应速度和可靠性。
- **持久化存储**: 存储支付交易流水、退款记录、支付渠道配置、对账记录等关键数据。通常选用高可靠的关系型数据库。
- **分布式锁 (可选)**: 在处理回调或更新交易状态时，防止并发问题导致数据不一致。
- **配置管理中心**: 集中管理各支付渠道的商户ID、API密钥、证书、回调URL等敏感配置信息。
- **对账引擎**: 负责下载支付渠道对账单，与系统内支付流水进行比对，生成差异报告。
- **风控模块 (可选)**: 集成或自建风险控制服务，对可疑交易进行识别和拦截。

## 四、核心数据实体/模型

1.  **支付交易 (PaymentTransaction)**
    *   `transaction_id` (主键): 支付服务内部唯一交易流水号。
    *   `business_order_id` (字符串, 必填, 索引): 关联的业务订单ID (如商城订单号)。
    *   `business_order_type` (字符串, 可选): 业务订单类型 (如 "GOODS_ORDER", "SUBSCRIPTION_FEE")。
    *   `user_id` (外键, 可选): 支付用户ID。
    *   `payment_channel` (枚举, 必填): 支付渠道 (e.g., ALIPAY, WECHAT_PAY, STRIPE)。
    *   `payment_method` (字符串, 可选): 具体支付方式 (如 "credit_card", "alipay_qr")。
    *   `amount_requested` (十进制, 必填): 请求支付金额。
    *   `amount_paid` (十进制, 可选): 实际支付金额 (可能包含手续费或优惠)。
    *   `currency` (字符串, 必填, e.g., "CNY", "USD")。
    *   `status` (枚举: PENDING_CREATE, PENDING_PAYMENT, PAID_SUCCESS, PAID_FAILED, CLOSED, REFUND_PARTIAL, REFUND_FULL): 支付状态。
    *   `gateway_transaction_id` (字符串, 可选, 索引): 支付网关返回的流水号。
    *   `prepay_info` (JSON/文本, 可选): 预支付信息 (如支付二维码链接、App支付参数)。
    *   `callback_raw_data` (文本, 可选): 支付回调原始数据。
    *   `error_code` (字符串, 可选): 失败时的错误码。
    *   `error_message` (文本, 可选): 失败时的错误描述。
    *   `created_at`, `updated_at`, `paid_at` (时间戳)。

2.  **退款交易 (RefundTransaction)**
    *   `refund_id` (主键): 退款服务内部唯一退款流水号。
    *   `original_transaction_id` (外键, 必填): 关联的原支付交易ID。
    *   `business_refund_id` (字符串, 必填, 索引): 业务系统退款请求ID。
    *   `amount_requested` (十进制, 必填): 请求退款金额。
    *   `amount_refunded` (十进制, 可选): 实际退款金额。
    *   `currency` (字符串, 必填)。
    *   `status` (枚举: PENDING, PROCESSING, SUCCESS, FAILED): 退款状态。
    *   `reason` (文本, 可选): 退款原因。
    *   `gateway_refund_id` (字符串, 可选): 支付网关返回的退款流水号。
    *   `callback_raw_data` (文本, 可选): 退款回调原始数据。
    *   `created_at`, `updated_at`, `refunded_at` (时间戳)。

3.  **支付渠道配置 (PaymentChannelConfig)**
    *   `channel_code` (主键, 枚举): 支付渠道代码。
    *   `merchant_id` (字符串): 商户号。
    *   `app_id` (字符串, 可选): 应用ID。
    *   `api_key_secret` (加密存储): API密钥。
    *   `public_key_platform` (文本, 可选): 支付平台公钥（用于验签）。
    *   `private_key_merchant` (加密存储, 可选): 商户私钥（用于签名）。
    *   `callback_url_payment` (字符串): 支付回调URL。
    *   `callback_url_refund` (字符串, 可选): 退款回调URL。
    *   `is_active` (布尔): 是否启用。

## 五、功能模块划分

1.  **支付核心流程模块**
    *   接收业务方支付请求，创建支付交易记录。
    *   调用相应支付网关适配器，获取预支付信息。
    *   处理支付网关的同步跳转和异步回调通知。
    *   更新支付交易状态，并通知业务方。
2.  **退款核心流程模块**
    *   接收业务方退款请求，创建退款交易记录。
    *   调用相应支付网关适配器，提交退款申请。
    *   处理支付网关的退款结果异步通知。
    *   更新退款交易状态，并通知业务方。
3.  **支付网关适配层**
    *   为每种支付渠道提供统一的接口封装 (发起支付、查询订单、发起退款、验签等)。
    *   处理各渠道特有的参数、签名算法、通讯协议。
4.  **回调处理模块**
    *   提供统一的回调入口点，根据渠道分发给相应处理器。
    *   严格进行签名验证，防止伪造回调。
    *   保证回调处理的幂等性。
    *   使用MQ进行异步解耦和可靠处理。
5.  **交易查询与状态同步模块**
    *   提供查询支付/退款交易状态的接口。
    *   (可选) 定时任务主动向支付网关查询未明确最终状态的交易，进行状态同步（掉单补偿）。
6.  **配置管理模块**
    *   管理各支付渠道的配置信息（商户号、密钥、证书、回调地址等）。
    *   确保配置信息的安全存储和加载。
7.  **对账处理模块**
    *   定时下载支付渠道的对账单。
    *   与系统内支付流水进行匹配和核对。
    *   生成差异报告，辅助人工处理。
8.  **安全与风控模块**
    *   实现或集成签名、验签、加解密工具。
    *   (可选) 与风控系统对接，对高风险交易进行预警或拦截。

## 六、API接口设计指导原则

- **支付API**: (示例)
    - `POST /payments/transactions`: 创建支付交易，请求体包含业务订单ID、金额、支付渠道偏好等。返回预支付信息或重定向URL。
    - `GET /payments/transactions/{transaction_id}`: 查询支付交易详情。
    - `POST /payments/callbacks/{channel_code}`: 供支付网关调用的异步回调接口 (需严格验签和IP白名单)。
- **退款API**: (示例)
    - `POST /refunds/transactions`: 创建退款交易，请求体包含原支付交易ID、退款金额、原因等。
    - `GET /refunds/transactions/{refund_id}`: 查询退款交易详情。
    - `POST /refunds/callbacks/{channel_code}`: (如果渠道支持) 供支付网关调用的退款异步回调接口。
- **通用原则**: 接口设计应简洁明了，参数定义清晰。所有敏感操作需鉴权。返回信息包含明确的状态码和错误提示。

## 七、主要业务流程示例

### 1. 用户扫码支付流程 (以支付宝为例)
    1.  用户在商城选择商品，提交订单，订单服务创建业务订单，状态为"待支付"。
    2.  订单服务调用支付服务的 `POST /payments/transactions`接口，请求创建支付交易，参数包含业务订单ID、金额、渠道(ALIPAY_QR)。
    3.  支付服务：
        a.  创建支付交易记录 `PaymentTransaction`，状态为 `PENDING_CREATE`。
        b.  调用支付宝网关适配器，请求"统一收单下单并支付页面接口"。
        c.  支付宝返回二维码链接。
        d.  支付服务更新 `PaymentTransaction` 状态为 `PENDING_PAYMENT`，并将二维码链接（或预支付信息）返回给订单服务。
    4.  订单服务将二维码展示给用户。
    5.  用户使用支付宝App扫码支付。
    6.  支付宝处理支付，成功后通过HTTP POST异步通知支付服务配置的 `POST /payments/callbacks/alipay` 接口。
    7.  支付服务回调处理模块：
        a.  验证支付宝回调请求的签名和来源IP。
        b.  解析回调参数，获取支付结果（成功）、支付宝交易号、商户订单号（即支付服务内部`transaction_id`）。
        c.  根据 `transaction_id` 查找 `PaymentTransaction` 记录。
        d.  **幂等性检查**：如果该笔交易已是 `PAID_SUCCESS` 状态，则直接返回成功响应给支付宝，不再重复处理。
        e.  更新 `PaymentTransaction` 状态为 `PAID_SUCCESS`，记录支付宝交易号、支付时间等。
        f.  通知订单服务该笔支付已成功（可通过MQ或同步调用）。
        g.  向支付宝返回成功接收回调的响应 (如 "success")。
    8.  订单服务收到支付成功通知，更新业务订单状态为"已支付"，并进行后续发货等处理。

### 2. 发起并处理一笔退款
    1.  用户申请退款，或运营后台发起退款操作。
    2.  业务系统（如订单服务）调用支付服务的 `POST /refunds/transactions` 接口，请求创建退款，参数包含原支付`transaction_id`、退款金额、退款原因等。
    3.  支付服务：
        a.  校验原支付交易状态是否允许退款，退款金额是否合法。
        b.  创建退款交易记录 `RefundTransaction`，状态为 `PENDING`。
        c.  调用原支付渠道（如支付宝）的网关适配器，提交退款申请。
        d.  支付网关接受退款请求，返回处理中或成功/失败的同步响应。
        e.  支付服务根据同步响应更新 `RefundTransaction` 状态为 `PROCESSING` 或最终状态。
    4.  (若渠道有异步退款通知) 支付网关处理完退款后，异步通知支付服务的回调接口。
    5.  支付服务回调处理模块：
        a.  验签并解析退款结果。
        b.  根据退款流水号查找 `RefundTransaction`。
        c.  幂等性检查后，更新 `RefundTransaction` 最终状态（`SUCCESS` 或 `FAILED`）。
        d.  通知业务系统退款结果。

## 八、技术考量与开发注意事项

1.  **安全性是第一要务**: 严格遵守各支付渠道的安全规范。签名、验签、数据加密（特别是API密钥、证书等敏感配置）、防XSS/CSRF、HTTPS传输是标配。考虑敏感数据的加密存储。
2.  **幂等性设计**: 所有外部接口（特别是回调接口、创建支付/退款接口）必须保证幂等性，防止因网络重试或重复请求导致重复扣款或退款。
    *   常用方法：使用唯一的业务请求ID，在处理前检查该ID是否已处理过。
3.  **异步回调处理的可靠性**: 回调接口应设计为轻量级，快速响应支付网关。实际业务处理逻辑应通过消息队列 (MQ) 异步执行，保证即使回调处理失败也能通过MQ重试，不丢失通知。
4.  **交易状态一致性**: 仔细设计交易状态机。对于长时间未收到回调的"中间状态"交易，应有定时任务主动向支付网关查询，进行状态对齐（"掉单"处理）。
5.  **对账机制**: 每日与支付渠道进行对账是必须的，用于发现和处理金额不符、单边账、状态不一致等问题。对账应自动化。
6.  **错误处理与日志**: 详尽记录每一步操作日志、与网关的请求响应报文。错误信息应清晰具体，方便排查问题。定义规范的错误码体系。
7.  **退款流程复杂度**: 退款可能涉及原路退回、退到余额等多种方式。退款可能失败，需有相应处理机制。部分退款、多次退款的逻辑要考虑清楚。
8.  **手续费处理**: 如果涉及手续费，需明确由谁承担、如何计算和记录。
9.  **并发控制**: 在更新余额、扣减库存（如果支付服务也管理虚拟商品库存）等操作时，需考虑高并发场景，使用乐观锁、悲观锁或分布式锁。
10. **配置管理**: 支付渠道的配置（商户号、密钥、证书）非常敏感，需安全存储，并通过配置中心管理，支持动态更新。
11. **监控与告警**: 对支付成功率、失败率、回调处理延迟、对账差异、系统异常等关键指标进行实时监控，并设置告警。
12. **第三方SDK的封装与版本管理**: 谨慎选择和使用支付网关提供的SDK，注意其版本更新和潜在的兼容性问题。最好进行一层封装。
13. **测试**: 支付流程测试复杂，需要模拟支付网关行为的Mock Server或使用支付网关提供的沙箱环境进行充分测试。

## 九、数据校验与错误处理

1.  **请求参数校验**: 对所有入口参数进行严格校验（如金额格式与范围、币种、订单号存在性等）。
2.  **签名与验签**: 所有与支付网关的交互必须进行签名和验签。
3.  **状态校验**: 操作前检查交易的当前状态是否允许执行该操作（如已支付订单不能再发起支付）。
4.  **配置校验**: 检查支付渠道配置是否完整和有效。
5.  **明确的错误码和错误信息**: 定义统一的错误码体系，方便客户端和内部系统理解和处理错误。

## 十、安全性考量 (重点强调)

1.  **传输安全**: 所有涉及支付信息的网络通信必须使用HTTPS/TLS加密。
2.  **数据存储安全**: API密钥、私钥、证书等敏感配置信息必须加密存储，严格控制访问权限。不应明文存储用户完整的银行卡号、CVV码等（如需处理，应符合PCI DSS要求）。
3.  **防API滥用与攻击**: 对外暴露的API接口（如创建支付、回调）需进行速率限制、IP白名单（回调）、防刷等措施。
4.  **防伪造回调**: 严格校验回调请求的签名、来源IP、以及请求参数中的商户ID等信息是否与配置一致。
5.  **防交易篡改**: 关键金额、订单号等信息在生成签名时必须包含在内，防止中间人篡改。
6.  **操作审计**: 对所有敏感操作（如发起支付、退款、修改配置）记录详细审计日志。
7.  **内部权限控制**: 严格控制内部系统和运营人员对支付服务接口和数据的访问权限。
8.  **依赖安全**: 保持第三方SDK和库更新到最新安全版本。

## 十一、合规性与认证 (可选)

-   根据业务所在地和目标市场，可能需要遵守特定的金融法规和数据保护条例（如GDPR, CCPA）。
-   如果处理信用卡信息，可能需要符合支付卡行业数据安全标准 (PCI DSS)。即使通过第三方支付网关处理，也应了解自身的合规责任范围。

## 相关前端UI图片

以下是与支付服务功能相关的部分前端UI截图，帮助理解后端功能在前端界面的展现：

### 我的 - 订单支付页面 (示意图)

![我的](4、前端/UI/我的.png)

### 支付成功/失败页面 (示意图)

![订单-支付成功.png](4、前端/UI/订单-支付成功.png) 