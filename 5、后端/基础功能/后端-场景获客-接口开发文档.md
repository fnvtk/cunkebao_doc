# 场景化获客模块后端开发指南

## 一、引言与目标

### 1.1 模块定位
场景化获客模块是企业私域流量运营和客户关系管理 (CRM) 的前端入口，旨在通过多样化的内外部渠道和互动场景，高效捕获潜在客户线索，并将其转化为可跟进、可培育的客户资产。本模块是连接公域流量与私域运营的关键桥梁。

### 1.2 核心价值
- **拓宽获客渠道**: 支持线上线下多种获客方式，最大化线索来源。
- **提升线索质量**: 通过场景化互动和初步筛选，提高线索的有效性和意向度。
- **自动化处理**: 实现线索的自动记录、分类、打标和分配，提升运营效率。
- **数据驱动决策**: 统一收集和分析各渠道获客数据，为优化获客策略提供依据。
- **无缝客户旅程**: 将新获取的线索顺畅导入CRM或销售流程，开始客户培育和转化。

### 1.3 设计目标
- **多场景适配**: 灵活支持并可快速扩展新的获客场景（如电话、订单、社交平台、内容互动、线下活动、API对接等）。
- **配置驱动**: 核心业务逻辑（如线索处理规则、标签规则、分配规则）应高度可配置。
- **智能化**: 具备一定的智能处理能力，如自动客户识别、智能打标、智能分配。
- **高可用与可伸缩**: 保证在高并发线索涌入时系统的稳定性和处理能力。
- **数据准确与一致**: 确保线索数据和客户信息的准确性，以及在各系统间的一致性。
- **安全性**: 保护用户数据和接入凭证的安全，防止数据泄露和未授权访问。
- **易集成性**: 提供标准化的接口，方便与内部其他系统（CRM、营销自动化、数据分析平台）和外部第三方应用集成。

## 二、模块概述

本模块负责统一管理和处理来自各种内外部渠道的潜在客户线索。它包括：获客场景的定义与配置，线索数据的接收与标准化，潜在客户与已有客户的识别与关联，基于规则的自动标签，以及将线索智能分配给相应的销售团队或处理流程。此外，模块还需提供各场景和渠道获客效果的统计分析能力。

## 三、核心概念

- **线索 (Lead)**: 代表一个潜在的销售机会或一个对产品/服务表现出兴趣的个体/组织信息。通常包含联系方式和初步需求信息。
- **客户 (Customer/Contact/Account)**: 已建立联系或已成交的个体/组织。新线索可能转化为新客户，或关联到已有客户。
- **获客场景 (Acquisition Scene)**: 线索产生的具体业务情境或互动方式。例如：客服电话呼入、在线表单提交、电商平台订单同步、社交媒体广告互动、内容下载、扫码关注、会议注册、API导入等。
- **渠道 (Channel)**: 线索的来源媒介或平台。例如：官方网站、搜索引擎、微信公众号、抖音、小红书、合作伙伴、线下门店等。
- **场景配置 (Scene Configuration)**: 针对特定获客场景的参数设置，包括数据解析规则、处理流程、自动标签规则、分配规则等。
- **标签 (Tag)**: 用于描述线索或客户特征的关键词或分类。可以是手动添加或自动生成。
- **分配规则 (Assignment Rule)**: 将线索分配给特定用户、团队或处理队列的逻辑。可以是轮询、随机、基于权重、基于地理区域、基于线索属性等。
- **自动化处理 (Automation)**: 在线索进入系统后，根据预设规则自动执行的一系列操作，如数据清洗、信息丰富、打标签、分配、发送初步响应等。
- **Webhook/回调**: 外部系统在产生符合条件的线索时，主动向本模块推送数据的机制。

## 四、核心数据实体/模型

1.  **线索 (Lead)**
    *   `lead_id` (主键): 线索唯一标识符。
    *   `source_channel_id` (外键, 可选): 来源渠道ID。
    *   `acquisition_scene_id` (外键, 可选): 关联的获客场景配置ID。
    *   `external_lead_id` (字符串, 可选): 外部系统中的线索ID。
    *   `status` (枚举: NEW, QUALIFIED, DISQUALIFIED, ASSIGNED, PROCESSING, CONVERTED, CLOSED): 线索状态。
    *   `lead_data` (JSON/结构化数据, 必填): 线索的核心信息，通常包含联系方式（电话、邮箱、社交账号）、姓名、公司、需求描述、来源URL等。具体字段可能因场景而异。
    *   `raw_data` (文本/JSON, 可选): 接收到的原始线索数据，用于追溯和调试。
    *   `assigned_to_user_id` (外键, 可选): 被分配处理的用户ID。
    *   `assigned_to_team_id` (外键, 可选): 被分配处理的团队ID。
    *   `assignment_time` (时间戳, 可选): 分配时间。
    *   `tags` (数组/关联表, 可选): 线索关联的标签列表。
    *   `notes` (文本, 可选): 跟进备注。
    *   `created_at` (时间戳): 线索创建时间。
    *   `updated_at` (时间戳): 线索最后更新时间。
    *   `related_customer_id` (外键, 可选): 关联到的客户ID（如果已识别或转化）。

2.  **客户 (Customer)** (通常由CRM模块核心管理，此处为简化关联模型)
    *   `customer_id` (主键): 客户唯一标识符。
    *   `name` (字符串, 可选): 客户名称。
    *   `contact_info` (JSON): 主要联系方式（电话、邮箱等）。
    *   `tags` (数组/关联表, 可选): 客户标签。
    *   `created_at`, `updated_at` (时间戳)。

3.  **获客场景配置 (AcquisitionSceneConfiguration)**
    *   `scene_config_id` (主键): 场景配置唯一标识符。
    *   `scene_name` (字符串, 必填): 场景名称 (如 "官网产品咨询表单", "抖音广告线索")。
    *   `scene_type` (枚举, 必填): 场景类型 (e.g., PHONE_CALL, WEB_FORM, ORDER_SYNC, SOCIAL_MEDIA_LEAD, API_IMPORT, QR_CODE_SCAN)。
    *   `is_enabled` (布尔, 默认: true): 此场景是否启用。
    *   `source_channel_default_id` (外键, 可选): 此场景默认关联的渠道ID。
    *   `scene_specific_params` (JSON, 可选): 特定场景所需的配置参数（如表单ID、API端点密钥、Webhook验证Token、监控的电话号码、订单平台标识等）。
    *   `data_mapping_rules` (JSON, 可选): 定义如何从原始输入数据映射到标准线索字段的规则。
    *   `auto_tagging_rules` (JSON, 可选): 自动为通过此场景进入的线索打标签的规则列表。每个规则包含条件和要应用的标签。
    *   `assignment_rules` (JSON, 可选): 线索分配规则配置（如轮询用户列表、按区域分配等）。
    *   `auto_response_config` (JSON, 可选): 自动回复配置（如邮件/短信模板ID）。
    *   `deduplication_strategy` (枚举, 可选): 线索去重策略 (e.g., NO_CHECK, BY_PHONE, BY_EMAIL, BY_PHONE_OR_EMAIL)。
    *   `created_at`, `updated_at` (时间戳)。

4.  **渠道定义 (ChannelDefinition)**
    *   `channel_id` (主键): 渠道唯一标识符。
    *   `name` (字符串, 必填): 渠道名称 (如 "百度推广", "微信自然流量", "销售自开拓")。
    *   `channel_type` (枚举, 可选): 渠道类型 (如 PAID_SEARCH, ORGANIC_SOCIAL, REFERRAL, OFFLINE_EVENT)。
    *   `is_active` (布尔, 默认: true): 渠道是否启用。

5.  **标签定义 (TagDefinition)** (可复用通用标签模块的实体)
    *   `tag_id` (主键): 标签唯一标识符。
    *   `name` (字符串, 必填, 唯一): 标签名称。
    *   `tag_group` (字符串, 可选): 标签分组。

6.  **线索处理/分配日志 (LeadProcessingLog / LeadAssignmentLog)**
    *   记录线索被处理（如打标、分配）的详细历史。

## 五、功能模块划分

1.  **多渠道线索接入模块**
    *   **API接入**: 提供标准化的RESTful API接口，供外部系统（如网站表单后端、第三方工具）主动推送线索数据。
    *   **Webhook处理器**: 接收并验证来自各类平台（如社交媒体广告、在线表单工具、支付网关订单通知）的Webhook/回调请求。
    *   **特定场景适配器**: (概念上) 为不同的获客场景（如电话系统集成、邮件抓取、订单数据同步任务）提供数据接入和初步解析逻辑。
    *   **文件导入**: 支持通过CSV/Excel等格式批量导入线索。
2.  **线索标准化与丰富化模块**
    *   根据场景配置中的`data_mapping_rules`，将不同来源和格式的原始数据转换为统一的内部线索数据结构。
    *   (可选) 数据清洗：格式化电话号码、邮箱，修正常见错误。
    *   (可选) 信息丰富：通过IP地址查询地理位置，通过公司名称查询企业信息等（可能需要集成第三方数据服务）。
3.  **客户识别与关联模块**
    *   根据线索中的关键信息（如手机号、邮箱、公司名、社交账号等）和预设的`deduplication_strategy`，在现有客户库中查找是否已存在该潜在客户。
    *   如果匹配到已有客户，则将新线索与该客户关联，并可能触发更新客户信息或通知客户负责人。
    *   如果未匹配到，则可选择创建新的潜在客户记录。
4.  **自动化标签模块**
    *   根据场景配置中的`auto_tagging_rules`以及线索内容，自动为线索打上相应的标签（如意向度、产品偏好、来源场景等）。
    *   规则可以基于关键词、数值范围、来源等条件。
5.  **线索智能分配模块**
    *   根据场景配置中的`assignment_rules`，将符合条件的线索自动分配给合适的销售人员、销售团队或处理队列。
    *   支持多种分配策略：轮询、随机、按负载、按区域、按技能标签、按线索价值等。
    *   记录分配历史。
6.  **场景与规则配置管理模块**
    *   提供UI界面或API，供管理员创建和管理获客场景、数据映射规则、标签规则、分配规则等。
    *   配置版本控制与审批流程 (可选)。
7.  **线索处理与跟进支持模块**
    *   提供API供CRM或销售工具查询、更新线索状态和跟进记录。
    *   (可选) 触发自动化的初步响应（如发送欢迎邮件/短信，创建任务提醒）。
8.  **数据统计与分析模块**
    *   统计各获客场景、渠道的线索数量、转化率、成本等关键指标。
    *   分析线索质量和分配效率。
    *   提供报表和API接口供数据分析使用。

## 六、API接口设计指导原则

### 6.1 通用原则
- **RESTful设计**: 使用标准的HTTP方法 (POST, GET, PUT, DELETE)。
- **统一数据格式**: 请求和响应主体主要使用JSON。
- **版本控制**: API应进行版本化 (如 `/api/v1/...`)。
- **认证与授权**: 所有接口（特别是写操作和配置接口）都必须经过严格的认证和授权。
- **幂等性**: 对于创建或可能重复调用的接口（如Webhook接收），需考虑幂等性设计。
- **标准化响应**: 包括HTTP状态码、统一的成功/错误响应结构（包含错误码、消息）。
- **分页与筛选**: 对于列表查询接口，必须支持分页、排序和多条件筛选。
- **异步处理提示**: 对于耗时较长的操作（如批量导入），应采用异步处理，并立即返回受理状态，后续通过回调或查询接口获取结果。

### 6.2 核心API示例 (概念性)

1.  **接收线索 (通用入口)**
    *   **路径**: `POST /leads/ingestions`
    *   **说明**: 接收来自各种渠道的线索，通过参数或请求头指定场景类型或场景配置ID。
    *   **请求体**: 包含原始线索数据，结构可能因场景而异，但应有可识别场景的字段。
        ```json
        {
          "scene_type": "WEB_FORM", // 或 scene_config_id: "config_xyz"
          "form_id": "contact_us_form_v1",
          "submission_data": {
            "name": "张三",
            "email": "zhangsan@example.com",
            "phone": "13800138000",
            "company": "某某公司",
            "message": "对产品A感兴趣，希望了解详情。"
          },
          "meta": {
            "ip_address": "192.168.1.100",
            "user_agent": "Mozilla/5.0...",
            "submission_url": "https://example.com/contact"
    }
}
```
    *   **响应**: 受理成功 (HTTP 202 Accepted) 或校验失败 (HTTP 400 Bad Request)。

2.  **特定场景Webhook接收** (为每个需要Webhook的场景类型定义独立端点)
    *   **路径**: `POST /webhooks/{scene_type}` (e.g., `/webhooks/douyin_leads`, `/webhooks/order_notifications`)
    *   **说明**: 接收特定第三方平台推送的数据。需实现签名验证和数据解析适配。
    *   **请求体**: 由第三方平台定义。
    *   **响应**: 遵循第三方平台要求的响应格式。

3.  **查询线索列表**
    *   **路径**: `GET /leads`
    *   **参数**: `status`, `channel_id`, `scene_config_id`, `assigned_to_user_id`, `start_date`, `end_date`, `tags_contain_any`, `page`, `size`, `sort_by`, `sort_order`等。
    *   **响应**: 分页的线索列表。

4.  **获取线索详情**
    *   **路径**: `GET /leads/{lead_id}`

5.  **更新线索信息/状态**
    *   **路径**: `PUT /leads/{lead_id}`
    *   **请求体**: 包含要更新的字段 (如状态、备注、关联客户ID)。

6.  **手动分配/重新分配线索**
    *   **路径**: `POST /leads/{lead_id}/assign`
    *   **请求体**: `{"user_id": "user_abc"}` 或 `{"team_id": "team_xyz"}`。

7.  **场景配置管理API**
    *   `POST /scenes/configurations`: 创建新的场景配置。
    *   `GET /scenes/configurations`: 获取场景配置列表。
    *   `GET /scenes/configurations/{scene_config_id}`: 获取特定场景配置。
    *   `PUT /scenes/configurations/{scene_config_id}`: 更新场景配置。
    *   `DELETE /scenes/configurations/{scene_config_id}`: 删除场景配置。

## 七、关键业务流程示例

### 1. 处理网站表单提交的线索
    1.  用户在网站填写并提交咨询表单。
    2.  网站后端服务收集表单数据，并调用场景获客模块的 `POST /leads/ingestions` 接口，指定 `scene_type="WEB_FORM"` 和表单相关信息。
    3.  **线索接入与标准化**: 模块接收数据，根据预设的"官网表单"场景配置，将表单字段映射到标准线索字段。
    4.  **客户识别**: 使用线索中的邮箱和手机号，在客户库中查找是否已存在该客户。
        *   若存在，则将此线索与老客户关联。
        *   若不存在，标记为新潜客。
    5.  **自动打标**: 根据表单内容（如咨询的产品类别、问题关键词），应用标签规则，为线索打上"产品A意向"、"价格咨询"等标签。
    6.  **智能分配**: 根据标签（如产品线）和预设的分配规则（如按产品线分配给不同销售组），将线索分配给相应销售人员。
    7.  **通知与后续**: (可选) 向被分配的销售发送新线索提醒；(可选) 向提交表单的用户发送自动感谢邮件。
    8.  记录所有处理步骤到日志。

### 2. 通过订单同步获客
    1.  配置一个"电商平台订单同步"场景 (`scene_type="ORDER_SYNC"`)。
        *   `scene_specific_params`包含电商平台API的凭证、查询订单的端点等。
        *   `data_mapping_rules`定义如何从订单数据提取客户信息（姓名、电话、地址）和购买信息。
        *   `auto_tagging_rules`可基于购买商品、金额等打标（如"已购用户"、"高价值订单"）。
        *   `assignment_rules`可将新客户分配给客服或特定销售跟进。
    2.  定时任务或消息触发，调用电商平台API拉取新订单数据。
    3.  对于每条新订单：
        a.  适配器解析订单数据。
        b.  调用 `POST /leads/ingestions` 接口，传入解析后的订单数据和场景信息。
        c.  后续流程同表单提交线索，进行客户识别、打标、分配。

### 3. 电话呼入线索处理
    1.  集成电话系统 (CTI)。当有电话呼入分配给销售座席的号码时，电话系统将来电信息（主叫号码、被叫号码、呼叫时间等）通过API实时推送给场景获客模块（或本模块主动轮询CTI接口）。
    2.  配置一个"销售电话呼入"场景 (`scene_type="PHONE_CALL"`)。
    3.  模块接收到来电信息，立即创建一条线索，状态为"通话中"或"待处理"，并尝试根据主叫号码关联已有客户或销售人员（如果可以识别）。
    4.  通话结束后，销售人员在CRM或对接的工具中补充通话摘要、意向度等信息，这些信息可同步更新到线索记录中。
    5.  根据通话结果和补充信息，触发后续的打标和分配（如果初次分配不明确或需调整）。

## 八、技术考量与开发注意事项

1.  **场景适配器设计**: 针对不同获客场景（特别是需要主动拉取数据或有复杂交互的场景，如社交媒体、电话系统），设计可插拔的适配器/插件机制，方便扩展。
2.  **线索去重与合并逻辑**: 设计灵活的去重规则（可按场景配置），并考虑在发现重复线索时的数据合并策略。
3.  **规则引擎**: 对于复杂的自动打标和分配规则，可以考虑引入轻量级规则引擎，或设计易于扩展的规则判断逻辑。
4.  **与核心系统的集成**: 
    *   **CRM集成**: 与CRM系统紧密双向同步线索和客户数据、跟进状态。
    *   **用户中心集成**: 识别和关联平台已有注册用户。
    *   **营销自动化集成**: 将符合条件的线索推送到营销自动化流程进行培育。
5.  **高并发线索处理**: 对于可能产生大量并发线索的场景（如大型营销活动、API批量导入），需确保接入层、处理层的高性能和可伸缩性。可采用消息队列进行削峰填谷和异步处理。
6.  **数据一致性**: 保证线索在创建、分配、转化各阶段状态的一致性。若涉及分布式事务，需谨慎处理。
7.  **配置灵活性与热加载**: 场景配置（特别是规则类配置）应尽可能支持动态修改并实时生效，避免重启服务。
8.  **监控与告警**: 监控各场景线索接入量、处理成功率、队列积压情况、规则执行异常等，并设置告警。
9.  **可测试性**: 模块各部分（特别是规则逻辑、场景适配器）应易于单元测试和集成测试。

## 九、数据校验与错误处理

1.  **输入数据校验**: 对所有外部传入的线索数据进行基础格式校验（如手机号、邮箱格式）。对特定场景的必填字段进行校验。
2.  **Webhook/回调验签**: 接收第三方平台推送数据时，必须严格校验签名或Token，确保数据来源可靠。
3.  **配置数据校验**: 管理员在配置场景规则时，进行逻辑校验（如分配用户是否存在、标签是否有效）。
4.  **依赖服务异常处理**: 调用外部服务（如CRM、电话系统API）失败时，有重试和降级机制。
5.  **规则执行异常**: 规则引擎或自定义规则执行出错时，记录详细错误信息，并有通知机制，避免影响主流程。
6.  **死信队列**: 对于无法处理的线索消息或Webhook通知，应转入死信队列，供人工排查和处理。

## 十、安全性考量

1.  **API认证与授权**: 所有API接口（特别是配置类接口和接收线索的写接口）必须有严格的认证机制（如API Key/Secret, OAuth2）。细化权限控制，不同调用方只能访问其授权的资源和操作。
2.  **Webhook安全**: 
    *   使用HTTPS确保传输安全。
    *   对回调请求进行签名验证 (如使用HMAC-SHA256) 防止伪造和篡改。
    *   (可选) 限制回调来源IP地址。
3.  **敏感数据处理**: 
    *   线索中可能包含用户个人敏感信息，存储和传输时需符合数据保护法规（如加密存储电话、邮箱等）。
    *   在日志和监控中避免直接暴露原始敏感数据，进行脱敏处理。
4.  **防数据泄露**: 控制对线索数据库的直接访问权限。数据导出功能需有审批和审计。
5.  **防范恶意提交与攻击**: 
    *   对公开的线索提交通道（如网站表单对应的接收API）进行速率限制、防机器人提交（如验证码）。
    *   输入清理，防止XSS、SQL注入等攻击（虽然现代框架有防护，但仍需注意自定义解析逻辑）。
6.  **凭证管理**: 安全存储和使用访问第三方平台（如社交媒体API、订单平台API）所需的凭证，遵循最小权限原则。

---
> 本文档为场景化获客模块提供后端设计指导，旨在构建一个灵活、高效、可扩展的线索捕获与处理中心。具体实现细节需根据业务需求和技术选型进行调整。 