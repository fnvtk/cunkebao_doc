# æ ¸å¿ƒç®—æ³•ä¸ä»·å€¼åŠŸèƒ½

> ğŸ“… æœ€åæ›´æ–°ï¼š2026-01-11
> ğŸ“‹ å­˜å®¢å®ç³»ç»Ÿæœ€æœ‰ä»·å€¼çš„æ ¸å¿ƒç®—æ³•å’ŒåŠŸèƒ½æ¨¡å—

---

## ğŸ“Š ç›®å½•

1. [å¥åº·åˆ†è¯„ä¼°ç®—æ³•](#ä¸€å¥åº·åˆ†è¯„ä¼°ç®—æ³•)
2. [RFMå®¢æˆ·ä»·å€¼è¯„åˆ†ç®—æ³•](#äºŒrfmå®¢æˆ·ä»·å€¼è¯„åˆ†ç®—æ³•)
3. [æµé‡åˆ†å‘ç®—æ³•](#ä¸‰æµé‡åˆ†å‘ç®—æ³•)
4. [åˆ†é”€å¥–åŠ±è®¡ç®—ç®—æ³•](#å››åˆ†é”€å¥–åŠ±è®¡ç®—ç®—æ³•)
5. [æ¶ˆæ¯ç¾¤å‘è°ƒåº¦ç®—æ³•](#äº”æ¶ˆæ¯ç¾¤å‘è°ƒåº¦ç®—æ³•)
6. [è‡ªåŠ¨å»ºç¾¤ç®—æ³•](#å…­è‡ªåŠ¨å»ºç¾¤ç®—æ³•)

---

## ä¸€ã€å¥åº·åˆ†è¯„ä¼°ç®—æ³•

### 1.1 ç®—æ³•æ¦‚è¿°

å¥åº·åˆ†æ˜¯å­˜å®¢å®ç³»ç»Ÿçš„**æ ¸å¿ƒé£æ§ç®—æ³•**ï¼Œç”¨äºè¯„ä¼°å¾®ä¿¡è´¦å·çš„å®‰å…¨çŠ¶æ€ï¼Œæ§åˆ¶æ¯æ—¥æ·»åŠ å¥½å‹çš„æ•°é‡ä¸Šé™ã€‚

**æ ¸å¿ƒå…¬å¼**ï¼š
```
å¥åº·åˆ† = åŸºç¡€åˆ† + åŠ¨æ€åˆ†
æ¯æ—¥æœ€å¤§åŠ äººæ¬¡æ•° = å¥åº·åˆ† Ã— 0.2
```

### 1.2 åŸºç¡€åˆ†è®¡ç®— (60-100åˆ†)

```php
/**
 * åŸºç¡€åˆ† = é»˜è®¤åŸºç¡€åˆ†(60) + åŸºç¡€ä¿¡æ¯åˆ†(10) + å¥½å‹æ•°é‡åˆ†(30)
 */
private function calculateBaseScore($accountData, $scoreRecord = [])
{
    $baseScore = 60; // é»˜è®¤åŸºç¡€åˆ†
    
    // 1. åŸºç¡€ä¿¡æ¯åˆ†ï¼ˆå·²ä¿®æ”¹å¾®ä¿¡å·å¾—10åˆ†ï¼‰
    $baseInfoScore = $this->getBaseInfoScore($accountData);
    $baseScore += $baseInfoScore;
    
    // 2. å¥½å‹æ•°é‡åˆ†ï¼ˆæœ€é«˜30åˆ†ï¼‰
    $friendCountScore = $this->getFriendCountScore($accountData['totalFriend']);
    $baseScore += $friendCountScore;
    
    return $baseScore;
}

/**
 * å¥½å‹æ•°é‡è¯„åˆ†è§„åˆ™
 */
private function getFriendCountScore($totalFriend)
{
    if ($totalFriend >= 3001) return 12;      // 3001+ å¥½å‹
    if ($totalFriend >= 501)  return 8;       // 501-3000 å¥½å‹
    if ($totalFriend >= 51)   return 6;       // 51-500 å¥½å‹
    if ($totalFriend >= 0)    return 3;       // 0-50 å¥½å‹
    return 0;
}
```

### 1.3 åŠ¨æ€åˆ†è®¡ç®—

```php
/**
 * åŠ¨æ€åˆ† = é¢‘ç¹æ‰£åˆ† + å°å·æ‰£åˆ† + ä¸é¢‘ç¹åŠ åˆ†
 */
private function calculateDynamicScore($accountData, $scoreRecord)
{
    $result = [
        'total' => 0,
        'frequentPenalty' => 0,    // é¢‘ç¹æ‰£åˆ†
        'noFrequentBonus' => 0,    // ä¸é¢‘ç¹åŠ åˆ†
        'banPenalty' => 0,         // å°å·æ‰£åˆ†
    ];
    
    // 1. æ£€æŸ¥é¢‘ç¹è®°å½•æ‰£åˆ†
    // é¦–æ¬¡é¢‘ç¹: -15åˆ†ï¼Œæš‚åœ24å°æ—¶
    // å†æ¬¡é¢‘ç¹: -25åˆ†ï¼Œæš‚åœ24å°æ—¶
    $frequentData = $this->checkFrequentFromFriendTask($accountId, $wechatId);
    $result['frequentPenalty'] = $frequentData['frequentPenalty'];
    
    // 2. æ£€æŸ¥å°å·è®°å½•æ‰£åˆ†
    // å°å·: -60åˆ†ï¼Œæš‚åœ72å°æ—¶
    $banData = $this->checkBannedFromMessage($accountId, $wechatId);
    $result['banPenalty'] = $banData['banPenalty'];
    
    // 3. è®¡ç®—ä¸é¢‘ç¹åŠ åˆ†
    // è¿ç»­3å¤©ä¸è§¦å‘é¢‘ç¹: +5åˆ†/å¤©
    $noFrequentData = $this->calculateNoFrequentBonus($accountId, $wechatId);
    $result['noFrequentBonus'] = $noFrequentData['bonus'];
    
    // æ€»åˆ†è®¡ç®—
    $result['total'] = $result['frequentPenalty'] + 
                       $result['noFrequentBonus'] + 
                       $result['banPenalty'];
    
    return $result;
}
```

### 1.4 è¯„åˆ†è§„åˆ™è¡¨

| åœºæ™¯ | åˆ†æ•°å˜åŒ– | å¤„ç½šæªæ–½ |
|------|----------|----------|
| **åŸºç¡€åˆ†** | | |
| é»˜è®¤åŸºç¡€åˆ† | +60 | - |
| å·²ä¿®æ”¹å¾®ä¿¡å· | +10 | - |
| å¥½å‹ 0-50 | +3 | - |
| å¥½å‹ 51-500 | +6 | - |
| å¥½å‹ 501-3000 | +8 | - |
| å¥½å‹ 3001+ | +12 | - |
| **åŠ¨æ€åˆ†** | | |
| é¦–æ¬¡é¢‘ç¹ | -15 | æš‚åœ24å°æ—¶ |
| å†æ¬¡é¢‘ç¹ | -25 | æš‚åœ24å°æ—¶ |
| å°å· | -60 | æš‚åœ72å°æ—¶ |
| è¿ç»­3å¤©ä¸é¢‘ç¹ | +5/å¤© | - |

### 1.5 ç®—æ³•ä»·å€¼

- **é£é™©æ§åˆ¶**ï¼šè‡ªåŠ¨é™åˆ¶é«˜é£é™©è´¦å·çš„æ“ä½œé¢‘ç‡
- **è´¦å·ä¿æŠ¤**ï¼šé¿å…è´¦å·è¢«å°ç¦
- **æ™ºèƒ½è°ƒèŠ‚**ï¼šæ ¹æ®è´¦å·çŠ¶æ€åŠ¨æ€è°ƒæ•´é™åˆ¶

---

## äºŒã€RFMå®¢æˆ·ä»·å€¼è¯„åˆ†ç®—æ³•

### 2.1 ç®—æ³•æ¦‚è¿°

RFMï¼ˆRecency-Frequency-Monetaryï¼‰æ˜¯ç»å…¸çš„å®¢æˆ·ä»·å€¼è¯„åˆ†æ¨¡å‹ï¼Œç”¨äºè¯†åˆ«é«˜ä»·å€¼å®¢æˆ·ã€‚

**ä¸‰ä¸ªç»´åº¦**ï¼š
- **R (Recency)**ï¼šæœ€è¿‘æ¶ˆè´¹æ—¶é—´ - æ—¶é—´è¶Šè¿‘ï¼Œå¾—åˆ†è¶Šé«˜
- **F (Frequency)**ï¼šæ¶ˆè´¹é¢‘ç‡ - æ¬¡æ•°è¶Šå¤šï¼Œå¾—åˆ†è¶Šé«˜
- **M (Monetary)**ï¼šæ¶ˆè´¹é‡‘é¢ - é‡‘é¢è¶Šé«˜ï¼Œå¾—åˆ†è¶Šé«˜

### 2.2 æ ¸å¿ƒç®—æ³•

```php
/**
 * RFM è¯„åˆ†è®¡ç®—ï¼ˆäº”åˆ†ä½æ³•ï¼‰
 * 
 * @param int $recencyDays æœ€è¿‘è´­ä¹°å¤©æ•°
 * @param int $frequency è´­ä¹°æ¬¡æ•°
 * @param float $monetary è´­ä¹°é‡‘é¢
 * @param array $weights æƒé‡é…ç½® [R, F, M]
 * @return array
 */
public function calculateRFMScore($recencyDays, $frequency, $monetary, $weights = [0.4, 0.3, 0.3])
{
    // 1. è®¡ç®—å„ç»´åº¦åˆ†æ•° (1-5åˆ†)
    $rScore = $this->scoreR($recencyDays);
    $fScore = $this->scoreF($frequency);
    $mScore = $this->scoreM($monetary);
    
    // 2. è®¡ç®—åŠ æƒæ€»åˆ†
    $rfmScore = $rScore * $weights[0] + 
                $fScore * $weights[1] + 
                $mScore * $weights[2];
    
    // 3. æ ‡å‡†åŒ–ä¸º1-100åˆ†
    $rfmMin = $weights[0] * 1 + $weights[1] * 1 + $weights[2] * 1;
    $rfmMax = $weights[0] * 5 + $weights[1] * 5 + $weights[2] * 5;
    $standardScore = round(($rfmScore - $rfmMin) / ($rfmMax - $rfmMin) * 99 + 1);
    
    return [
        'R' => $rScore,
        'F' => $fScore,
        'M' => $mScore,
        'rfmScore' => $rfmScore,
        'standardScore' => $standardScore
    ];
}

/**
 * Rç»´åº¦è¯„åˆ†ï¼ˆæ—¶é—´è¶Šè¿‘åˆ†æ•°è¶Šé«˜ï¼‰
 */
protected function scoreR($days)
{
    if ($days <= 30)  return 5;  // 1ä¸ªæœˆå†…
    if ($days <= 60)  return 4;  // 2ä¸ªæœˆå†…
    if ($days <= 90)  return 3;  // 3ä¸ªæœˆå†…
    if ($days <= 120) return 2;  // 4ä¸ªæœˆå†…
    return 1;                    // è¶…è¿‡4ä¸ªæœˆ
}

/**
 * Fç»´åº¦è¯„åˆ†ï¼ˆæ¬¡æ•°è¶Šå¤šåˆ†æ•°è¶Šé«˜ï¼‰
 */
protected function scoreF($times)
{
    if ($times >= 10) return 5;  // 10æ¬¡ä»¥ä¸Š
    if ($times >= 6)  return 4;  // 6-9æ¬¡
    if ($times >= 3)  return 3;  // 3-5æ¬¡
    if ($times >= 2)  return 2;  // 2æ¬¡
    if ($times >= 1)  return 1;  // 1æ¬¡
    return 0;                    // 0æ¬¡
}

/**
 * Mç»´åº¦è¯„åˆ†ï¼ˆé‡‘é¢è¶Šé«˜åˆ†æ•°è¶Šé«˜ï¼‰
 */
protected function scoreM($amount)
{
    if ($amount >= 2000) return 5;  // 2000+
    if ($amount >= 1000) return 4;  // 1000-1999
    if ($amount >= 500)  return 3;  // 500-999
    if ($amount >= 200)  return 2;  // 200-499
    if ($amount > 0)     return 1;  // 1-199
    return 0;                       // 0
}
```

### 2.3 äº”åˆ†ä½æ³•åŠ¨æ€è®¡ç®—

```php
/**
 * ä½¿ç”¨äº”åˆ†ä½æ³•è®¡ç®—é˜ˆå€¼ï¼ˆåŸºäºæ•°æ®åˆ†å¸ƒï¼‰
 * 
 * @param array $values æ•°å€¼æ•°ç»„
 * @param bool $reverse æ˜¯å¦åå‘ï¼ˆRç»´åº¦éœ€è¦åå‘ï¼‰
 * @return array è¿”å›[0.2, 0.4, 0.6, 0.8]åˆ†ä½æ•°çš„é˜ˆå€¼
 */
private function calculatePercentiles($values, $reverse = false)
{
    sort($values);
    $count = count($values);
    
    $percentiles = [0.2, 0.4, 0.6, 0.8];
    $thresholds = [];
    
    foreach ($percentiles as $p) {
        $index = (int)ceil($count * $p) - 1;
        $thresholds[] = $values[max(0, $index)];
    }
    
    return $reverse ? array_reverse($thresholds) : $thresholds;
}

/**
 * æ ¹æ®åˆ†ä½æ•°é˜ˆå€¼è¯„åˆ†
 */
private function scoreByPercentile($value, $thresholds, $reverse = false)
{
    if ($reverse) {
        // Rç»´åº¦ï¼šå€¼è¶Šå°åˆ†æ•°è¶Šé«˜
        if ($value <= $thresholds[0]) return 5;
        if ($value <= $thresholds[1]) return 4;
        if ($value <= $thresholds[2]) return 3;
        if ($value <= $thresholds[3]) return 2;
        return 1;
    } else {
        // F/Mç»´åº¦ï¼šå€¼è¶Šå¤§åˆ†æ•°è¶Šé«˜
        if ($value >= $thresholds[3]) return 5;
        if ($value >= $thresholds[2]) return 4;
        if ($value >= $thresholds[1]) return 3;
        if ($value >= $thresholds[0]) return 2;
        return 1;
    }
}
```

### 2.4 å®¢æˆ·åˆ†å±‚

| RFMåˆ†æ•° | å®¢æˆ·ç­‰çº§ | è¿è¥ç­–ç•¥ |
|---------|----------|----------|
| 90-100 | é‡è¦ä»·å€¼å®¢æˆ· | VIPæœåŠ¡ï¼Œä¸“å±ä¼˜æƒ  |
| 70-89 | é‡è¦å‘å±•å®¢æˆ· | æå‡æ¶ˆè´¹é¢‘æ¬¡ |
| 50-69 | ä¸€èˆ¬ä»·å€¼å®¢æˆ· | å¸¸è§„ç»´æŠ¤ |
| 30-49 | ä¸€èˆ¬å‘å±•å®¢æˆ· | æ¿€æ´»æ¶ˆè´¹ |
| 1-29 | æµå¤±é£é™©å®¢æˆ· | æŒ½å›ç­–ç•¥ |

### 2.5 ç®—æ³•ä»·å€¼

- **ç²¾å‡†è¥é”€**ï¼šè¯†åˆ«é«˜ä»·å€¼å®¢æˆ·ï¼Œç²¾å‡†æŠ•æ”¾
- **èµ„æºä¼˜åŒ–**ï¼šåˆç†åˆ†é…è¿è¥èµ„æº
- **æµå¤±é¢„è­¦**ï¼šæå‰å‘ç°æµå¤±é£é™©å®¢æˆ·

---

## ä¸‰ã€æµé‡åˆ†å‘ç®—æ³•

### 3.1 ç®—æ³•æ¦‚è¿°

æµé‡åˆ†å‘ç®—æ³•ç”¨äºå°†æ–°è·å–çš„å®¢æˆ·ï¼ˆå¥½å‹ï¼‰è‡ªåŠ¨åˆ†é…ç»™å®¢æœäººå‘˜ï¼Œå®ç°è´Ÿè½½å‡è¡¡ã€‚

### 3.2 è½®è¯¢åˆ†é…ç®—æ³•

```php
/**
 * æµé‡åˆ†å‘æ ¸å¿ƒç®—æ³•
 * é‡‡ç”¨è½®è¯¢ + é…é¢é™åˆ¶çš„æ–¹å¼
 */
protected function processSingleWorkbench($workbench)
{
    // 1. è·å–é…ç½®
    $config = WorkbenchTrafficConfig::where('workbenchId', $workbench->id)->find();
    
    // 2. æ£€æŸ¥æ—¶é—´èŒƒå›´
    if (!$this->isTimeRange($config) && $config['timeType'] == 2) {
        return; // ä¸åœ¨åˆ†å‘æ—¶é—´èŒƒå›´å†…
    }
    
    // 3. è·å–å½“å¤©æœªè¶…é¢çš„å¯ç”¨è´¦å·
    $todayStart = strtotime(date('Y-m-d 00:00:00'));
    $todayEnd = strtotime(date('Y-m-d 23:59:59'));
    
    $accounts = Db::table('s2_company_account')
        ->alias('a')
        ->where(['a.departmentId' => $workbench->companyId, 'a.status' => 0])
        ->whereIn('a.id', json_decode($config['account'], true))
        ->leftJoin('workbench_traffic_config_item wti', 
            "wti.wechatAccountId = a.id AND wti.workbenchId = {$workbench->id}")
        ->field('a.id, a.userName, COUNT(wti.id) as todayCount')
        ->group('a.id')
        ->having('todayCount <= ' . $config['maxPerDay'])  // é…é¢é™åˆ¶
        ->select();
    
    // 4. è·å–å¾…åˆ†é…çš„å¥½å‹
    $friends = $this->getFriendsByLabels($workbench, $config, $page, $pageSize);
    
    // 5. è½®è¯¢åˆ†é…
    $i = 0;
    $accountNum = count($accounts);
    
    foreach ($friends as $friend) {
        // è´¦å·ç”¨å°½æ£€æŸ¥
        if ($accountNum == 0) {
            break;
        }
        
        // è½®è¯¢ç´¢å¼•é‡ç½®
        if ($i >= $accountNum) {
            $i = 0;
        }
        
        $account = $accounts[$i];
        
        // é…é¢æ£€æŸ¥
        if ($account['todayCount'] >= $config['maxPerDay']) {
            unset($accounts[$i]);
            $accounts = array_values($accounts);
            $accountNum = count($accounts);
            continue;
        }
        
        // æ‰§è¡Œåˆ†é…
        $this->allotWechatFriend([
            'wechatFriendId' => $friend['id'],
            'toAccountId' => $account['id']
        ]);
        
        $i++;
    }
}
```

### 3.3 åˆ†é…è§„åˆ™

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                        æµé‡åˆ†å‘è§„åˆ™å¼•æ“                              â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                     â”‚
â”‚  è§„åˆ™1: æ—¶é—´èŒƒå›´æ£€æŸ¥                                                â”‚
â”‚         â†’ åªåœ¨é…ç½®çš„æ—¶é—´èŒƒå›´å†…åˆ†å‘                                  â”‚
â”‚                                                                     â”‚
â”‚  è§„åˆ™2: é…é¢é™åˆ¶                                                    â”‚
â”‚         â†’ æ¯ä¸ªå®¢æœæ¯æ—¥æœ€å¤šåˆ†é… maxPerDay ä¸ªå®¢æˆ·                     â”‚
â”‚                                                                     â”‚
â”‚  è§„åˆ™3: æ ‡ç­¾ç­›é€‰                                                    â”‚
â”‚         â†’ æŒ‰é…ç½®çš„æ ‡ç­¾ç­›é€‰å¾…åˆ†é…å¥½å‹                                â”‚
â”‚                                                                     â”‚
â”‚  è§„åˆ™4: è½®è¯¢åˆ†é…                                                    â”‚
â”‚         â†’ è´¦å·A â†’ è´¦å·B â†’ è´¦å·C â†’ è´¦å·A ...                        â”‚
â”‚                                                                     â”‚
â”‚  è§„åˆ™5: åŠ¨æ€å‰”é™¤                                                    â”‚
â”‚         â†’ é…é¢æ»¡çš„è´¦å·è‡ªåŠ¨å‰”é™¤åˆ†é…é˜Ÿåˆ—                              â”‚
â”‚                                                                     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 3.4 ç®—æ³•ä»·å€¼

- **è´Ÿè½½å‡è¡¡**ï¼šé¿å…å•ä¸ªå®¢æœå‹åŠ›è¿‡å¤§
- **é…é¢æ§åˆ¶**ï¼šç¡®ä¿æœåŠ¡è´¨é‡
- **çµæ´»é…ç½®**ï¼šæ”¯æŒæ—¶é—´ã€æ ‡ç­¾ç­‰å¤šç»´åº¦é…ç½®

---

## å››ã€åˆ†é”€å¥–åŠ±è®¡ç®—ç®—æ³•

### 4.1 ç®—æ³•æ¦‚è¿°

åˆ†é”€å¥–åŠ±ç®—æ³•ç”¨äºè®¡ç®—æ¸ é“æ¨å¹¿çš„æ”¶ç›Šåˆ†æˆï¼Œæ”¯æŒè·å®¢å¥–åŠ±å’Œæ·»åŠ å¥½å‹å¥–åŠ±ä¸¤ç§ç±»å‹ã€‚

### 4.2 æ ¸å¿ƒç®—æ³•

```php
/**
 * è®°å½•è·å®¢å¥–åŠ±
 * 
 * @param int $taskId è·å®¢è®¡åˆ’ID
 * @param int $customerId å®¢æˆ·ID
 * @param string $phone å®¢æˆ·æ‰‹æœºå·
 * @param int|null $channelId æ¸ é“ID
 */
public static function recordCustomerReward($taskId, $customerId, $phone, $channelId = null)
{
    // 1. è·å–è·å®¢è®¡åˆ’é…ç½®
    $task = Db::name('customer_acquisition_task')->where('id', $taskId)->find();
    $sceneConf = json_decode($task['sceneConf'], true);
    $distributionConfig = $sceneConf['distribution'] ?? null;
    
    // 2. æ£€æŸ¥åˆ†é”€å¼€å…³
    if (empty($distributionConfig['enabled'])) {
        return false;
    }
    
    // 3. è·å–å¥–åŠ±é‡‘é¢
    $rewardAmount = intval($distributionConfig['customerRewardAmount'] ?? 0);
    if ($rewardAmount <= 0) {
        return false;
    }
    
    // 4. è·å–å…è®¸åˆ†ä½£çš„æ¸ é“åˆ—è¡¨
    $channelIds = $distributionConfig['channels'] ?? [];
    
    // 5. å¦‚æœæŒ‡å®šäº†æ¸ é“ï¼Œåªç»™è¯¥æ¸ é“åˆ†ä½£
    if (!empty($channelId)) {
        if (!in_array($channelId, $channelIds)) {
            return false; // ä¸åœ¨å…è®¸åˆ—è¡¨ä¸­
        }
        $channelIds = [$channelId];
    }
    
    // 6. ä¸ºæ¯ä¸ªæ¸ é“è®°å½•æ”¶ç›Š
    Db::startTrans();
    try {
        foreach ($channelIds as $cid) {
            $channel = Db::name('distribution_channel')->where('id', $cid)->find();
            if (!$channel) continue;
            
            // è®°å½•æ”¶ç›Šæ˜ç»†
            Db::name('distribution_reward_log')->insert([
                'channelId' => $cid,
                'customerId' => $customerId,
                'phone' => $phone,
                'rewardType' => 1, // è·å®¢å¥–åŠ±
                'rewardAmount' => $rewardAmount,
                'status' => 1,
                'createTime' => time()
            ]);
            
            // æ›´æ–°æ¸ é“å¯æç°é‡‘é¢
            Db::name('distribution_channel')
                ->where('id', $cid)
                ->setInc('withdrawableAmount', $rewardAmount);
        }
        Db::commit();
        return true;
    } catch (\Exception $e) {
        Db::rollback();
        return false;
    }
}
```

### 4.3 å¥–åŠ±ç±»å‹

| å¥–åŠ±ç±»å‹ | è§¦å‘æ—¶æœº | è¯´æ˜ |
|----------|----------|------|
| è·å®¢å¥–åŠ± | å®¢æˆ·æ‰«ç è¿›å…¥ | æŒ‰é…ç½®é‡‘é¢åˆ†ä½£ |
| æ·»åŠ å¥½å‹å¥–åŠ± | å®¢æˆ·æ·»åŠ å¾®ä¿¡å¥½å‹ | æŒ‰é…ç½®é‡‘é¢åˆ†ä½£ |

### 4.4 ç®—æ³•ä»·å€¼

- **æ¿€åŠ±æ¸ é“**ï¼šé¼“åŠ±æ¸ é“æ¨å¹¿
- **ç²¾å‡†è¿½è¸ª**ï¼šè®°å½•æ¯ä¸ªå®¢æˆ·çš„æ¥æºæ¸ é“
- **çµæ´»é…ç½®**ï¼šæ”¯æŒå¤šæ¸ é“ã€å¤šå¥–åŠ±ç±»å‹

---

## äº”ã€æ¶ˆæ¯ç¾¤å‘è°ƒåº¦ç®—æ³•

### 5.1 ç®—æ³•æ¦‚è¿°

æ¶ˆæ¯ç¾¤å‘ç®—æ³•ç”¨äºæ‰¹é‡å‘é€æ¶ˆæ¯ç»™å¥½å‹æˆ–ç¾¤èŠï¼Œéœ€è¦å¤„ç†å»é‡ã€é™é¢‘ã€å¤±è´¥é‡è¯•ç­‰é—®é¢˜ã€‚

### 5.2 æ ¸å¿ƒç®—æ³•

```php
/**
 * æ¶ˆæ¯ç¾¤å‘æ ¸å¿ƒé€»è¾‘
 */
protected function sendToFriends($workbench, $config, $msgConf, $wsController)
{
    // 1. è·å–ç›®æ ‡å¥½å‹åˆ—è¡¨
    $friendsData = [];
    
    // æŒ‡å®šå¥½å‹
    if (!empty($config['friends'])) {
        $friendsData = array_merge($friendsData, 
            $this->getFriendsByIds($config['friends']));
    }
    
    // æµé‡æ± å¥½å‹
    if (!empty($config['trafficPools'])) {
        $friendsData = array_merge($friendsData, 
            $this->getFriendsByTrafficPools($config['trafficPools']));
    }
    
    // 2. å»é‡å¤„ç†
    $friendsData = $this->deduplicateFriends($friendsData);
    
    // 3. è·å–å·²æ¨é€çš„å¥½å‹IDï¼ˆé¿å…é‡å¤æ¨é€ï¼‰
    $sentFriendIds = Db::name('workbench_group_push_item')
        ->where('workbenchId', $workbench->id)
        ->where('targetType', 2)
        ->column('friendId');
    
    // 4. è¿‡æ»¤å·²æ¨é€çš„å¥½å‹
    $friendsData = array_filter($friendsData, function($friend) use ($sentFriendIds) {
        return !in_array($friend['id'], $sentFriendIds);
    });
    
    // 5. é…é¢æ£€æŸ¥
    $sentFriendCount = count($sentFriendIds);
    $maxPerDay = intval($config['maxPerDay']);
    $remainingQuota = $maxPerDay - $sentFriendCount;
    
    if ($remainingQuota <= 0) {
        return false; // ä»Šæ—¥é…é¢å·²ç”¨å®Œ
    }
    
    // 6. æ‰¹é‡å‘é€ï¼ˆå¸¦é—´éš”ï¼‰
    $sentCount = 0;
    foreach ($friendsData as $friend) {
        if ($sentCount >= $remainingQuota) {
            break;
        }
        
        // å‘é€æ¶ˆæ¯
        $result = $wsController->sendMessage([
            'toWxid' => $friend['wechatId'],
            'content' => $msgConf['content'],
            'msgType' => $msgConf['msgType']
        ]);
        
        // è®°å½•å‘é€ç»“æœ
        Db::name('workbench_group_push_item')->insert([
            'workbenchId' => $workbench->id,
            'friendId' => $friend['id'],
            'targetType' => 2,
            'status' => $result['code'] == 200 ? 1 : 0,
            'createTime' => time()
        ]);
        
        $sentCount++;
        
        // å‘é€é—´éš”ï¼ˆé˜²é£æ§ï¼‰
        sleep(rand(3, 8));
    }
    
    return true;
}
```

### 5.3 é£æ§ç­–ç•¥

```php
// å‘é€é—´éš”æ§åˆ¶
$interval = rand(3, 8); // 3-8ç§’éšæœºé—´éš”
sleep($interval);

// æ¯æ—¥å‘é€ä¸Šé™
$maxPerDay = 200; // å¯é…ç½®

// åŒä¸€å¥½å‹é—´éš”
$lastSendTime = Cache::get("last_send:{$wechatId}:{$toWxid}");
if (time() - $lastSendTime < 60) {
    continue; // 1åˆ†é’Ÿå†…ä¸é‡å¤å‘é€
}
```

### 5.4 ç®—æ³•ä»·å€¼

- **æ‰¹é‡æ“ä½œ**ï¼šé«˜æ•ˆå¤„ç†å¤§é‡æ¶ˆæ¯
- **å»é‡æœºåˆ¶**ï¼šé¿å…é‡å¤éªšæ‰°ç”¨æˆ·
- **é£æ§ä¿æŠ¤**ï¼šæ§åˆ¶å‘é€é¢‘ç‡ï¼Œä¿æŠ¤è´¦å·

---

## å…­ã€è‡ªåŠ¨å»ºç¾¤ç®—æ³•

### 6.1 ç®—æ³•æ¦‚è¿°

è‡ªåŠ¨å»ºç¾¤ç®—æ³•ç”¨äºæ‰¹é‡åˆ›å»ºå¾®ä¿¡ç¾¤èŠï¼Œå¹¶è‡ªåŠ¨å‘é€æ¬¢è¿è¯­ã€‚

### 6.2 æ ¸å¿ƒç®—æ³•

```php
/**
 * è‡ªåŠ¨å»ºç¾¤æ ¸å¿ƒé€»è¾‘
 */
public function createGroup($task)
{
    // 1. è·å– WebSocket è¿æ¥
    $ws = new WebSocketController($task->wechat);
    
    // 2. è§£ææˆå‘˜åˆ—è¡¨
    $memberWxids = json_decode($task->member_wxids, true);
    
    // 3. åˆ›å»ºç¾¤èŠ
    $result = $ws->createChatroom([
        'memberWxids' => $memberWxids,
        'name' => $task->group_name,
    ]);
    
    if ($result['code'] == 200) {
        // 4. æ›´æ–°ä»»åŠ¡çŠ¶æ€
        $task->status = 1;
        $task->chatroom_id = $result['data']['chatroomId'];
        $task->save();
        
        // 5. å¦‚æœè®¾ç½®äº†æ¬¢è¿è¯­ï¼Œè§¦å‘æ¬¢è¿è¯­ä»»åŠ¡
        if ($task->welcome_message) {
            $this->triggerWelcomeMessage($task);
        }
        
        return true;
    }
    
    return false;
}

/**
 * å…¥ç¾¤æ¬¢è¿è¯­
 */
public function sendWelcomeMessage($chatroomId, $newMemberWxid, $config)
{
    // å»¶è¿Ÿå‘é€ï¼ˆç­‰å¾…å…¥ç¾¤åŠ¨ç”»å®Œæˆï¼‰
    sleep($config->delay ?? 3);
    
    // è·å– WebSocket è¿æ¥
    $ws = new WebSocketController($config->wechat);
    
    // æ›¿æ¢å˜é‡
    $message = str_replace(
        ['{nickname}', '{date}'],
        [$data['nickname'], date('Y-m-d')],
        $config->message
    );
    
    // å‘é€æ¬¢è¿è¯­
    return $ws->sendChatroomMessage($chatroomId, $message);
}
```

### 6.3 ç®—æ³•ä»·å€¼

- **æ‰¹é‡å»ºç¾¤**ï¼šå¿«é€Ÿåˆ›å»ºå¤šä¸ªç¾¤èŠ
- **è‡ªåŠ¨æ¬¢è¿**ï¼šæå‡ç”¨æˆ·ä½“éªŒ
- **å˜é‡æ›¿æ¢**ï¼šä¸ªæ€§åŒ–æ¬¢è¿å†…å®¹

---

## ğŸ“š ç®—æ³•æ–‡ä»¶ç´¢å¼•

| ç®—æ³• | æ–‡ä»¶è·¯å¾„ | è¯´æ˜ |
|------|----------|------|
| å¥åº·åˆ†ç®—æ³• | `Server/application/common/service/WechatAccountHealthScoreService.php` | 756è¡Œä»£ç  |
| RFMç®—æ³• | `Server/application/cunkebao/controller/RFMController.php` | 267è¡Œä»£ç  |
| æµé‡åˆ†å‘ | `Server/application/job/WorkbenchTrafficDistributeJob.php` | 200+è¡Œä»£ç  |
| åˆ†é”€å¥–åŠ± | `Server/application/cunkebao/service/DistributionRewardService.php` | 210è¡Œä»£ç  |
| æ¶ˆæ¯ç¾¤å‘ | `Server/application/job/WorkbenchGroupPushJob.php` | 900+è¡Œä»£ç  |
| è‡ªåŠ¨å»ºç¾¤ | `Server/application/job/WorkbenchGroupCreateJob.php` | 267è¡Œä»£ç  |

---

## ğŸ’ æ ¸å¿ƒä»·å€¼æ€»ç»“

| ç®—æ³• | æ ¸å¿ƒä»·å€¼ | å•†ä¸šæ„ä¹‰ |
|------|----------|----------|
| **å¥åº·åˆ†** | é£é™©æ§åˆ¶ | ä¿æŠ¤è´¦å·ï¼Œé™ä½å°å·ç‡ |
| **RFM** | å®¢æˆ·åˆ†å±‚ | ç²¾å‡†è¥é”€ï¼Œæå‡è½¬åŒ– |
| **æµé‡åˆ†å‘** | è´Ÿè½½å‡è¡¡ | æå‡æœåŠ¡æ•ˆç‡ |
| **åˆ†é”€å¥–åŠ±** | æ¸ é“æ¿€åŠ± | æ‰©å¤§è·å®¢æ¸ é“ |
| **æ¶ˆæ¯ç¾¤å‘** | æ‰¹é‡è§¦è¾¾ | æå‡è¿è¥æ•ˆç‡ |
| **è‡ªåŠ¨å»ºç¾¤** | ç¤¾ç¾¤è¿è¥ | å¿«é€Ÿæ„å»ºç§åŸŸç¤¾ç¾¤ |

è¿™äº›ç®—æ³•æ˜¯å­˜å®¢å®ç³»ç»Ÿçš„**æ ¸å¿ƒç«äº‰åŠ›**ï¼Œå»ºè®®é‡ç‚¹ç»´æŠ¤å’Œä¼˜åŒ–ã€‚
