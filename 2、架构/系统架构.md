# 系统架构

> 📅 最后更新：2026-01-11
> 📋 基于项目源码逆向分析生成

---

## 🏗️ 整体架构图

```
┌─────────────────────────────────────────────────────────────────────┐
│                           客户端层                                   │
├─────────────┬─────────────┬─────────────┬─────────────┬─────────────┤
│  Cunkebao   │ Touchkebao  │ SuperAdmin  │  Store_vue  │  aiApp/ckApp│
│  (React)    │  (React)    │  (Next.js)  │  (UniApp)   │  (UniApp)   │
│  主前端      │  触控版      │  管理后台    │  门店端      │  移动应用    │
└──────┬──────┴──────┬──────┴──────┬──────┴──────┬──────┴──────┬──────┘
       │             │             │             │             │
       └─────────────┴─────────────┴─────────────┴─────────────┘
                                   │
                                   ▼
┌─────────────────────────────────────────────────────────────────────┐
│                           API 网关层                                 │
│                        (Nginx 反向代理)                              │
└─────────────────────────────────┬───────────────────────────────────┘
                                  │
       ┌──────────────────────────┼──────────────────────────┐
       │                          │                          │
       ▼                          ▼                          ▼
┌─────────────────┐    ┌─────────────────┐    ┌─────────────────┐
│     Server      │    │     Moncter     │    │   WebSocket     │
│   (ThinkPHP)    │    │    (Webman)     │    │  (GatewayWorker)│
│   主业务服务     │    │   监控/数据服务  │    │   实时通信服务   │
└────────┬────────┘    └────────┬────────┘    └────────┬────────┘
         │                      │                      │
         └──────────────────────┼──────────────────────┘
                                │
       ┌────────────────────────┼────────────────────────┐
       │                        │                        │
       ▼                        ▼                        ▼
┌─────────────────┐    ┌─────────────────┐    ┌─────────────────┐
│     MongoDB     │    │      MySQL      │    │      Redis      │
│    主数据存储    │    │   关系型数据     │    │   缓存/队列      │
└─────────────────┘    └─────────────────┘    └─────────────────┘
```

---

## 📦 服务模块说明

### 1. Cunkebao (主前端)

**技术栈**：React 18 + TypeScript + Vite + Zustand

**职责**：
- 主要的管理后台界面
- 设备管理、微信管理、内容库等核心功能
- 数据可视化展示

**目录结构**：
```
Cunkebao/
├── src/
│   ├── api/           # API 接口封装
│   ├── components/    # 通用组件
│   ├── pages/         # 页面组件
│   ├── router/        # 路由配置
│   ├── store/         # Zustand 状态管理
│   ├── styles/        # 全局样式
│   ├── types/         # TypeScript 类型定义
│   └── utils/         # 工具函数
├── public/            # 静态资源
└── package.json
```

### 2. Touchkebao (触控版)

**技术栈**：React 18 + TypeScript + Vite

**职责**：
- 客服聊天专用界面
- 消息实时同步
- 快捷回复功能

### 3. Server (主后端)

**技术栈**：PHP 7.4 + ThinkPHP 5.1

**职责**：
- 核心业务逻辑处理
- RESTful API 提供
- 数据库 CRUD 操作
- 任务调度

**目录结构**：
```
Server/
├── application/
│   ├── api/           # API 模块
│   ├── common/        # 公共模块
│   ├── cunkebao/      # 主业务模块
│   ├── store/         # 门店模块
│   ├── superadmin/    # 超管模块
│   ├── command/       # 命令行
│   └── job/           # 后台任务
├── config/            # 配置文件
├── extend/            # 扩展类库
├── public/            # Web 入口
├── route/             # 路由配置
└── thinkphp/          # 框架核心
```

### 4. Moncter (监控服务)

**技术栈**：PHP 8.1 + Webman

**职责**：
- 数据采集服务
- 数据同步调度
- 消费记录处理
- 任务状态监控

**目录结构**：
```
Moncter/
├── app/
│   ├── controller/    # 控制器
│   ├── model/         # 数据模型
│   ├── service/       # 业务服务
│   └── middleware/    # 中间件
├── config/            # 配置文件
├── MCP/               # MCP 服务
├── TaskShow/          # 任务展示前端
└── 数据库/             # 数据库脚本
```

### 5. SuperAdmin (超级管理后台)

**技术栈**：Next.js 14 + TypeScript + Shadcn UI

**职责**：
- 系统级管理功能
- 用户权限管理
- 系统配置

---

## 🔄 数据流架构

### API 请求流程

```
客户端 → Nginx → Server/Moncter → MySQL/MongoDB → 响应
```

### 实时消息流程

```
设备 → WebSocket → GatewayWorker → Redis Pub/Sub → 客户端
```

### 任务调度流程

```
定时触发 → ThinkPHP Queue → Redis 队列 → Worker 消费 → 执行任务
```

---

## 🗄️ 数据库架构

### MongoDB 集合

| 集合名 | 说明 |
|--------|------|
| `wechat_friends` | 微信好友信息 |
| `wechat_messages` | 聊天消息记录 |
| `wechat_moments` | 朋友圈内容 |
| `content_library` | 内容库素材 |
| `task_logs` | 任务执行日志 |

### MySQL 表

| 表名 | 说明 |
|------|------|
| `users` | 系统用户 |
| `devices` | 设备信息 |
| `wechats` | 微信账号 |
| `orders` | 订单数据 |
| `traffic_pools` | 流量池 |
| `traffic_tags` | 流量标签 |

---

## 🔐 安全架构

### 认证机制

```
JWT Token 认证
├── 登录获取 Token
├── 请求携带 Authorization Header
├── 中间件验证 Token
└── Token 过期刷新
```

### 权限控制

```
RBAC 权限模型
├── 用户 (User)
├── 角色 (Role)
├── 权限 (Permission)
└── 资源 (Resource)
```

---

## 📡 通信协议

### HTTP API

- **协议**：HTTPS
- **格式**：JSON
- **认证**：Bearer Token

**统一响应格式**：
```json
{
  "code": 200,
  "message": "success",
  "data": {},
  "time": 1704931200
}
```

### WebSocket

- **协议**：WSS
- **格式**：JSON
- **心跳**：30秒

**消息格式**：
```json
{
  "type": "message_type",
  "data": {},
  "time": 1704931200
}
```

---

## 🚀 部署架构

### 生产环境

```
┌─────────────────────────────────────────────────┐
│                    CDN                          │
│              (静态资源加速)                      │
└─────────────────────┬───────────────────────────┘
                      │
┌─────────────────────┴───────────────────────────┐
│                   Nginx                         │
│           (负载均衡 + 反向代理)                  │
└─────────┬─────────────────────────────┬─────────┘
          │                             │
┌─────────┴─────────┐         ┌─────────┴─────────┐
│   PHP-FPM 集群    │         │   Webman 集群     │
│   (Server)        │         │   (Moncter)       │
└─────────┬─────────┘         └─────────┬─────────┘
          │                             │
┌─────────┴─────────────────────────────┴─────────┐
│              数据层 (MySQL + MongoDB + Redis)   │
└─────────────────────────────────────────────────┘
```

### 服务端口

| 服务 | 端口 | 说明 |
|------|------|------|
| Nginx | 80/443 | Web 入口 |
| PHP-FPM | 9000 | PHP 服务 |
| Webman | 8787 | Moncter 服务 |
| WebSocket | 7272 | 实时通信 |
| MySQL | 3306 | 数据库 |
| MongoDB | 27017 | 数据库 |
| Redis | 6379 | 缓存 |

---

## 🌟 亮点功能架构

### 1. 设备代理通信架构

```
┌─────────────────────────────────────────────────────────────────────┐
│                        设备代理通信链路                              │
├─────────────────────────────────────────────────────────────────────┤
│                                                                     │
│  ┌─────────────┐                    ┌─────────────┐                │
│  │   手机设备   │ ←──── 蓝牙/USB ────→ │  代理APP    │                │
│  │  (微信客户端) │                    │ (私域管理SDK) │                │
│  └─────────────┘                    └──────┬──────┘                │
│                                           │                        │
│                                    WebSocket (WSS)                 │
│                                           │                        │
│                                    ┌──────┴──────┐                 │
│                                    │  代理服务器   │                 │
│                                    │ s2.siyuguanli│                 │
│                                    └──────┬──────┘                 │
│                                           │                        │
│                                    WebSocket (WSS)                 │
│                                           │                        │
│                                    ┌──────┴──────┐                 │
│                                    │  存客宝后端   │                 │
│                                    │  (ThinkPHP)  │                 │
│                                    └─────────────┘                 │
│                                                                     │
└─────────────────────────────────────────────────────────────────────┘

特点：
- ✅ 真机控制，风控风险低
- ✅ 支持批量设备管理
- ✅ 实时状态同步
- ✅ 断线自动重连
```

### 2. 任务调度架构

```
┌─────────────────────────────────────────────────────────────────────┐
│                        多进程任务调度                                │
├─────────────────────────────────────────────────────────────────────┤
│                                                                     │
│  ┌─────────────────────────────────────────────────────────────┐   │
│  │                     TaskScheduler (主进程)                   │   │
│  │                                                             │   │
│  │   ┌─────────┐  ┌─────────┐  ┌─────────┐  ┌─────────┐      │   │
│  │   │ Cron    │  │ Event   │  │ Manual  │  │ Webhook │      │   │
│  │   │ 定时任务 │  │ 事件触发 │  │ 手动触发 │  │ 外部调用 │      │   │
│  │   └────┬────┘  └────┬────┘  └────┬────┘  └────┬────┘      │   │
│  │        └────────────┼────────────┼────────────┘            │   │
│  │                     ▼                                      │   │
│  │              ┌─────────────┐                               │   │
│  │              │ Redis Queue │                               │   │
│  │              └──────┬──────┘                               │   │
│  │                     │                                      │   │
│  │   ┌─────────────────┼─────────────────┐                   │   │
│  │   ▼                 ▼                 ▼                   │   │
│  │ ┌─────────┐   ┌─────────┐   ┌─────────┐                  │   │
│  │ │Worker 1 │   │Worker 2 │   │Worker N │                  │   │
│  │ │ 获客任务 │   │ 群发任务 │   │ 采集任务 │                  │   │
│  │ └─────────┘   └─────────┘   └─────────┘                  │   │
│  │                                                           │   │
│  └───────────────────────────────────────────────────────────┘   │
│                                                                     │
└─────────────────────────────────────────────────────────────────────┘

特点：
- ✅ 多进程并发执行
- ✅ 任务锁防重复
- ✅ 失败自动重试
- ✅ 实时状态监控
```

### 3. 健康分评估架构

```
┌─────────────────────────────────────────────────────────────────────┐
│                      微信账号健康分系统                              │
├─────────────────────────────────────────────────────────────────────┤
│                                                                     │
│  数据采集层                                                         │
│  ┌─────────┐  ┌─────────┐  ┌─────────┐  ┌─────────┐              │
│  │消息发送  │  │好友增减  │  │互动数据  │  │异常记录  │              │
│  │ 统计    │  │ 统计    │  │ 统计    │  │ 统计    │              │
│  └────┬────┘  └────┬────┘  └────┬────┘  └────┬────┘              │
│       └────────────┼────────────┼────────────┘                    │
│                    ▼                                               │
│  ┌─────────────────────────────────────────────────────────────┐  │
│  │                    健康分计算引擎                             │  │
│  │                                                             │  │
│  │   基础分(100) - 扣分项 + 加分项 = 最终健康分                   │  │
│  │                                                             │  │
│  │   扣分项：                      加分项：                      │  │
│  │   - 消息发送失败 -2分           - 正常互动 +1分               │  │
│  │   - 被好友删除 -5分             - 好友增长 +2分               │  │
│  │   - 被举报 -20分               - 活跃度高 +5分               │  │
│  │   - 账号异常 -50分                                          │  │
│  │                                                             │  │
│  └─────────────────────────────────────────────────────────────┘  │
│                    │                                               │
│                    ▼                                               │
│  ┌─────────────────────────────────────────────────────────────┐  │
│  │                    风险预警系统                               │  │
│  │   健康分 < 60：预警  │  健康分 < 40：限制操作  │  < 20：停用   │  │
│  └─────────────────────────────────────────────────────────────┘  │
│                                                                     │
└─────────────────────────────────────────────────────────────────────┘
```

### 4. 流量分发架构

```
┌─────────────────────────────────────────────────────────────────────┐
│                        智能流量分发系统                              │
├─────────────────────────────────────────────────────────────────────┤
│                                                                     │
│  ┌─────────────────────────────────────────────────────────────┐   │
│  │                      流量入口                                │   │
│  │   ┌─────────┐  ┌─────────┐  ┌─────────┐  ┌─────────┐       │   │
│  │   │ 渠道码  │  │ 活动页  │  │ 公众号  │  │ 小程序  │       │   │
│  │   └────┬────┘  └────┬────┘  └────┬────┘  └────┬────┘       │   │
│  │        └────────────┼────────────┼────────────┘             │   │
│  └─────────────────────┼────────────────────────────────────────┘   │
│                        ▼                                            │
│  ┌─────────────────────────────────────────────────────────────┐   │
│  │                    分发规则引擎                              │   │
│  │                                                             │   │
│  │   规则1: 按标签分配    → 教育标签 → 教育流量池               │   │
│  │   规则2: 按地区分配    → 厦门地区 → 厦门流量池               │   │
│  │   规则3: 按时间分配    → 工作时间 → 主力客服                 │   │
│  │   规则4: 按负载分配    → 最少客户 → 空闲客服                 │   │
│  │                                                             │   │
│  └─────────────────────────────────────────────────────────────┘   │
│                        │                                            │
│         ┌──────────────┼──────────────┐                            │
│         ▼              ▼              ▼                            │
│  ┌─────────────┐ ┌─────────────┐ ┌─────────────┐                  │
│  │  流量池 A   │ │  流量池 B   │ │  流量池 C   │                  │
│  │  (教育)     │ │  (电商)     │ │  (本地)     │                  │
│  └─────────────┘ └─────────────┘ └─────────────┘                  │
│                                                                     │
└─────────────────────────────────────────────────────────────────────┘
```

---

## ⚠️ 架构注意事项

1. **高可用**：关键服务需要部署多实例
2. **数据备份**：MongoDB 和 MySQL 需要定期备份
3. **日志管理**：使用 ELK 或类似方案集中管理日志
4. **监控告警**：配置服务监控和异常告警
5. **安全防护**：配置 WAF、DDoS 防护
6. **WebSocket 稳定性**：实现心跳检测和自动重连
7. **任务幂等性**：确保任务不会重复执行
8. **风控合规**：严格控制操作频率

---

## 📚 相关文档

| 文档 | 路径 | 说明 |
|------|------|------|
| 核心业务链路 | `开发文档/2、架构/核心业务链路.md` | 业务流程详解 |
| 自动化工作流 | `开发文档/2、架构/自动化工作流.md` | 任务调度详解 |
| 技术选型 | `开发文档/2、架构/技术选型.md` | 技术栈说明 |
| 解决方案对比 | `开发文档/2、架构/解决方案对比与优化建议.md` | 优化建议 |
