# æ ¸å¿ƒä¸šåŠ¡é“¾è·¯è¯´æ˜

> ğŸ“… æœ€åæ›´æ–°ï¼š2026-01-11
> ğŸ“‹ å­˜å®¢å®ç³»ç»Ÿæ ¸å¿ƒä¸šåŠ¡æµç¨‹å’ŒæŠ€æœ¯å®ç°è¯¦è§£

---

## ğŸ“‹ æ¦‚è¿°

å­˜å®¢å®æ˜¯ä¸€å¥—ç§åŸŸè¿è¥è‡ªåŠ¨åŒ–ç³»ç»Ÿï¼Œæ ¸å¿ƒèƒ½åŠ›æ˜¯é€šè¿‡**è®¾å¤‡ä»£ç† + WebSocket é•¿è¿æ¥**å®ç°å¯¹å¾®ä¿¡å®¢æˆ·ç«¯çš„è¿œç¨‹æ§åˆ¶å’Œæ•°æ®åŒæ­¥ã€‚

---

## ğŸ”— æ ¸å¿ƒæ¶æ„é“¾è·¯

### æ•´ä½“æ•°æ®æµ

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   æ‰‹æœºè®¾å¤‡    â”‚ â†â†’  â”‚  ä»£ç†æœåŠ¡å™¨   â”‚ â†â†’  â”‚  å­˜å®¢å®åç«¯   â”‚
â”‚  (å¾®ä¿¡å®¢æˆ·ç«¯) â”‚     â”‚ (ç§åŸŸç®¡ç†SDK) â”‚     â”‚  (ThinkPHP)  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                                  â†‘
                                                  â”‚
                           â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                           â”‚                      â”‚                      â”‚
                           â–¼                      â–¼                      â–¼
                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                    â”‚   å‰ç«¯ç•Œé¢   â”‚      â”‚  å®šæ—¶ä»»åŠ¡    â”‚      â”‚  æ¶ˆæ¯é˜Ÿåˆ—   â”‚
                    â”‚  (React)    â”‚      â”‚ (Workerman) â”‚      â”‚  (Redis)   â”‚
                    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜      â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜      â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ğŸ”Œ WebSocket é€šä¿¡é“¾è·¯

### 1. è¿æ¥å»ºç«‹æµç¨‹

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   å®¢æˆ·ç«¯     â”‚                    â”‚  WebSocket  â”‚                    â”‚   ä¸šåŠ¡æœåŠ¡   â”‚
â”‚  (React)    â”‚                    â”‚   æœåŠ¡å™¨     â”‚                    â”‚ (ThinkPHP)  â”‚
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜                    â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜                    â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜
       â”‚                                  â”‚                                  â”‚
       â”‚ 1. å‘èµ· WS è¿æ¥è¯·æ±‚               â”‚                                  â”‚
       â”‚ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¶   â”‚                                  â”‚
       â”‚                                  â”‚                                  â”‚
       â”‚ 2. è¿”å›è¿æ¥æˆåŠŸ                   â”‚                                  â”‚
       â”‚ â—€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€   â”‚                                  â”‚
       â”‚                                  â”‚                                  â”‚
       â”‚ 3. å‘é€è®¤è¯æ¶ˆæ¯ (Token)           â”‚                                  â”‚
       â”‚ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¶   â”‚                                  â”‚
       â”‚                                  â”‚ 4. éªŒè¯ Token                    â”‚
       â”‚                                  â”‚ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¶   â”‚
       â”‚                                  â”‚                                  â”‚
       â”‚                                  â”‚ 5. è¿”å›ç”¨æˆ·ä¿¡æ¯                   â”‚
       â”‚                                  â”‚ â—€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€   â”‚
       â”‚ 6. è®¤è¯æˆåŠŸï¼Œç»‘å®šä¼šè¯             â”‚                                  â”‚
       â”‚ â—€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€   â”‚                                  â”‚
       â”‚                                  â”‚                                  â”‚
       â”‚ 7. å¼€å§‹å¿ƒè·³æ£€æµ‹ (30s)             â”‚                                  â”‚
       â”‚ â†â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â†’   â”‚                                  â”‚
```

### 2. æ ¸å¿ƒæ¶ˆæ¯ç±»å‹

```javascript
// ç™»å½•è®¤è¯
{
  "cmdType": "CmdSignIn",
  "accessToken": "xxx",
  "accountId": "xxx",
  "client": "kefu-client",
  "seq": 1
}

// å¿ƒè·³ä¿æ´»
{
  "cmdType": "CmdHeartbeat",
  "seq": 1704931200
}

// è·å–æœ‹å‹åœˆ
{
  "cmdType": "CmdFetchMoment",
  "wechatAccountId": "xxx",
  "wechatFriendId": "xxx",
  "count": 20,
  "prevSnsId": "xxx"
}

// å‘é€æ¶ˆæ¯
{
  "cmdType": "CmdSendMsg",
  "wechatAccountId": "xxx",
  "toWxid": "xxx",
  "msgType": 1,
  "content": "æ¶ˆæ¯å†…å®¹"
}

// åˆ›å»ºç¾¤èŠ
{
  "cmdType": "CmdCreateChatroom",
  "wechatAccountId": "xxx",
  "memberWxids": ["wxid_1", "wxid_2"],
  "name": "ç¾¤åç§°"
}
```

---

## ğŸ“± è®¾å¤‡æ§åˆ¶é“¾è·¯

### 1. è®¾å¤‡æ¥å…¥æµç¨‹

```
1. è®¾å¤‡å®‰è£…ç§åŸŸç®¡ç† APP
         â†“
2. APP è¿æ¥åˆ°ä»£ç†æœåŠ¡å™¨ (wss://s2.siyuguanli.com:9993)
         â†“
3. è®¾å¤‡ç™»å½•å¾®ä¿¡è´¦å·
         â†“
4. ä»£ç†æœåŠ¡å™¨åŒæ­¥è®¾å¤‡çŠ¶æ€åˆ°å­˜å®¢å®
         â†“
5. å­˜å®¢å®åå°å¯ä»¥è¿œç¨‹æ§åˆ¶è®¾å¤‡
```

### 2. æŒ‡ä»¤ä¸‹å‘æµç¨‹

```php
// WebSocketController.php æ ¸å¿ƒä»£ç 

// 1. å»ºç«‹è¿æ¥
$this->client = new Client("wss://s2.siyuguanli.com:9993", [
    'filter' => ['text', 'binary', 'ping', 'pong', 'close'],
    'context' => $context,
    'headers' => [
        'Sec-WebSocket-Protocol' => 'soap',
        'origin' => 'localhost',
    ],
    'timeout' => 86400,
]);

// 2. å‘é€è®¤è¯
$signInData = [
    "accessToken" => $this->authorized,
    "accountId" => $this->accountId,
    "client" => "kefu-client",
    "cmdType" => "CmdSignIn",
    "seq" => 1,
];
$this->client->send(json_encode($signInData));

// 3. å‘é€ä¸šåŠ¡æŒ‡ä»¤
protected function sendMessage($data, $receive = true)
{
    $this->checkConnection();
    $this->client->send(json_encode($data));
    
    if ($receive) {
        $response = $this->client->receive();
        return json_decode($response, true);
    }
    return ['code' => 200, 'msg' => 'æˆåŠŸ'];
}
```

---

## âš™ï¸ è‡ªåŠ¨åŒ–ä»»åŠ¡é“¾è·¯

### 1. ä»»åŠ¡è°ƒåº¦æ¶æ„

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                        ä»»åŠ¡è°ƒåº¦å™¨ (TaskScheduler)                â”‚
â”‚                                                                 â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”             â”‚
â”‚  â”‚  å®šæ—¶è§¦å‘    â”‚  â”‚  äº‹ä»¶è§¦å‘    â”‚  â”‚  æ‰‹åŠ¨è§¦å‘    â”‚             â”‚
â”‚  â”‚  (Cron)     â”‚  â”‚  (Webhook)  â”‚  â”‚  (API)      â”‚             â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜             â”‚
â”‚         â”‚                â”‚                â”‚                    â”‚
â”‚         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                    â”‚
â”‚                          â–¼                                     â”‚
â”‚                   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                              â”‚
â”‚                   â”‚  ä»»åŠ¡é˜Ÿåˆ—    â”‚                              â”‚
â”‚                   â”‚  (Redis)    â”‚                              â”‚
â”‚                   â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜                              â”‚
â”‚                          â”‚                                     â”‚
â”‚         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                    â”‚
â”‚         â–¼                â–¼                â–¼                    â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”            â”‚
â”‚  â”‚  Worker 1   â”‚  â”‚  Worker 2   â”‚  â”‚  Worker N   â”‚            â”‚
â”‚  â”‚  (è¿›ç¨‹1)    â”‚  â”‚  (è¿›ç¨‹2)    â”‚  â”‚  (è¿›ç¨‹N)    â”‚            â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 2. å·²æ³¨å†Œçš„å®šæ—¶ä»»åŠ¡

```php
// application/command.php

// æ•°æ®åŒæ­¥ç±»
'sync:wechatData'        => 'SyncWechatDataToCkbTask',    // åŒæ­¥å¾®ä¿¡æ•°æ®
'sync:allFriends'        => 'SyncAllFriendsCommand',      // åŒæ­¥æ‰€æœ‰å¥½å‹

// å·¥ä½œå°è‡ªåŠ¨åŒ–
'workbench:autoLike'     => 'WorkbenchAutoLikeCommand',   // è‡ªåŠ¨ç‚¹èµ
'workbench:moments'      => 'WorkbenchMomentsCommand',    // æœ‹å‹åœˆåŒæ­¥
'workbench:groupPush'    => 'WorkbenchGroupPushCommand',  // ç¾¤æ¶ˆæ¯æ¨é€
'workbench:groupCreate'  => 'WorkbenchGroupCreateCommand',// è‡ªåŠ¨å»ºç¾¤
'workbench:groupWelcome' => 'WorkbenchGroupWelcomeCommand',// å…¥ç¾¤æ¬¢è¿è¯­

// å†…å®¹é‡‡é›†ç±»
'content:collect'        => 'ContentCollectCommand',      // å†…å®¹é‡‡é›†
'moments:collect'        => 'WechatMomentsCommand',       // æœ‹å‹åœˆé‡‡é›†

// å¥åº·åˆ†è®¡ç®—
'wechat:calculate-score' => 'CalculateWechatAccountScoreCommand',
'wechat:update-score'    => 'UpdateWechatAccountScoreCommand',

// ç»Ÿä¸€è°ƒåº¦å™¨
'scheduler:run'          => 'TaskSchedulerCommand',       // å¤šè¿›ç¨‹å¹¶å‘è°ƒåº¦
```

### 3. ä»»åŠ¡æ‰§è¡Œæµç¨‹

```
ç”¨æˆ·åˆ›å»ºä»»åŠ¡ â†’ ä»»åŠ¡å…¥é˜Ÿ (Redis) â†’ Worker æ¶ˆè´¹ â†’ æ‰§è¡Œä¸šåŠ¡é€»è¾‘ â†’ æ›´æ–°çŠ¶æ€
     â†“              â†“                 â†“              â†“           â†“
  [å‰ç«¯]         [Queue]         [Workerman]    [WebSocket]   [MySQL]
```

---

## ğŸ”„ æ ¸å¿ƒä¸šåŠ¡æµç¨‹

### 1. è‡ªåŠ¨å»ºç¾¤æµç¨‹

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                        è‡ªåŠ¨å»ºç¾¤æµç¨‹                              â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                 â”‚
â”‚  1. ç”¨æˆ·åœ¨å‰ç«¯é€‰æ‹©å¥½å‹ï¼Œåˆ›å»ºå»ºç¾¤ä»»åŠ¡                              â”‚
â”‚         â†“                                                       â”‚
â”‚  2. ä»»åŠ¡æ•°æ®å­˜å…¥ MySQLï¼ŒçŠ¶æ€è®¾ä¸º"å¾…æ‰§è¡Œ"                          â”‚
â”‚         â†“                                                       â”‚
â”‚  3. å®šæ—¶ä»»åŠ¡æ‰«æå¾…æ‰§è¡Œä»»åŠ¡ï¼Œæ¨å…¥ Redis é˜Ÿåˆ—                       â”‚
â”‚         â†“                                                       â”‚
â”‚  4. Worker æ¶ˆè´¹ä»»åŠ¡ï¼Œè°ƒç”¨ WebSocket å‘é€å»ºç¾¤æŒ‡ä»¤                  â”‚
â”‚         â†“                                                       â”‚
â”‚  5. ä»£ç†æœåŠ¡å™¨è½¬å‘æŒ‡ä»¤åˆ°è®¾å¤‡                                     â”‚
â”‚         â†“                                                       â”‚
â”‚  6. è®¾å¤‡æ‰§è¡Œå»ºç¾¤æ“ä½œï¼Œè¿”å›ç»“æœ                                   â”‚
â”‚         â†“                                                       â”‚
â”‚  7. æ›´æ–°ä»»åŠ¡çŠ¶æ€ï¼Œè®°å½•æ‰§è¡Œæ—¥å¿—                                   â”‚
â”‚         â†“                                                       â”‚
â”‚  8. å¦‚æœè®¾ç½®äº†æ¬¢è¿è¯­ï¼Œè§¦å‘æ¬¢è¿è¯­ä»»åŠ¡                             â”‚
â”‚                                                                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 2. æ¶ˆæ¯ç¾¤å‘æµç¨‹

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                        æ¶ˆæ¯ç¾¤å‘æµç¨‹                              â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                 â”‚
â”‚  1. ç”¨æˆ·é€‰æ‹©ç›®æ ‡ï¼ˆå¥½å‹/ç¾¤ï¼‰ï¼Œç¼–è¾‘æ¶ˆæ¯å†…å®¹                         â”‚
â”‚         â†“                                                       â”‚
â”‚  2. ç³»ç»Ÿæ ¹æ®ç›®æ ‡æ•°é‡æ‹†åˆ†ä¸ºå¤šä¸ªå­ä»»åŠ¡                             â”‚
â”‚         â†“                                                       â”‚
â”‚  3. å­ä»»åŠ¡æŒ‰é—´éš”æ—¶é—´ä¾æ¬¡æ‰§è¡Œï¼ˆé˜²æ­¢é£æ§ï¼‰                          â”‚
â”‚         â†“                                                       â”‚
â”‚  4. æ¯æ¡æ¶ˆæ¯å‘é€åè®°å½•çŠ¶æ€ï¼ˆæˆåŠŸ/å¤±è´¥ï¼‰                          â”‚
â”‚         â†“                                                       â”‚
â”‚  5. å¤±è´¥ä»»åŠ¡è‡ªåŠ¨é‡è¯•ï¼ˆæœ€å¤š3æ¬¡ï¼‰                                  â”‚
â”‚         â†“                                                       â”‚
â”‚  6. ç”Ÿæˆç¾¤å‘æŠ¥å‘Šï¼ˆå‘é€æ•°ã€æˆåŠŸæ•°ã€å¤±è´¥æ•°ï¼‰                        â”‚
â”‚                                                                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 3. æœ‹å‹åœˆåŒæ­¥æµç¨‹

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                        æœ‹å‹åœˆåŒæ­¥æµç¨‹                            â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                 â”‚
â”‚  1. ç”¨æˆ·ä»å†…å®¹åº“é€‰æ‹©å†…å®¹ï¼Œé€‰æ‹©å‘å¸ƒè´¦å·                           â”‚
â”‚         â†“                                                       â”‚
â”‚  2. ç³»ç»Ÿä¸Šä¼ å›¾ç‰‡/è§†é¢‘åˆ° OSSï¼Œè·å– URL                            â”‚
â”‚         â†“                                                       â”‚
â”‚  3. æ„å»ºæœ‹å‹åœˆå‘å¸ƒæŒ‡ä»¤ï¼ˆå†…å®¹ã€å›¾ç‰‡ã€ä½ç½®ï¼‰                        â”‚
â”‚         â†“                                                       â”‚
â”‚  4. é€šè¿‡ WebSocket ä¸‹å‘åˆ°è®¾å¤‡                                   â”‚
â”‚         â†“                                                       â”‚
â”‚  5. è®¾å¤‡æ‰§è¡Œå‘å¸ƒï¼Œè¿”å›å‘å¸ƒç»“æœ                                   â”‚
â”‚         â†“                                                       â”‚
â”‚  6. é‡‡é›†å‘å¸ƒåçš„æœ‹å‹åœˆæ•°æ®ï¼ˆç‚¹èµã€è¯„è®ºï¼‰                          â”‚
â”‚                                                                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ğŸ›¡ï¸ é£æ§æœºåˆ¶

### 1. é¢‘ç‡æ§åˆ¶

```php
// æ¶ˆæ¯å‘é€é—´éš”æ§åˆ¶
$interval = rand(3, 8); // 3-8ç§’éšæœºé—´éš”
sleep($interval);

// æ¯æ—¥å‘é€ä¸Šé™
$dailyLimit = 200; // æ¯ä¸ªå¾®ä¿¡å·æ¯æ—¥æœ€å¤šå‘é€200æ¡
$sentCount = Cache::get("daily_sent:{$wechatId}");
if ($sentCount >= $dailyLimit) {
    throw new BusinessException('ä»Šæ—¥å‘é€å·²è¾¾ä¸Šé™');
}

// åŒä¸€å¥½å‹é—´éš”
$lastSendTime = Cache::get("last_send:{$wechatId}:{$toWxid}");
if (time() - $lastSendTime < 60) {
    throw new BusinessException('å‘é€è¿‡äºé¢‘ç¹ï¼Œè¯·ç¨åå†è¯•');
}
```

### 2. å¥åº·åˆ†æœºåˆ¶

```
å¥åº·åˆ† = åŸºç¡€åˆ†(100) - æ‰£åˆ†é¡¹ + åŠ åˆ†é¡¹

æ‰£åˆ†é¡¹ï¼š
- æ¶ˆæ¯å‘é€å¤±è´¥ï¼š-2åˆ†/æ¬¡
- è¢«å¥½å‹åˆ é™¤ï¼š-5åˆ†/æ¬¡
- è¢«ä¸¾æŠ¥ï¼š-20åˆ†/æ¬¡
- è´¦å·å¼‚å¸¸ï¼š-50åˆ†/æ¬¡

åŠ åˆ†é¡¹ï¼š
- æ­£å¸¸äº’åŠ¨ï¼š+1åˆ†/å¤©
- å¥½å‹å¢é•¿ï¼š+2åˆ†/10äºº
- æ´»è·ƒåº¦é«˜ï¼š+5åˆ†/å‘¨
```

---

## ğŸ“Š æ•°æ®åŒæ­¥é“¾è·¯

### 1. å¥½å‹æ•°æ®åŒæ­¥

```
è®¾å¤‡ â†’ ä»£ç†æœåŠ¡å™¨ â†’ å­˜å®¢å®åç«¯ â†’ MongoDB
  â†‘                              â†“
  â””â”€â”€â”€â”€â”€â”€â”€â”€ å¢é‡åŒæ­¥ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 2. æ¶ˆæ¯æ•°æ®åŒæ­¥

```
å®æ—¶æ¶ˆæ¯ â†’ WebSocket â†’ æ¶ˆæ¯å¤„ç†å™¨ â†’ MongoDB
                          â†“
                     æ¶ˆæ¯é€šçŸ¥ â†’ å‰ç«¯å®æ—¶æ›´æ–°
```

---

## âš ï¸ æ³¨æ„äº‹é¡¹

1. **WebSocket è¿æ¥ç¨³å®šæ€§**ï¼šéœ€è¦å®ç°å¿ƒè·³æ£€æµ‹å’Œè‡ªåŠ¨é‡è¿æœºåˆ¶
2. **ä»»åŠ¡å¹‚ç­‰æ€§**ï¼šåŒä¸€ä»»åŠ¡ä¸èƒ½é‡å¤æ‰§è¡Œï¼Œéœ€è¦åŠ é”æ§åˆ¶
3. **æ•°æ®ä¸€è‡´æ€§**ï¼šè®¾å¤‡æ•°æ®å’ŒæœåŠ¡ç«¯æ•°æ®éœ€è¦å®šæœŸæ ¡éªŒ
4. **é£æ§åˆè§„**ï¼šä¸¥æ ¼æ§åˆ¶æ“ä½œé¢‘ç‡ï¼Œé¿å…è´¦å·è¢«å°
5. **æ—¥å¿—è¿½è¸ª**ï¼šæ‰€æœ‰æ“ä½œéœ€è¦è®°å½•è¯¦ç»†æ—¥å¿—ï¼Œä¾¿äºé—®é¢˜æ’æŸ¥
