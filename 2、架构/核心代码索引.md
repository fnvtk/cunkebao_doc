# æ ¸å¿ƒä»£ç ç´¢å¼•

> ğŸ“… æœ€åæ›´æ–°ï¼š2026-01-11
> ğŸ“‹ å­˜å®¢å®ç³»ç»Ÿæœ€æœ‰ä»·å€¼çš„ä»£ç æ–‡ä»¶ç´¢å¼•

---

## ğŸ“Š æ ¸å¿ƒä»£ç åˆ†ç±»

### ä¸€ã€æ ¸å¿ƒç®—æ³•ç±»

| æ–‡ä»¶ | è·¯å¾„ | ä»£ç é‡ | æ ¸å¿ƒåŠŸèƒ½ |
|------|------|--------|----------|
| **å¥åº·åˆ†æœåŠ¡** | `Server/application/common/service/WechatAccountHealthScoreService.php` | 756è¡Œ | å¾®ä¿¡è´¦å·å¥åº·è¯„ä¼° |
| **RFMæ§åˆ¶å™¨** | `Server/application/cunkebao/controller/RFMController.php` | 267è¡Œ | å®¢æˆ·ä»·å€¼è¯„åˆ† |
| **åˆ†é”€å¥–åŠ±æœåŠ¡** | `Server/application/cunkebao/service/DistributionRewardService.php` | 210è¡Œ | åˆ†é”€æ”¶ç›Šè®¡ç®— |

### äºŒã€è‡ªåŠ¨åŒ–ä»»åŠ¡ç±»

| æ–‡ä»¶ | è·¯å¾„ | ä»£ç é‡ | æ ¸å¿ƒåŠŸèƒ½ |
|------|------|--------|----------|
| **æ¶ˆæ¯ç¾¤å‘Job** | `Server/application/job/WorkbenchGroupPushJob.php` | 936è¡Œ | æ‰¹é‡æ¶ˆæ¯æ¨é€ |
| **æµé‡åˆ†å‘Job** | `Server/application/job/WorkbenchTrafficDistributeJob.php` | 200+è¡Œ | å®¢æˆ·è‡ªåŠ¨åˆ†é… |
| **è‡ªåŠ¨å»ºç¾¤Job** | `Server/application/job/WorkbenchGroupCreateJob.php` | 267è¡Œ | æ‰¹é‡å»ºç¾¤ |
| **å…¥ç¾¤æ¬¢è¿Job** | `Server/application/job/WorkbenchGroupWelcomeJob.php` | 266è¡Œ | è‡ªåŠ¨æ¬¢è¿è¯­ |
| **è‡ªåŠ¨ç‚¹èµJob** | `Server/application/job/WorkbenchAutoLikeJob.php` | 245è¡Œ | æœ‹å‹åœˆè‡ªåŠ¨ç‚¹èµ |
| **æœ‹å‹åœˆåŒæ­¥Job** | `Server/application/job/WorkbenchMomentsJob.php` | - | æœ‹å‹åœˆå†…å®¹åŒæ­¥ |
| **å¥½å‹åˆ†é…Job** | `Server/application/job/AllotFriendJob.php` | 100+è¡Œ | å¥½å‹è‡ªåŠ¨åˆ†é… |
| **ç¾¤èŠåˆ†é…Job** | `Server/application/job/AllotChatroomJob.php` | 100+è¡Œ | ç¾¤èŠè‡ªåŠ¨åˆ†é… |
| **æ·»åŠ å¥½å‹Job** | `Server/application/job/FriendTaskJob.php` | 102è¡Œ | è‡ªåŠ¨æ·»åŠ å¥½å‹ |

### ä¸‰ã€WebSocketé€šä¿¡ç±»

| æ–‡ä»¶ | è·¯å¾„ | ä»£ç é‡ | æ ¸å¿ƒåŠŸèƒ½ |
|------|------|--------|----------|
| **WebSocketæ§åˆ¶å™¨** | `Server/application/api/controller/WebSocketController.php` | 756è¡Œ | è®¾å¤‡é€šä¿¡æ ¸å¿ƒ |
| **Socketäº‹ä»¶å¤„ç†** | `Server/application/common/socket/Events.php` | 68è¡Œ | WebSocketäº‹ä»¶ |
| **ä»»åŠ¡æœåŠ¡å™¨** | `Server/application/common/TaskServer.php` | 93è¡Œ | Workermanå®šæ—¶ä»»åŠ¡ |

### å››ã€ä»»åŠ¡è°ƒåº¦ç±»

| æ–‡ä»¶ | è·¯å¾„ | ä»£ç é‡ | æ ¸å¿ƒåŠŸèƒ½ |
|------|------|--------|----------|
| **ä»»åŠ¡è°ƒåº¦å™¨** | `Server/application/command/TaskSchedulerCommand.php` | 308è¡Œ | å¤šè¿›ç¨‹ä»»åŠ¡è°ƒåº¦ |
| **å‘½ä»¤æ³¨å†Œ** | `Server/application/command.php` | 50è¡Œ | æ‰€æœ‰å‘½ä»¤åˆ—è¡¨ |

### äº”ã€æ ¸å¿ƒä¸šåŠ¡æ§åˆ¶å™¨

| æ–‡ä»¶ | è·¯å¾„ | ä»£ç é‡ | æ ¸å¿ƒåŠŸèƒ½ |
|------|------|--------|----------|
| **è‡ªåŠ¨åˆ†é…æ§åˆ¶å™¨** | `Server/application/api/controller/AutomaticAssign.php` | 346è¡Œ | å¥½å‹/ç¾¤èŠåˆ†é… |
| **å†…å®¹åº“æ§åˆ¶å™¨** | `Server/application/cunkebao/controller/ContentLibraryController.php` | 1666è¡Œ | å†…å®¹ç®¡ç† |
| **å·¥ä½œå°æ§åˆ¶å™¨** | `Server/application/cunkebao/controller/WorkbenchController.php` | - | å·¥ä½œå°åŠŸèƒ½ |
| **æµé‡åˆ†å‘æ§åˆ¶å™¨** | `Server/application/cunkebao/controller/workbench/WorkbenchTrafficController.php` | 55è¡Œ | æµé‡åˆ†å‘é…ç½® |
| **æ¶ˆæ¯æ§åˆ¶å™¨** | `Server/application/api/controller/MessageController.php` | 402è¡Œ | æ¶ˆæ¯å¤„ç† |
| **æœ‹å‹åœˆæ§åˆ¶å™¨** | `Server/application/api/controller/MomentsController.php` | - | æœ‹å‹åœˆåŠŸèƒ½ |
| **å¥½å‹ä»»åŠ¡æ§åˆ¶å™¨** | `Server/application/api/controller/FriendTaskController.php` | 192è¡Œ | æ·»åŠ å¥½å‹ä»»åŠ¡ |

---

## ğŸ”¥ æœ€æœ‰ä»·å€¼çš„ä»£ç ç‰‡æ®µ

### 1. å¥åº·åˆ†è®¡ç®—æ ¸å¿ƒ

```php
// æ–‡ä»¶: Server/application/common/service/WechatAccountHealthScoreService.php
// è¡Œæ•°: 157-180

// è®¡ç®—åŸºç¡€åˆ†ï¼ˆåªè®¡ç®—ä¸€æ¬¡ï¼Œé™¤éå¼ºåˆ¶é‡æ–°è®¡ç®—ï¼‰
if (!$scoreRecord['baseScoreCalculated'] || $forceRecalculateBase) {
    $baseScoreData = $this->calculateBaseScore($accountData, $scoreRecord);
    $this->updateBaseScore($accountId, $baseScoreData);
    $scoreRecord = $this->getScoreRecord($accountId);
}

// è®¡ç®—åŠ¨æ€åˆ†ï¼ˆæ¯æ¬¡éƒ½è¦é‡æ–°è®¡ç®—ï¼‰
$dynamicScoreData = $this->calculateDynamicScore($accountData, $scoreRecord);

// è®¡ç®—æ€»åˆ†
$baseScore = $scoreRecord['baseScore'];
$dynamicScore = $dynamicScoreData['total'];
$healthScore = $baseScore + $dynamicScore;

// ç¡®ä¿å¥åº·åˆ†åœ¨åˆç†èŒƒå›´å†…ï¼ˆ0-100ï¼‰
$healthScore = max(0, min(100, $healthScore));

// è®¡ç®—æ¯æ—¥æœ€å¤§åŠ äººæ¬¡æ•°
$maxAddFriendPerDay = $this->getMaxAddFriendPerDay($healthScore);
```

### 2. RFMè¯„åˆ†æ ¸å¿ƒ

```php
// æ–‡ä»¶: Server/application/cunkebao/controller/RFMController.php
// è¡Œæ•°: 134-150

// è®¡ç®—RFMæ€»åˆ†ï¼ˆåŠ æƒæ±‚å’Œï¼‰
$rfmScore = $rScore * $weightR + $fScore * $weightF + $mScore * $weightM;

// å¯é€‰ï¼šæ ‡å‡†åŒ–ä¸º1-100åˆ†
$standardScore = null;
if ($scoreScale == 100) {
    $rfmMin = $weightR * 1 + $weightF * 1 + $weightM * 1;
    $rfmMax = $weightR * 5 + $weightF * 5 + $weightM * 5;
    $standardScore = (int)round(($rfmScore - $rfmMin) / ($rfmMax - $rfmMin) * 99 + 1);
}
```

### 3. æµé‡åˆ†å‘è½®è¯¢æ ¸å¿ƒ

```php
// æ–‡ä»¶: Server/application/job/WorkbenchTrafficDistributeJob.php
// è¡Œæ•°: 105-142

$i = 0;
$accountNum = count($accounts);
foreach ($friends as $friend) {
    if ($accountNum == 0) {
        break 2;
    }
    if ($i >= $accountNum) {
        $i = 0;  // è½®è¯¢é‡ç½®
    }
    $account = $accounts[$i];

    // é…é¢æ£€æŸ¥
    if ($account['todayCount'] >= $config['maxPerDay']) {
        unset($accounts[$i]);
        $accounts = array_values($accounts);
        $accountNum = count($accounts);
        continue;
    }

    // æ‰§è¡Œåˆ†é…
    $res = $automaticAssign->allotWechatFriend([
        'wechatFriendId' => $friend['id'],
        'toAccountId' => $account['id']
    ], true);
    
    $i++;
}
```

### 4. WebSocketè¿æ¥æ ¸å¿ƒ

```php
// æ–‡ä»¶: Server/application/api/controller/WebSocketController.php
// è¡Œæ•°: 101-142

protected function connect()
{
    try {
        // SSLé…ç½®
        $context = stream_context_create();
        stream_context_set_option($context, 'ssl', 'verify_peer', false);
        stream_context_set_option($context, 'ssl', 'verify_peer_name', false);

        // ç™»å½•è®¤è¯æ¶ˆæ¯
        $result = [
            "accessToken" => $this->authorized,
            "accountId" => $this->accountId,
            "client" => "kefu-client",
            "cmdType" => "CmdSignIn",
            "seq" => 1,
        ];

        // å»ºç«‹WebSocketè¿æ¥
        $this->client = new Client("wss://s2.siyuguanli.com:9993", [
            'filter' => ['text', 'binary', 'ping', 'pong', 'close'],
            'context' => $context,
            'headers' => [
                'Sec-WebSocket-Protocol' => 'soap',
                'origin' => 'localhost',
            ],
            'timeout' => 86400,
        ]);

        $this->client->send(json_encode($result));
        $this->isConnected = true;
        $this->lastHeartbeatTime = time();
    } catch (\Exception $e) {
        Log::error("WebSocketè¿æ¥å¤±è´¥ï¼š" . $e->getMessage());
        $this->isConnected = false;
    }
}
```

### 5. ä»»åŠ¡è°ƒåº¦å¤šè¿›ç¨‹æ ¸å¿ƒ

```php
// æ–‡ä»¶: Server/application/command/TaskSchedulerCommand.php
// è¡Œæ•°: 254-304

protected function executeConcurrent($tasks, Output $output)
{
    foreach ($tasks as $taskId => $task) {
        // ç­‰å¾…å¯ç”¨è¿›ç¨‹æ§½
        while (count($this->runningProcesses) >= $this->maxConcurrent) {
            $this->waitForProcesses();
            usleep(100000);
        }
        
        // æ£€æŸ¥ä»»åŠ¡é”
        $lockKey = "scheduler_task_lock:{$taskId}";
        if (Cache::get($lockKey)) {
            continue;
        }
        
        // åˆ›å»ºå­è¿›ç¨‹
        $pid = pcntl_fork();
        
        if ($pid == 0) {
            // å­è¿›ç¨‹æ‰§è¡Œä»»åŠ¡
            $this->runTask($taskId, $task);
            exit(0);
        } else {
            // çˆ¶è¿›ç¨‹è®°å½•
            $this->runningProcesses[$pid] = [
                'task_id' => $taskId,
                'start_time' => time(),
            ];
            Cache::set($lockKey, time(), 600);
        }
    }
    
    // ç­‰å¾…æ‰€æœ‰å­è¿›ç¨‹å®Œæˆ
    while (!empty($this->runningProcesses)) {
        $this->waitForProcesses();
    }
}
```

---

## ğŸ“ æ–‡æ¡£ç´¢å¼•

| æ–‡æ¡£ | è·¯å¾„ | è¯´æ˜ |
|------|------|------|
| å¥åº·åˆ†è§„åˆ™ | `Server/å¾®ä¿¡å¥åº·åˆ†è§„åˆ™v2.md` | å¥åº·åˆ†ç®—æ³•è§„åˆ™è¯´æ˜ |
| RFMæ–‡æ¡£ | `Server/RFMå®¢æˆ·ä»·å€¼è¯„åˆ†ä½“ç³»æŠ€æœ¯å®æ–½æ–‡æ¡£.md` | RFMç®—æ³•è¯¦ç»†æ–‡æ¡£ |
| å®šæ—¶ä»»åŠ¡æ–‡æ¡£ | `Server/crontab_tasks.md` | å®šæ—¶ä»»åŠ¡é…ç½® |
| è°ƒåº¦å™¨æ–‡æ¡£ | `Server/README_scheduler.md` | ä»»åŠ¡è°ƒåº¦å™¨è¯´æ˜ |
| æœ‹å‹åœˆæ–‡æ¡£ | `Server/README_moments.md` | æœ‹å‹åœˆåŠŸèƒ½è¯´æ˜ |
| ç¾¤èŠåŒæ­¥æ–‡æ¡£ | `Server/README_wechat_chatroom_sync.md` | ç¾¤èŠåŒæ­¥è¯´æ˜ |

---

## ğŸ—‚ï¸ ä»£ç ç»“æ„æ¦‚è§ˆ

```
Server/application/
â”œâ”€â”€ api/controller/              # APIæ§åˆ¶å™¨
â”‚   â”œâ”€â”€ WebSocketController.php  # â­ WebSocketæ ¸å¿ƒ
â”‚   â”œâ”€â”€ AutomaticAssign.php      # â­ è‡ªåŠ¨åˆ†é…
â”‚   â”œâ”€â”€ MessageController.php    # æ¶ˆæ¯å¤„ç†
â”‚   â”œâ”€â”€ MomentsController.php    # æœ‹å‹åœˆ
â”‚   â””â”€â”€ FriendTaskController.php # å¥½å‹ä»»åŠ¡
â”‚
â”œâ”€â”€ common/                      # å…¬å…±æ¨¡å—
â”‚   â”œâ”€â”€ service/
â”‚   â”‚   â””â”€â”€ WechatAccountHealthScoreService.php  # â­ å¥åº·åˆ†æ ¸å¿ƒ
â”‚   â”œâ”€â”€ socket/
â”‚   â”‚   â””â”€â”€ Events.php           # WebSocketäº‹ä»¶
â”‚   â””â”€â”€ TaskServer.php           # â­ å®šæ—¶ä»»åŠ¡æœåŠ¡
â”‚
â”œâ”€â”€ cunkebao/                    # ä¸»ä¸šåŠ¡æ¨¡å—
â”‚   â”œâ”€â”€ controller/
â”‚   â”‚   â”œâ”€â”€ RFMController.php    # â­ RFMç®—æ³•
â”‚   â”‚   â”œâ”€â”€ ContentLibraryController.php  # å†…å®¹åº“
â”‚   â”‚   â””â”€â”€ workbench/           # å·¥ä½œå°
â”‚   â””â”€â”€ service/
â”‚       â””â”€â”€ DistributionRewardService.php  # â­ åˆ†é”€å¥–åŠ±
â”‚
â”œâ”€â”€ job/                         # åå°ä»»åŠ¡
â”‚   â”œâ”€â”€ WorkbenchGroupPushJob.php      # â­ æ¶ˆæ¯ç¾¤å‘
â”‚   â”œâ”€â”€ WorkbenchTrafficDistributeJob.php  # â­ æµé‡åˆ†å‘
â”‚   â”œâ”€â”€ WorkbenchGroupCreateJob.php    # è‡ªåŠ¨å»ºç¾¤
â”‚   â”œâ”€â”€ WorkbenchGroupWelcomeJob.php   # å…¥ç¾¤æ¬¢è¿
â”‚   â”œâ”€â”€ WorkbenchAutoLikeJob.php       # è‡ªåŠ¨ç‚¹èµ
â”‚   â”œâ”€â”€ AllotFriendJob.php             # å¥½å‹åˆ†é…
â”‚   â””â”€â”€ FriendTaskJob.php              # æ·»åŠ å¥½å‹
â”‚
â””â”€â”€ command/                     # å‘½ä»¤è¡Œ
    â”œâ”€â”€ TaskSchedulerCommand.php # â­ ä»»åŠ¡è°ƒåº¦å™¨
    â””â”€â”€ command.php              # å‘½ä»¤æ³¨å†Œ
```

**â­ æ ‡è®°ä¸ºæ ¸å¿ƒä»£ç æ–‡ä»¶**

---

## ğŸ’¡ å¼€å‘å»ºè®®

1. **ä¿®æ”¹å¥åº·åˆ†ç®—æ³•å‰**ï¼šå…ˆé˜…è¯» `å¾®ä¿¡å¥åº·åˆ†è§„åˆ™v2.md`
2. **ä¿®æ”¹RFMç®—æ³•å‰**ï¼šå…ˆé˜…è¯» `RFMå®¢æˆ·ä»·å€¼è¯„åˆ†ä½“ç³»æŠ€æœ¯å®æ–½æ–‡æ¡£.md`
3. **æ·»åŠ æ–°ä»»åŠ¡**ï¼šå‚è€ƒç°æœ‰Jobæ–‡ä»¶ç»“æ„
4. **WebSocketè°ƒè¯•**ï¼šä½¿ç”¨æ—¥å¿—è¿½è¸ªæ¶ˆæ¯æµç¨‹
5. **æ€§èƒ½ä¼˜åŒ–**ï¼šå…³æ³¨æ•°æ®åº“æŸ¥è¯¢å’Œç¼“å­˜ä½¿ç”¨
