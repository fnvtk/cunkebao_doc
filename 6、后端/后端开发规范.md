# 后端开发规范

> 📅 最后更新：2026-01-11
> 📋 基于项目源码逆向分析生成

---

## 🛠️ 技术栈

### Server (主后端)

| 技术 | 版本 | 说明 |
|------|------|------|
| PHP | ≥7.4 | 开发语言 |
| ThinkPHP | 5.1.41 | 核心框架 |
| MySQL | 5.7+ | 关系型数据库 |
| MongoDB | 4.4+ | 文档数据库 |
| Redis | 6.0+ | 缓存/队列 |
| Workerman | 3.5 | 长连接服务 |

### Moncter (监控服务)

| 技术 | 版本 | 说明 |
|------|------|------|
| PHP | ≥8.1 | 开发语言 |
| Webman | 2.1 | 高性能框架 |
| MongoDB | 4.4+ | 主数据库 |
| Redis | 6.0+ | 缓存/队列 |

---

## 📁 目录结构

### Server 目录

```
Server/
├── application/
│   ├── api/                # API 模块
│   │   ├── controller/     # 控制器
│   │   ├── model/          # 模型
│   │   ├── service/        # 服务层
│   │   ├── validate/       # 验证器
│   │   └── config/         # 模块配置
│   ├── common/             # 公共模块
│   │   ├── model/          # 公共模型
│   │   ├── service/        # 公共服务
│   │   ├── util/           # 工具类
│   │   ├── middleware/     # 中间件
│   │   └── socket/         # WebSocket
│   ├── cunkebao/           # 主业务模块
│   ├── store/              # 门店模块
│   ├── superadmin/         # 超管模块
│   ├── command/            # 命令行
│   └── job/                # 后台任务
├── config/                 # 全局配置
│   ├── app.php
│   ├── database.php
│   ├── queue.php
│   └── worker.php
├── extend/                 # 扩展类库
├── public/                 # Web 入口
│   └── index.php
├── route/                  # 路由配置
│   └── route.php
├── runtime/                # 运行时目录
└── thinkphp/               # 框架核心
```

### Moncter 目录

```
Moncter/
├── app/
│   ├── controller/         # 控制器
│   ├── model/              # 模型
│   ├── service/            # 服务层
│   └── middleware/         # 中间件
├── config/                 # 配置文件
├── process/                # 进程配置
├── public/                 # 静态资源
└── support/                # 支持文件
```

---

## 📝 代码规范

### 命名规范

```php
// 类名：UpperCamelCase
class DeviceController extends Controller {}
class WechatService {}

// 方法名：lowerCamelCase
public function getDeviceList() {}
public function createWechat() {}

// 变量名：lowerCamelCase
$deviceInfo = [];
$wechatList = [];

// 常量：UPPER_CASE
const MAX_RETRY_COUNT = 3;
const STATUS_ACTIVE = 1;

// 配置参数：小写下划线
'app_debug' => true,
'database_host' => 'localhost',
```

### 注释规范

```php
/**
 * 获取设备列表
 * 
 * 根据条件查询设备列表，支持分页和筛选
 * 
 * @param array $params 查询参数
 *   - page: int 页码
 *   - limit: int 每页数量
 *   - status: int 状态筛选
 * @return array 设备列表数据
 * @throws BusinessException 业务异常
 */
public function getDeviceList(array $params): array
{
    // 验证参数
    $this->validate($params, DeviceValidate::class);
    
    // 查询数据
    $list = $this->deviceModel
        ->where('status', $params['status'] ?? 1)
        ->paginate($params['limit'] ?? 20);
    
    return $list->toArray();
}
```

---

## 🏗️ 分层架构

### MVC + Service 模式

```
Controller (控制器层)
    ↓
Service (服务层/业务逻辑)
    ↓
Model (模型层/数据访问)
    ↓
Database (数据库)
```

### 控制器层

```php
// application/api/controller/DeviceController.php

namespace app\api\controller;

use app\common\service\DeviceService;
use think\Controller;

class DeviceController extends Controller
{
    protected $deviceService;
    
    public function __construct(DeviceService $deviceService)
    {
        $this->deviceService = $deviceService;
    }
    
    /**
     * 获取设备列表
     */
    public function index()
    {
        $params = $this->request->param();
        $result = $this->deviceService->getList($params);
        return json(['code' => 200, 'data' => $result]);
    }
    
    /**
     * 获取设备详情
     */
    public function read($id)
    {
        $result = $this->deviceService->getDetail($id);
        return json(['code' => 200, 'data' => $result]);
    }
}
```

### 服务层

```php
// application/common/service/DeviceService.php

namespace app\common\service;

use app\common\model\Device;
use app\common\exception\BusinessException;

class DeviceService
{
    protected $deviceModel;
    
    public function __construct(Device $device)
    {
        $this->deviceModel = $device;
    }
    
    /**
     * 获取设备列表
     */
    public function getList(array $params): array
    {
        $query = $this->deviceModel->where('status', 1);
        
        // 关键词搜索
        if (!empty($params['keyword'])) {
            $query->whereLike('name', "%{$params['keyword']}%");
        }
        
        // 分页查询
        $list = $query->order('id', 'desc')
            ->paginate($params['limit'] ?? 20);
            
        return $list->toArray();
    }
    
    /**
     * 获取设备详情
     */
    public function getDetail(int $id): array
    {
        $device = $this->deviceModel->find($id);
        
        if (!$device) {
            throw new BusinessException('设备不存在', 30001);
        }
        
        return $device->toArray();
    }
}
```

### 模型层

```php
// application/common/model/Device.php

namespace app\common\model;

use think\Model;

class Device extends Model
{
    protected $table = 'devices';
    
    // 自动时间戳
    protected $autoWriteTimestamp = true;
    protected $createTime = 'created_at';
    protected $updateTime = 'updated_at';
    
    // 关联微信账号
    public function wechats()
    {
        return $this->hasMany(Wechat::class, 'device_id', 'id');
    }
    
    // 获取器：在线状态文字
    public function getOnlineStatusTextAttr($value, $data)
    {
        $status = [0 => '离线', 1 => '在线'];
        return $status[$data['online_status']] ?? '未知';
    }
}
```

---

## 🔐 安全规范

### 参数验证

```php
// application/api/validate/DeviceValidate.php

namespace app\api\validate;

use think\Validate;

class DeviceValidate extends Validate
{
    protected $rule = [
        'name'      => 'require|max:100',
        'device_id' => 'require|alphaDash|max:100',
        'status'    => 'in:0,1',
    ];
    
    protected $message = [
        'name.require'      => '设备名称不能为空',
        'name.max'          => '设备名称最多100个字符',
        'device_id.require' => '设备ID不能为空',
    ];
    
    protected $scene = [
        'create' => ['name', 'device_id'],
        'update' => ['name'],
    ];
}
```

### SQL 注入防护

```php
// ✅ 正确：使用参数绑定
$user = Db::table('users')
    ->where('username', $username)
    ->where('password', $password)
    ->find();

// ❌ 错误：字符串拼接
$user = Db::query("SELECT * FROM users WHERE username = '$username'");
```

### 命令执行安全

```php
// 黑名单命令
$blacklist = ['rm', 'shutdown', 'reboot', 'mkfs', 'dd', 'chmod'];

// 检查命令是否安全
public function isCommandSafe(string $command): bool
{
    $blacklist = ['rm', 'shutdown', 'reboot', 'mkfs', 'dd'];
    
    foreach ($blacklist as $dangerous) {
        if (stripos($command, $dangerous) !== false) {
            return false;
        }
    }
    
    return true;
}
```

---

## 🚨 异常处理

### 全局异常处理

```php
// application/common/exception/ExceptionHandler.php

namespace app\common\exception;

use think\exception\Handle;
use think\exception\HttpException;
use think\exception\ValidateException;

class ExceptionHandler extends Handle
{
    public function render(\Exception $e)
    {
        // 业务异常
        if ($e instanceof BusinessException) {
            return json([
                'code' => $e->getCode(),
                'message' => $e->getMessage(),
            ]);
        }
        
        // 验证异常
        if ($e instanceof ValidateException) {
            return json([
                'code' => 400,
                'message' => $e->getMessage(),
            ]);
        }
        
        // 其他异常
        return json([
            'code' => 500,
            'message' => '服务器错误',
        ]);
    }
}
```

### 自定义业务异常

```php
// application/common/exception/BusinessException.php

namespace app\common\exception;

class BusinessException extends \Exception
{
    public function __construct(string $message, int $code = 50000)
    {
        parent::__construct($message, $code);
    }
}

// 使用
throw new BusinessException('设备不存在', 30001);
throw new BusinessException('微信账号未登录', 40002);
```

---

## 📝 日志规范

### 日志配置

```php
// config/log.php
return [
    'type'  => 'file',
    'path'  => LOG_PATH,
    'level' => ['error', 'warning', 'info'],
];
```

### 日志使用

```php
use think\facade\Log;

// 记录信息
Log::info('设备上线', ['device_id' => $deviceId]);

// 记录警告
Log::warning('API 调用频繁', ['ip' => $ip, 'count' => $count]);

// 记录错误（包含堆栈）
try {
    // ...
} catch (\Exception $e) {
    Log::error('任务执行失败', [
        'message' => $e->getMessage(),
        'trace' => $e->getTraceAsString(),
    ]);
}

// ❌ 禁止使用
echo "debug info";
var_dump($data);
print_r($result);
```

---

## 🔄 队列任务

### 任务定义

```php
// application/job/SendMessageJob.php

namespace app\job;

use think\queue\Job;

class SendMessageJob
{
    /**
     * 执行任务
     */
    public function fire(Job $job, $data)
    {
        try {
            // 执行业务逻辑
            $this->sendMessage($data);
            
            // 任务完成，删除任务
            $job->delete();
            
        } catch (\Exception $e) {
            // 重试次数判断
            if ($job->attempts() > 3) {
                Log::error('消息发送失败，已达最大重试次数', $data);
                $job->delete();
            } else {
                // 延迟重试
                $job->release(60);
            }
        }
    }
    
    protected function sendMessage($data)
    {
        // 发送消息逻辑
    }
}
```

### 任务调度

```php
use think\facade\Queue;

// 推送任务到队列
Queue::push(SendMessageJob::class, [
    'wechat_id' => 1,
    'to_wxid' => 'wxid_xxx',
    'content' => '消息内容',
], 'send_message');

// 延迟任务
Queue::later(60, SendMessageJob::class, $data, 'send_message');
```

---

## 🚀 开发流程

1. **理解需求**：阅读 `开发文档/1、需求/业务需求.md`
2. **设计数据库**：设计表结构，更新数据库文档
3. **创建模型**：在 `model` 目录下创建数据模型
4. **编写服务**：在 `service` 目录下实现业务逻辑
5. **创建控制器**：在 `controller` 目录下创建控制器
6. **定义路由**：在模块 `config/route.php` 中定义路由
7. **编写验证器**：在 `validate` 目录下创建验证器
8. **测试接口**：使用 Postman 或类似工具测试

---

## ⚠️ 注意事项

1. **中文注释**：所有类、方法、复杂逻辑必须有中文注释
2. **参数验证**：所有接口必须进行参数验证
3. **异常处理**：不要吞掉异常，必须记录日志
4. **SQL优化**：避免 N+1 查询，使用预加载
5. **事务处理**：涉及多表操作必须使用事务
6. **依赖检查**：安装新依赖前检查是否已存在
