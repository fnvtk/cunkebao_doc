# 技术需求文档

> 📅 最后更新：2026-01-11
> 📋 版本：v3.0.0
> 🏢 项目：存客宝私域运营管理系统

---

## 一、技术架构概述

### 1.1 整体架构

```
┌─────────────────────────────────────────────────────────────────────┐
│                           客户端层                                   │
├─────────────┬─────────────┬─────────────┬─────────────┬─────────────┤
│  Cunkebao   │ Touchkebao  │ SuperAdmin  │  Store_vue  │  aiApp/ckApp│
│  (React)    │  (React)    │  (Next.js)  │  (UniApp)   │  (UniApp)   │
│  主前端      │  触控版      │  管理后台    │  门店端      │  移动应用    │
└──────┬──────┴──────┬──────┴──────┬──────┴──────┬──────┴──────┬──────┘
       │             │             │             │             │
       └─────────────┴─────────────┴─────────────┴─────────────┘
                                   │
                                   ▼
┌─────────────────────────────────────────────────────────────────────┐
│                           API 网关层                                 │
│                        (Nginx 反向代理)                              │
└─────────────────────────────────┬───────────────────────────────────┘
                                  │
       ┌──────────────────────────┼──────────────────────────┐
       │                          │                          │
       ▼                          ▼                          ▼
┌─────────────────┐    ┌─────────────────┐    ┌─────────────────┐
│     Server      │    │     Moncter     │    │   WebSocket     │
│   (ThinkPHP)    │    │    (Webman)     │    │  (GatewayWorker)│
│   主业务服务     │    │   监控/数据服务  │    │   实时通信服务   │
└────────┬────────┘    └────────┬────────┘    └────────┬────────┘
         │                      │                      │
         └──────────────────────┼──────────────────────┘
                                │
       ┌────────────────────────┼────────────────────────┐
       │                        │                        │
       ▼                        ▼                        ▼
┌─────────────────┐    ┌─────────────────┐    ┌─────────────────┐
│     MongoDB     │    │      MySQL      │    │      Redis      │
│    主数据存储    │    │   关系型数据     │    │   缓存/队列      │
└─────────────────┘    └─────────────────┘    └─────────────────┘
```

### 1.2 技术栈总览

| 层级 | 技术选型 | 说明 |
|------|----------|------|
| **前端** | React 18 + TypeScript | 主前端框架 |
| **前端** | Next.js 14 | 管理后台 SSR |
| **前端** | Vue 3 + UniApp | 跨端移动应用 |
| **后端** | PHP 7.4 + ThinkPHP 5.1 | 主业务服务 |
| **后端** | PHP 8.1 + Webman | 监控数据服务 |
| **实时通信** | Workerman + GatewayWorker | WebSocket 服务 |
| **数据库** | MongoDB | 主数据存储 |
| **数据库** | MySQL 5.7+ | 关系型数据 |
| **缓存** | Redis | 缓存、会话、队列 |
| **消息队列** | Redis Queue / RabbitMQ | 异步任务 |

---

## 二、前端技术需求

### 2.1 技术栈要求

| 项目 | 技术栈 | 说明 |
|------|--------|------|
| **Cunkebao** | React 18 + TypeScript + Vite | 主前端 |
| **Touchkebao** | React 18 + TypeScript + Vite | 客服端 |
| **SuperAdmin** | Next.js 14 + TypeScript | 管理后台 |
| **Store_vue** | Vue 3 + UniApp | 门店应用 |
| **aiApp/ckApp** | Vue 3 + UniApp | 移动应用 |

### 2.2 UI 组件库

| 场景 | 组件库 | 说明 |
|------|--------|------|
| PC 端 | Ant Design 5.x | 管理后台 |
| 移动端 | Ant Design Mobile 5.x | H5 应用 |
| 移动端 | Vant UI 4.x | iOS 风格 |
| 管理后台 | Shadcn UI | 现代风格 |
| 原子 CSS | Tailwind CSS 3.x | 样式工具 |

### 2.3 开发规范

#### 代码规范

```typescript
// ✅ 推荐：使用 TypeScript 强类型
interface User {
  id: number;
  name: string;
  avatar?: string;
}

// ❌ 避免：使用 any 类型
const user: any = { ... };
```

#### 组件规范

```tsx
// ✅ 推荐：函数式组件 + Hooks
const UserCard: React.FC<UserCardProps> = ({ user }) => {
  const [loading, setLoading] = useState(false);
  
  return (
    <div className="user-card">
      {/* 组件内容 */}
    </div>
  );
};

// ✅ 必须：加载状态使用骨架屏
{loading ? <Skeleton /> : <Content />}
```

#### 样式规范

```scss
// ✅ 推荐：使用 SCSS 模块化
.user-card {
  &__header { ... }
  &__body { ... }
  &--active { ... }
}

// ✅ 推荐：使用 Tailwind 原子类
<div className="flex items-center gap-4 p-4 rounded-lg shadow-md">
```

### 2.4 交互规范

| 场景 | 要求 |
|------|------|
| **加载状态** | 必须显示骨架屏 (Skeleton)，禁止白屏 |
| **转场动画** | 页面切换需滑动/淡入淡出动画 |
| **操作反馈** | 成功/失败必须 Toast 提示 |
| **表单验证** | 实时验证 + 提交验证 |
| **列表加载** | 支持下拉刷新 + 上拉加载 |
| **空状态** | 必须有空状态占位图 |

### 2.5 移动端适配

```javascript
// 使用 postcss-pxtorem 自动转换
// 设计稿基准：375px
{
  rootValue: 37.5,
  propList: ['*'],
  selectorBlackList: ['.norem']
}
```

---

## 三、后端技术需求

### 3.1 技术栈要求

| 服务 | 语言 | 框架 | PHP 版本 |
|------|------|------|----------|
| **Server** | PHP | ThinkPHP 5.1 | ≥ 7.4 |
| **Moncter** | PHP | Webman 2.x | ≥ 8.1 |

### 3.2 API 规范

#### RESTful 设计

```
GET    /v1/devices          # 获取设备列表
GET    /v1/devices/{id}     # 获取设备详情
POST   /v1/devices          # 创建设备
PUT    /v1/devices/{id}     # 更新设备
DELETE /v1/devices/{id}     # 删除设备
```

#### 响应格式

```json
{
  "code": 200,
  "message": "success",
  "data": {
    "list": [],
    "total": 100,
    "page": 1,
    "pageSize": 20
  },
  "time": 1704931200
}
```

#### 错误码规范

| 错误码 | 说明 |
|--------|------|
| 200 | 成功 |
| 400 | 参数错误 |
| 401 | 未授权 |
| 403 | 禁止访问 |
| 404 | 资源不存在 |
| 500 | 服务器错误 |

### 3.3 代码规范

```php
<?php
// ✅ 推荐：使用命名空间
namespace app\api\controller;

// ✅ 推荐：类型声明
public function getUser(int $id): array
{
    // ...
}

// ✅ 必须：异常处理
try {
    // 业务逻辑
} catch (\Exception $e) {
    Log::error('操作失败：' . $e->getMessage());
    return errorJson('操作失败');
}

// ✅ 必须：中文注释
/**
 * 获取用户信息
 * @param int $id 用户ID
 * @return array
 */
```

### 3.4 安全规范

| 场景 | 要求 |
|------|------|
| **SQL 注入** | 使用参数绑定，禁止拼接 SQL |
| **XSS 攻击** | 输出转义，过滤用户输入 |
| **CSRF 攻击** | 使用 Token 验证 |
| **敏感数据** | 密码加密存储 (bcrypt) |
| **API 认证** | JWT Token + 刷新机制 |
| **日志记录** | 关键操作必须记录日志 |

---

## 四、数据库需求

### 4.1 数据库选型

| 数据库 | 用途 | 说明 |
|--------|------|------|
| **MongoDB** | 主数据库 | 存储业务数据、消息记录 |
| **MySQL** | 辅助数据库 | 存储关系型数据、用户信息 |
| **Redis** | 缓存 | 会话管理、数据缓存、队列 |

### 4.2 MongoDB 集合设计

| 集合名 | 说明 | 索引 |
|--------|------|------|
| `wechat_friends` | 微信好友 | wechatId, wxid |
| `wechat_messages` | 聊天消息 | wechatId, createTime |
| `wechat_moments` | 朋友圈 | wechatId, snsId |
| `content_library` | 内容库 | companyId, categoryId |
| `task_logs` | 任务日志 | taskId, createTime |

### 4.3 MySQL 表设计

| 表名 | 说明 | 索引 |
|------|------|------|
| `users` | 系统用户 | id, username |
| `devices` | 设备信息 | id, deviceId |
| `wechats` | 微信账号 | id, wechatId |
| `companies` | 企业信息 | id |
| `traffic_pools` | 流量池 | id, companyId |
| `distribution_channels` | 分销渠道 | id, companyId |

### 4.4 数据库规范

```sql
-- ✅ 推荐：表名使用小写下划线
CREATE TABLE `wechat_friends` (
  `id` BIGINT UNSIGNED AUTO_INCREMENT PRIMARY KEY,
  `wechat_id` VARCHAR(64) NOT NULL COMMENT '微信ID',
  `wxid` VARCHAR(64) NOT NULL COMMENT '好友wxid',
  `nickname` VARCHAR(128) DEFAULT '' COMMENT '昵称',
  `created_at` INT UNSIGNED NOT NULL COMMENT '创建时间',
  `updated_at` INT UNSIGNED NOT NULL COMMENT '更新时间',
  INDEX `idx_wechat_id` (`wechat_id`),
  INDEX `idx_wxid` (`wxid`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='微信好友表';
```

---

## 五、WebSocket 通信需求

### 5.1 连接配置

| 配置项 | 值 | 说明 |
|--------|------|------|
| **服务地址** | wss://s2.siyuguanli.com:9993 | 设备代理服务器 |
| **协议** | Sec-WebSocket-Protocol: soap | 子协议 |
| **心跳间隔** | 30秒 | 保活心跳 |
| **超时时间** | 86400秒 | 连接超时 |

### 5.2 消息格式

```json
// 登录认证
{
  "cmdType": "CmdSignIn",
  "accessToken": "xxx",
  "accountId": "xxx",
  "client": "kefu-client",
  "seq": 1
}

// 心跳保活
{
  "cmdType": "CmdHeartbeat",
  "seq": 1704931200
}

// 发送消息
{
  "cmdType": "CmdSendMsg",
  "wechatAccountId": "xxx",
  "toWxid": "xxx",
  "msgType": 1,
  "content": "消息内容"
}
```

### 5.3 命令类型

| 命令 | 说明 |
|------|------|
| `CmdSignIn` | 登录认证 |
| `CmdHeartbeat` | 心跳保活 |
| `CmdFetchMoment` | 获取朋友圈 |
| `CmdSendMsg` | 发送消息 |
| `CmdCreateChatroom` | 创建群聊 |
| `CmdAddFriend` | 添加好友 |
| `CmdFetchFriends` | 获取好友列表 |

---

## 六、任务调度需求

### 6.1 定时任务列表

| 任务 | 命令 | 周期 | 说明 |
|------|------|------|------|
| 自动点赞 | `workbench:autoLike` | 5分钟 | 自动点赞好友朋友圈 |
| 朋友圈同步 | `workbench:moments` | 10分钟 | 同步发布朋友圈 |
| 群消息推送 | `workbench:groupPush` | 1分钟 | 群发消息任务 |
| 自动建群 | `workbench:groupCreate` | 1分钟 | 自动创建群聊 |
| 入群欢迎语 | `workbench:groupWelcome` | 1分钟 | 新成员欢迎 |
| 流量分发 | `workbench:trafficDistribute` | 5分钟 | 流量自动分配 |
| 健康分计算 | `wechat:calculate-score` | 每天凌晨 | 计算账号健康分 |
| 数据同步 | `sync:wechatData` | 10分钟 | 同步微信数据 |

### 6.2 任务调度架构

```
TaskScheduler (主进程)
├── Worker 1: 自动问候任务 (60秒)
├── Worker 2: 获客新任务处理 (1秒)
├── Worker 3: 获客任务状态更新 (60秒)
└── Worker 4: 获客任务新用户处理 (60秒)
```

---

## 七、部署需求

### 7.1 服务器配置

| 环境 | 配置 | 说明 |
|------|------|------|
| **生产环境** | 4核8G | 主服务器 |
| **测试环境** | 2核4G | 测试服务器 |
| **数据库** | 4核8G | MongoDB + MySQL |
| **Redis** | 2核4G | 缓存服务器 |

### 7.2 端口规划

| 服务 | 端口 | 说明 |
|------|------|------|
| Nginx | 80/443 | Web 入口 |
| PHP-FPM | 9000 | PHP 服务 |
| Webman | 8787 | Moncter 服务 |
| WebSocket | 7272 | 实时通信 |
| MySQL | 3306 | 数据库 |
| MongoDB | 27017 | 数据库 |
| Redis | 6379 | 缓存 |

### 7.3 CI/CD 流程

```
代码提交 → GitHub → Webhook → 宝塔面板 → 自动部署
```

---

## 八、监控需求

### 8.1 日志管理

| 日志类型 | 存储位置 | 保留时间 |
|----------|----------|----------|
| 应用日志 | `runtime/log/` | 30天 |
| 错误日志 | `runtime/log/error/` | 90天 |
| 访问日志 | Nginx | 7天 |
| 任务日志 | MongoDB | 30天 |

### 8.2 监控指标

| 指标 | 说明 | 告警阈值 |
|------|------|----------|
| QPS | 每秒请求数 | > 1000 |
| 响应时间 | P95 响应时间 | > 1s |
| 错误率 | 5xx 错误占比 | > 1% |
| 队列长度 | 待处理任务数 | > 1000 |
| CPU 使用率 | 服务器 CPU | > 80% |
| 内存使用率 | 服务器内存 | > 80% |

---

## 九、开发协作规范

### 9.1 文档管理

```
开发文档/
├── 1、需求/           # 需求文档
├── 2、架构/           # 架构设计
├── 3、原型/           # 原型设计
├── 4、前端/           # 前端规范
├── 5、接口/           # API 文档
├── 6、后端/           # 后端规范
├── 7、数据库/         # 数据库设计
├── 8、部署/           # 部署文档
├── 9、手册/           # 开发手册
└── 10、使用手册/      # 用户手册
```

### 9.2 Git 规范

```bash
# 分支命名
main        # 主分支
develop     # 开发分支
feature/*   # 功能分支
bugfix/*    # 修复分支
release/*   # 发布分支

# 提交信息
feat: 新功能
fix: 修复bug
docs: 文档更新
style: 代码格式
refactor: 重构
test: 测试
chore: 构建/工具
```

### 9.3 代码审查

| 检查项 | 要求 |
|--------|------|
| 代码规范 | 符合 ESLint/PHP-CS 规范 |
| 类型安全 | TypeScript 无 any |
| 注释完整 | 关键代码有中文注释 |
| 测试覆盖 | 核心功能有单元测试 |
| 安全检查 | 无 SQL 注入、XSS 风险 |
